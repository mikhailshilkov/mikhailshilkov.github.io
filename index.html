<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>

    <meta name="description" content="Software development using .NET, C#, SQL, Javascript and related technologies" />

    <title>Mikhail Shilkov</title>
    <meta name="author" content="Mikhail Shilkov">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/feed/" rel="alternate" title="mikhail.io" type="application/atom+xml">
    <link href="/favicon.ico?v=2" rel="shortcut icon">

    <!-- Bootstrap -->
    <link href="/styles/site.css" rel="stylesheet" media="screen">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/scripts/vendor/html5shiv.js"></script>
    <script src="/scripts/vendor/respond.min.js"></script>
    <![endif]-->

    <meta name="generator" content="DocPad v6.78.4" />
    
</head>
<body>

<div class="navbar navbar-default navbar-static-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">
                <span class="text-primary">Mikhail Shilkov</span><br />
                <span class="elevator-pitch">.NET, SQL and Javascript programmer</span>
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
            <ul class="nav navbar-nav">
                <!--<li><a href="/">Blog</a></li>-->
                
                <li><a href="/">Blog</a></li>
                <li><a href="/about">About</a></li>
                <li class="hidden-xs">
                    <a href="/feed/" class="rss"><span class="icon icon-feed"></span></a>
                    <a href="https://www.linkedin.com/in/mikhailshilkov" class="linkedin"><span class="icon icon-linkedin"></span></a>
                    <a href="http://twitter.com/mikhailshilkov" class="twitter"><span class="icon icon-twitter"></span></a>
                    <a href="https://github.com/mikhailshilkov" class="github"><span class="icon icon-github"></span></a>
                </li>
            </ul>
            <form class="navbar-form navbar-right hidden-xs" role="search" action="http://google.com/search"
                  method="get">
                <div class="form-group">
                    <input type="search" name="q" class="form-control" placeholder="Search">
                    <input type="hidden" name="q" value="site:mikhail.io">
                </div>
            </form>
        </div>
    </div>
</div>
<div class="container">
    
    <article class="post">
    <div class="post-date">Mar 11th, 2016</div>
    
    <h1><a href='/2016/03/aurelia-map-component-with-leaflet'>Aurelia Map Component with Leaflet</a></h1>
    
    <div class="post-content">
        <p>This is a short tutorial on how to create a map control in <a href="http://aurelia.io">Aurelia.js</a> 
application. I am using the <a href="http://leafletjs.com">Leaflet</a> library with custom tile
source and I also show the way to implement your own overlay layer. Here is what
my map looks like:</p>
<p><img src="/2016/03/aurelia-map-component-with-leaflet/map.png" alt="Map"></p>
<p>So, I assume you already have an existing aurelia application, and let&#39;s start.</p>
<h2 id="install-leaflet">Install Leaflet</h2>
<p>The following command will install Leaflet module to the application:</p>
<pre class="highlight"><code class="hljs cmake">jspm <span class="hljs-keyword">install</span> leaflet
</code></pre><p>If you are using TypeScript, don&#39;t forget to add type definitions</p>
<pre class="highlight"><code class="hljs cmake">tsd <span class="hljs-keyword">install</span> leaflet
</code></pre><h2 id="define-a-map-component">Define a Map Component</h2>
<p>Create a new <code>map.html</code> file and put the following contents there:</p>
<pre class="highlight"><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">require</span> <span class="hljs-attribute">from</span>=<span class="hljs-value">"leaflet/dist/leaflet.css"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">require</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"mapid"</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">"height: 100%"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">template</span>&gt;</span>
</code></pre>
<p>We import the CSS required by leaflet and define the <code>div</code> element to host
the map in. Then, create a new <code>map.js</code> file (or <code>map.ts</code> for typescript),
here is the minimum code:</p>
<pre class="highlight"><code class="hljs javascript">export <span class="hljs-keyword">class</span> Map {
}
</code></pre>
<h2 id="load-the-map-with-tiles">Load the Map with Tiles</h2>
<p>First, import the leaflet module in your codebehind:</p>
<pre class="highlight"><code class="hljs javascript">import * as L from <span class="hljs-string">'leaflet'</span>;
</code></pre>
<p>Now, define the <code>attached</code> function, which would be called by Aurelia when
control&#39;s HTML is loaded, and make a map there:</p>
<pre class="highlight"><code class="hljs javascript">export <span class="hljs-keyword">class</span> Map {
  attached() {
    <span class="hljs-keyword">let</span> map = L.map(<span class="hljs-string">'mapid'</span>).setView([<span class="hljs-number">51.505</span>, -<span class="hljs-number">0.09</span>], <span class="hljs-number">13</span>);

    <span class="hljs-keyword">let</span> urlTemplate = <span class="hljs-string">'http://{s}.tile.osm.org/{z}/{x}/{y}.png'</span>;
    map.addLayer(L.tileLayer(urlTemplate, { minZoom: <span class="hljs-number">4</span> }));
  }
}
</code></pre>
<p>The example above uses the URL template of Open Street Maps as per the Leaflet&#39;s
tutorial, but I needed to use our privately hosted maps, so I changed it to
something like:</p>
<pre class="highlight"><code class="hljs javascript"><span class="hljs-keyword">let</span> urlTemplate = <span class="hljs-string">'http://www.mysite.com/tiles?layer=background&amp;level={z}&amp;x={x}&amp;y={y}'</span>;
map.addLayer(L.tileLayer(urlTemplate, { minZoom: <span class="hljs-number">4</span>, zoomOffset: <span class="hljs-number">8</span> }));
</code></pre>
<p>The <code>zoomOffset</code> parameter was required to fix impedence mismatch of zoom levels.</p>
<h2 id="custom-overlay-layer">Custom Overlay Layer</h2>
<p>For our custom maps we needed to show two layers on top of each other:</p>
<ul>
<li>The usual tile layer for the map background</li>
<li>The overlay layer for the map labels and additional information</li>
</ul>
<p>The overlay layer can&#39;t be broken down into tiles (not supported by our map provider),
so we need to show the whole layer as a single picture and then refresh it every
time user pans or zooms the map.</p>
<p>The overlay layer can be implemented with <code>onAdd</code> and <code>onRemove</code> functions
and then feeding an image element to the Leaflet as a layer. Here is the code:</p>
<pre class="highlight"><code class="hljs javascript">import * as L from <span class="hljs-string">'leaflet'</span>;

export <span class="hljs-keyword">class</span> LabelOverlayLayer {
  map;
  image;

  onAdd(map) {
    <span class="hljs-keyword">this</span>.map = map;

    <span class="hljs-keyword">this</span>.image = L.DomUtil.create(<span class="hljs-string">'img'</span>, <span class="hljs-string">'leaflet-tile-loaded'</span>);
    map.getPanes().overlayPane.appendChild(<span class="hljs-keyword">this</span>.image);

    map.on(<span class="hljs-string">'moveend'</span>, <span class="hljs-keyword">this</span>.render, <span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.render();
  }

  onRemove (map) {
    map.getPanes().overlayPane.removeChild(<span class="hljs-keyword">this</span>.image);
    map.off(<span class="hljs-string">'moveend'</span>, <span class="hljs-keyword">this</span>.render, <span class="hljs-keyword">this</span>);
  }

  render() {
    <span class="hljs-keyword">let</span> bounds = <span class="hljs-keyword">this</span>.map.getBounds(), mapSize = <span class="hljs-keyword">this</span>.map.getSize();
    <span class="hljs-keyword">let</span> se = bounds.getSouthEast(), nw = bounds.getNorthWest();

    <span class="hljs-keyword">let</span> tileUrl = `http:<span class="hljs-comment">//www.mysite.com/tiles?layer=labels&amp;lonmin=${nw.lng}&amp;latmin=${se.lat}&amp;lonmax=${se.lng}&amp;latmax=${nw.lat}&amp;width=${Math.floor(mapSize.x)}&amp;height=${Math.floor(mapSize.y)}`;</span>
    <span class="hljs-keyword">this</span>.image.src = tileUrl;

    <span class="hljs-keyword">let</span> pos = <span class="hljs-keyword">this</span>.map.latLngToLayerPoint(nw);
    L.DomUtil.setPosition(<span class="hljs-keyword">this</span>.image, pos, <span class="hljs-literal">false</span>);
  }
};
</code></pre>
<p>The usage of this layer in the map component is trivial:</p>
<pre class="highlight"><code class="hljs javascript"><span class="hljs-keyword">this</span>.map.addLayer(<span class="hljs-keyword">new</span> LabelOverlayLayer());
</code></pre>
<h2 id="use-the-map-component">Use the Map Component</h2>
<p>The map component is ready to be used in the application:</p>
<pre class="highlight"><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">require</span> <span class="hljs-attribute">from</span>=<span class="hljs-value">"./components/map"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">require</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">div</span>  <span class="hljs-attribute">style</span>=<span class="hljs-value">"height: 700px"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">map</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">map</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
</code></pre>
<p>The container around the map should have a non-zero height, so I made it fixed
in the example above.</p>
<p>Don&#39;t forget to bundle the leaflet assets by including the following lines
into your <code>bundles.json</code>:</p>
<pre class="highlight"><code class="hljs undefined">"includes": [
  "aurelia-framework",
  // ...
  "leaflet",
  "leaflet/dist/leaflet.css!text"
],
</code></pre>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/aurelia/'>Aurelia</a>, <a href='/tags/leaflet/'>leaflet</a>, <a href='/tags/typescript/'>typescript</a>, <a href='/tags/javascript/'>javascript</a>, <a href='/tags/maps/'>maps</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Mar 1st, 2016</div>
    
    <h1><a href='/2016/03/building-a-poker-bot-mouse-movements'>Building a Poker Bot: Mouse Movements</a></h1>
    
    <div class="post-content">
        <p><em>This is the third part of <strong>Building a Poker Bot</strong> series where I describe my experience developing bot software 
to play in online poker rooms. I&#39;m building the bot with .NET framework and F# language which makes the task relatively 
easy and very enjoyable. Here are the previous parts:</em></p>
<ul>
<li><a href="http://mikhail.io/2016/02/building-a-poker-bot-card-recognition/"><em>Building a Poker Bot: Card Recognition</em></a></li>
<li><a href="http://mikhail.io/2016/02/building-a-poker-bot-string-recognition/"><em>Building a Poker Bot: String and Number Recognition</em></a></li>
</ul>
<p>In this short post I write about the last step of the poker bot flow: clicking
the buttons. So, the screen is already recognized, the hand is understood,
the decisions are made and now the bot needs to execute the actions. Except for
the bet sizing, this simply means clicking the right button at the poker table.</p>
<p>The stealthiness of such clicks is a valid concern here. Ideally, we want all
the mouse movements to look as similar as possible to the movements produced
by a human being. For this post, I will simplify the task to the following steps:</p>
<ul>
<li>Identify where the mouse cursor is right now</li>
<li>Decide where the mouse should be moved to</li>
<li>Gradually move the mouse cursor</li>
<li>Click the button</li>
</ul>
<h2 id="cursor-position">Cursor Position</h2>
<p>It&#39;s really easy to understand where the mouse cursor currently is: just
use <code>Control.MousePosition</code> property from the standard library:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> currentPosition () = 
  <span class="hljs-keyword">let</span> mp = System.Windows.Forms.Control.MousePosition
  (mp.X, mp.Y)
</code></pre>
<p>Note that your application doesn&#39;t have to be based on WinForms, just reference
the required assembly.</p>
<h2 id="move-the-cursor">Move the Cursor</h2>
<p>I use the third party <a href="https://inputsimulator.codeplex.com/">WindowsInput</a> 
library to control the mouse and the keyboard programmatically. It uses some
weird coordinate system, so the function to move the mouse cursor looks like this:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> simulator = <span class="hljs-keyword">new</span> InputSimulator()

<span class="hljs-keyword">let</span> moveTo x y =
  <span class="hljs-keyword">let</span> toX = <span class="hljs-number">65535.</span> * x / (Screen.PrimaryScreen.Bounds.Width |&gt; float)
  <span class="hljs-keyword">let</span> toY = <span class="hljs-number">65535.</span> * y / (Screen.PrimaryScreen.Bounds.Height |&gt; float)
  simulator.Mouse.MoveMouseTo(toX, toY)
</code></pre>
<p>The input parameters <code>x</code> and <code>y</code> are the pixel location starting at 
the top-left corner of the screen.</p>
<h2 id="move-it-smoothly">Move It Smoothly</h2>
<p>Now we want to simulate the human-like movements. It won&#39;t be perfect, but
at least it should look decent. For this gradual movement function I used
a nice F# feature called asynchronous workflows. Effectively, it looks like
a loop with async sleep statements inside.</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> moveToWorkflow step (toX, toY) = async {
  <span class="hljs-keyword">let</span> (fromX, fromY) = currentPosition()
  <span class="hljs-keyword">let</span> count = Math.Max(<span class="hljs-number">10</span>, (Math.Abs (toX - fromX) + Math.Abs (toY - fromY)) / <span class="hljs-number">20</span>)
  <span class="hljs-keyword">for</span> i = <span class="hljs-number">0</span> <span class="hljs-keyword">to</span> count <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">let</span> x = step fromX toX count i |&gt; float
    <span class="hljs-keyword">let</span> y = step fromY toY count i |&gt; float
    moveTo x y
    <span class="hljs-keyword">do</span>! Async.Sleep <span class="hljs-number">3</span>
  }
</code></pre>
<p>The key parameter here is the <code>step</code> function of obscure type <code>int -&gt; int -&gt; int -&gt; int -&gt; int</code>.
Basically, it calculates a coordinate for n-th step of the movement. We can
plug different implementations of this function to find the right balance of
the movement style. Here is the simplest linear implementation:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> linearStep from until max i =
  from + (until - from) * i / max
</code></pre>
<p>The sinus-based implementation is a bit more verbose because of float-int 
conversions:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> sinStep (from:int) (until:int) (max:int) (index:int) =
  <span class="hljs-keyword">let</span> fromf = from |&gt; float
  <span class="hljs-keyword">let</span> untilf = until |&gt; float
  <span class="hljs-keyword">let</span> maxf = max |&gt; float
  <span class="hljs-keyword">let</span> indexf = index |&gt; float
  fromf + (untilf - fromf) * Math.Sin(Math.PI / <span class="hljs-number">2.</span> * indexf / maxf) |&gt; int
</code></pre>
<p>The following animation illustrates the concept: </p>
<svg width="778" height="190" viewbox="0 0 500 190">
  <image id="mouse1" x="0" y="20" width="16" height="16" xlink:href="/2016/03/building-a-poker-bot-mouse-movements/mouse_cursor-16.png"></image>
  <image id="mouse2" x="0" y="90" width="16" height="16" xlink:href="/2016/03/building-a-poker-bot-mouse-movements/mouse_cursor-16.png"></image>
  <image id="mouse3" x="0" y="160" width="16" height="16" xlink:href="/2016/03/building-a-poker-bot-mouse-movements/mouse_cursor-16.png"></image>

  <animate xlink:href="#mouse1" attributename="x" from="0" to="0" values="0;450;0" keytimes="0;0.5;1" repeatcount="indefinite" dur="2s" begin="0s" fill="none" calcmode="discrete" id="img-anim1"></animate>
  <animate xlink:href="#mouse2" attributename="x" from="0" to="0" values="0;450;0" keytimes="0;0.5;1" repeatcount="indefinite" dur="2s" begin="0s" fill="none" id="img-anim2"></animate>
  <animate xlink:href="#mouse3" attributename="x" from="0" to="0" values="0;70;139;204;264;318;364;401;428;444;450;380;311;246;186;132;86;49;22;6;0" keytimes="0;0.05;0.1;0.15;0.2;0.25;0.3;0.35;0.4;0.45;0.5;0.55;0.6;0.65;0.7;0.75;0.8;0.85;0.9;0.95;1" repeatcount="indefinite" dur="2s" begin="0s" fill="none" id="img-anim3"></animate><br></svg>

<p>The top mouse cursor just
jumps from left to right and back (no animation). The middle cursor moves with
linear speed (<code>linearStep</code> function above). The bottom cursor moves based on
the <code>sinStep</code> function derived from sinus of time.</p>
<h2 id="click-the-button">Click the Button</h2>
<p>A button is a rectangle and we want to click a random point inside it. So, all
we need is to pick random coordinates, move the mouse there and send a 
click event via the simulator:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> clickButton (minX, minY, maxX, maxY) =
  <span class="hljs-keyword">let</span> r = <span class="hljs-keyword">new</span> Random()
  <span class="hljs-keyword">let</span> p = (r.Next(minX, maxX), r.Next(minY, maxY))
  moveToWorkflow sinStep p |&gt; Async.RunSynchronously
  simulator.Mouse.LeftButtonClick()
</code></pre>
<h2 id="demo-time">Demo Time</h2>
<p>Here is the demo of the mouse movements:</p>
<p><img src="/2016/03/building-a-poker-bot-mouse-movements/mouseclicking.gif" alt="Mouse clicking the button"></p>
<p>It looks fun, doesn&#39;t it? The full code for the mouse movements can be found in 
<a href="https://github.com/mikhailshilkov/mikhailio-samples/blob/master/Clicker.fs">my github repo</a>.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/poker-bot/'>poker bot</a>, <a href='/tags/f#/'>F#</a>, <a href='/tags/human-like-behavior/'>human-like behavior</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 23rd, 2016</div>
    
    <h1><a href='/2016/02/unit-testing-dapper-repositories'>Unit testing Dapper repositories</a></h1>
    
    <div class="post-content">
        <p><a href="https://github.com/StackExchange/dapper-dot-net">Dapper</a> is a micro-ORM library which is 
very simple and super fast. In our projects we use Dapper for the tasks where something like
EntityFramework or NHibernate would be an overkill.</p>
<p>Quite often the data access code is difficult to be unit tested. Objects like
database connections, commands, transactions and contexts are hard to mock, and
thus the data access code is not easily isolated. Dapper relies heavily on SQL
statements inside C# code, which gives an extra complication. Some people would
argue that unit tests are not warranted for data access layer, and integration
tests should be used instead. Let&#39;s have a look at another possibility.</p>
<h2 id="an-example-of-a-repository">An Example of a Repository</h2>
<p>Let&#39;s say we have a simple class and we want to populate instances of this class
from the database:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Product</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Description { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
</code></pre>
<p>To be able to use Dapper for data access, we need an instance of <code>IDbConnection</code>.
As we want to be able to mock the connection for unit tests, we need to create
a factory interface to abstract it away:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IDatabaseConnectionFactory</span>
{
    <span class="hljs-function">IDbConnection <span class="hljs-title">GetConnection</span><span class="hljs-params">()</span></span>;
}
</code></pre>
<p>Now the repository would get a connection from this factory and execute 
Dapper queries on it:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProductRepository</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IDatabaseConnectionFactory connectionFactory;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ProductRepository</span><span class="hljs-params">(IDatabaseConnectionFactory connectionFactory)</span>
    </span>{
        <span class="hljs-keyword">this</span>.connectionFactory = connectionFactory;
    }

    <span class="hljs-keyword">public</span> Task&lt;IEnumerable&lt;Product&gt;&gt; GetAll()
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.connectionFactory.GetConnection().QueryAsync&lt;Product&gt;(
            <span class="hljs-string">"select * from Product"</span>);
    }
}
</code></pre>
<h2 id="testing-without-a-real-database">Testing Without a real Database</h2>
<p>Here is my approach to testing the repository:</p>
<ol>
<li>Use an in-memory <a href="https://www.sqlite.org/">SQLite3</a> database.</li>
<li>Create a table there and put some data in.</li>
<li>Run the repository against this database.</li>
<li>Compare the result to the expected values.</li>
</ol>
<p>Here is a helper class which uses another micro-ORM library <a href="http://ormlite.com/">OrmLite</a> to talk
to SQLite database:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InMemoryDatabase</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> OrmLiteConnectionFactory dbFactory = 
        <span class="hljs-keyword">new</span> OrmLiteConnectionFactory(<span class="hljs-string">":memory:"</span>, SqliteOrmLiteDialectProvider.Instance);

    <span class="hljs-function"><span class="hljs-keyword">public</span> IDbConnection <span class="hljs-title">OpenConnection</span><span class="hljs-params">()</span> </span>=&gt; <span class="hljs-keyword">this</span>.dbFactory.OpenDbConnection();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> Insert&lt;T&gt;(IEnumerable&lt;T&gt; items)
    {
        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> db = <span class="hljs-keyword">this</span>.OpenConnection())
        {
            db.CreateTableIfNotExists&lt;T&gt;();
            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> item <span class="hljs-keyword">in</span> items)
            {
                db.Insert(item);
            }
        }
    }
}
</code></pre>
<p>And here is the test for our <code>ProductRepository</code> class:</p>
<pre class="highlight"><code class="hljs cs">[Test]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">QueryTest</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// Arrange</span>
    <span class="hljs-keyword">var</span> products = <span class="hljs-keyword">new</span> List&lt;Product&gt;
    {
        <span class="hljs-keyword">new</span> Product { ... },
        <span class="hljs-keyword">new</span> Product { ... }
    };
    <span class="hljs-keyword">var</span> db = <span class="hljs-keyword">new</span> InMemoryDatabase();
    db.Insert(products);
    connectionFactoryMock.Setup(c =&gt; c.GetConnection()).Returns(db.OpenConnection());

    <span class="hljs-comment">// Act</span>
    <span class="hljs-keyword">var</span> result = <span class="hljs-function"><span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title">ProductRepository</span><span class="hljs-params">(connectionFactoryMock.Object)</span>.<span class="hljs-title">GetAll</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">// Assert</span>
    result.ShouldBeEquivalentTo(products);
}
</code></pre>
<h2 id="is-it-a-unit-test-">Is It a Unit Test?</h2>
<p>Well, not completely. This approach does not mock the database, but instead puts
an in-memory database in place of the normal one. The problem is that we don&#39;t 
control all the details how it works, so it might not be as flexible as we need.
For instance, SQLite type system is quite simplistic, so while <code>INT</code> and <code>BIGINT</code>
are different column types in SQL Server, they are the same <code>INTEGER</code> type in
SQLite. This can lead to false positive or false negative tests in edge cases.</p>
<p>Nevertheless, the concept is simple and requires very little amount of code,
so it&#39;s useful to have it in the toolbox anyway. The resulting tests are fast,
have no external dependencies and are always consistent between multiple runs.
That makes them better than real integration tests for the simple scenarios 
during TDD development.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/unit-testing/'>unit testing</a>, <a href='/tags/dapper/'>Dapper</a>, <a href='/tags/orm/'>ORM</a>, <a href='/tags/tdd/'>TDD</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 10th, 2016</div>
    
    <h1><a href='/2016/02/building-a-poker-bot-string-recognition'>Building a Poker Bot: String and Number Recognition</a></h1>
    
    <div class="post-content">
        <p><em>This is the second part of <strong>Building a Poker Bot</strong> series where I describe my experience developing bot software 
to play in online poker rooms. I&#39;m building the bot with .NET framework and F# language which makes the task relatively 
easy and very enjoyable. Here is the first part:
<a href="http://mikhail.io/2016/02/building-a-poker-bot-card-recognition/">Building a Poker Bot: Card Recognition</a>
</em></p>
<h2 id="why-string-recognition">Why string recognition</h2>
<p>Reading cards and other fixed images was the first step. The bot should also
be able to read different text-based information from the screen, e.g.</p>
<ul>
<li>Current blind levels</li>
<li>Current pot size</li>
<li>The size of bets made by each player</li>
<li>Player names</li>
<li>Stack sizes</li>
<li>Chat messages (for advanced scenarios)</li>
</ul>
<p>We need this vital information to make proper decisions, so let&#39;s look at
how to parse the textual data.</p>
<h2 id="new-challenges">New challenges</h2>
<p>String recognition has some specific difficulties when compared to fixed
images like cards:</p>
<ul>
<li>The size of a string is not predefined. Obviously, the longer the string, the
more space it takes on the screen</li>
<li>The position of a string is not fixed either. Some strings are aligned to
the center, others may diverge based on other variable parts like stakes or blinds</li>
<li>Different strings might be rendered in different font size</li>
</ul>
<p>Here is what needs to be done to overcome these complications:</p>
<ul>
<li>Pick the layout which makes your life easier </li>
<li>Adjust fonts and positions if possible </li>
<li>Make sure that all important strings are always visible and not overlapping to other information</li>
<li>For each string define a region where it belongs to in 100% cases. The background
of this region should be more or less evenly filled with a color in contrast to the font color.</li>
</ul>
<h2 id="string-recognition-steps">String recognition steps</h2>
<p>We start with a screenshot of a poker table again:</p>
<p><img src="/2016/02/building-a-poker-bot-string-recognition/table.png" alt="Poker table screenshot"></p>
<p>We know our fixed regions where our labels are located, so we take those
regions for processing:</p>
<p><img src="/2016/02/building-a-poker-bot-string-recognition/regions.png" alt="Regions of string recognition"></p>
<p>For each region we trim away the blank margins around the text (i.e. left,
top, right and bottom padding):</p>
<p><img src="/2016/02/building-a-poker-bot-string-recognition/nomargin.png" alt="Margins being removed"></p>
<p>We find dark lines between bright symbols and we consider them as gaps
between characters:</p>
<p><img src="/2016/02/building-a-poker-bot-string-recognition/splitchars.png" alt="Split to characters"></p>
<p>The final step is to compare each symbol to the known patterns and find the best
match (in case of my layout the match for symbols is always 100% perfect). Let&#39;s 
look how these steps are implemented.</p>
<h2 id="removing-padding-around-the-text">Removing padding around the text</h2>
<p>Because the padding is removed from all 4 sides of the region, I decided to use
<code>Array2D</code> data type to be able to iterate in different order. The whole algorithm operates
with black or white points defined as a helper type:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">BW</span> </span>= B | W
</code></pre>
<p>So the <code>removePadding</code> function has type of <code>BW[,] -&gt; BW[,]</code> and looks
like this:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> removePadding pixels =
  <span class="hljs-keyword">let</span> allBlack s = Seq.exists ((=) W) s
  <span class="hljs-keyword">let</span> maxWidth = Array2D.length1 pixels - <span class="hljs-number">1</span>
  <span class="hljs-keyword">let</span> maxHeight = Array2D.length2 pixels - <span class="hljs-number">1</span>
  <span class="hljs-keyword">let</span> firstX = [<span class="hljs-number">0.</span>.maxWidth] 
    |&gt; Seq.tryFindIndex (<span class="hljs-keyword">fun</span> y -&gt; allBlack pixels.[y, <span class="hljs-number">0.</span>.maxHeight])
  <span class="hljs-keyword">let</span> lastX = [<span class="hljs-number">0.</span>.maxWidth] 
    |&gt; Seq.tryFindIndexBack (<span class="hljs-keyword">fun</span> y -&gt; allBlack pixels.[y, <span class="hljs-number">0.</span>.maxHeight])
  <span class="hljs-keyword">let</span> firstY = [<span class="hljs-number">0.</span>.maxHeight] 
    |&gt; Seq.tryFindIndex (<span class="hljs-keyword">fun</span> x -&gt; allBlack pixels.[<span class="hljs-number">0.</span>.maxWidth, x])
  <span class="hljs-keyword">let</span> lastY = [<span class="hljs-number">0.</span>.maxHeight] 
    |&gt; Seq.tryFindIndexBack (<span class="hljs-keyword">fun</span> x -&gt; allBlack pixels.[<span class="hljs-number">0.</span>.maxWidth, x])

  <span class="hljs-keyword">match</span> (firstX, lastX, firstY, lastY) <span class="hljs-keyword">with</span>
  | (Some fx, Some lx, Some fy, Some ly) -&gt; pixels.[fx..lx, fy..ly]
  | _ -&gt; Array2D.init <span class="hljs-number">0</span> <span class="hljs-number">0</span> (<span class="hljs-keyword">fun</span> _ _ -&gt; B)
</code></pre>
<p>The first part finds the amount of fully-black columns and rows in the array.
Then, if white points are found, the second part returns a sub array based on
the indices, otherwise empty array is returned.</p>
<h2 id="split-the-text-into-characters">Split the text into characters</h2>
<p>First, we convert our 2D array into the list of lists, where each item in the
top-level list represents a single column of pixels:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> pixelColumns =
  [<span class="hljs-number">0.</span>.Array2D.length1 pixels - <span class="hljs-number">1</span>] 
  |&gt; Seq.map (<span class="hljs-keyword">fun</span> x -&gt; pixels.[x, <span class="hljs-number">0.</span>.Array2D.length2 pixels - <span class="hljs-number">1</span>] |&gt; List.ofArray)
</code></pre>
<p>Then we can fold this list of columns into the symbols, where each symbol itself
is the list of columns:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> splitIntoSymbols (e : BW list) (state: BW list list list) = 
  <span class="hljs-keyword">match</span> state <span class="hljs-keyword">with</span>
  | cur::rest -&gt;
      <span class="hljs-keyword">if</span> isSeparator e <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">match</span> cur <span class="hljs-keyword">with</span>
        | _::_ -&gt; []::state <span class="hljs-comment">// add new list</span>
        | _ -&gt; state        <span class="hljs-comment">// skip if we already have empty item</span>
      <span class="hljs-keyword">else</span> (e::cur)::rest   <span class="hljs-comment">// add e to current list</span>
  | _ -&gt; [[e]]

Seq.foldBack splitIntoSymbols pixelColumns []
</code></pre>
<p>The type of <code>state</code> is a bit of brain teaser, I guess it could be improved
by introducing some intermediate type with descriptive name, but I decided
to leave that part for now. Read it as list of symbols, which are lists of
columns, which are lists of pixels.</p>
<h2 id="match-the-symbols-vs-the-known-patterns">Match the symbols vs the known patterns</h2>
<p>This part was already described in <a href="http://mikhail.io/2016/02/building-a-poker-bot-card-recognition/">my first article</a>.
Basically we compare the list of black or white points to the patterns of
the known symbols:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> getChar patterns bws =
  <span class="hljs-keyword">let</span> samePatterns h p =
    Seq.zip h p
    |&gt; Seq.forall (<span class="hljs-keyword">fun</span> (v1, v2) -&gt; v1 = v2)
  <span class="hljs-keyword">let</span> matchingPattern = 
    patterns 
      |&gt; Array.filter (<span class="hljs-keyword">fun</span> p -&gt; List.length p.Pattern = List.length bws)
      |&gt; Array.filter (<span class="hljs-keyword">fun</span> p -&gt; samePatterns bws p.Pattern)
      |&gt; Array.tryHead
  defaultArg (Option.map (<span class="hljs-keyword">fun</span> p -&gt; p.Char) matchingPattern) '?'
</code></pre>
<h2 id="putting-it-all-together">Putting it all together</h2>
<p>The <code>recognizeString</code> function accepts lower-order functions to match 
symbols and get pixels together with width and height of the region:</p>
<pre class="highlight"><code class="hljs fs">recognizeString: (BW list list -&gt; char) -&gt; (int -&gt; int -&gt; color) -&gt; int -&gt; int -&gt; string
</code></pre>
<p>It builds an array of pixels, removes padding and folds with recognition.</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> recognizeString matchSymbol getPixel width height =

  <span class="hljs-keyword">let</span> pixels = 
    Array2D.init width height (<span class="hljs-keyword">fun</span> x y -&gt; isWhite (getPixel x y))
    |&gt; removePadding

  <span class="hljs-keyword">let</span> pixelColumns =
    [<span class="hljs-number">0.</span>.Array2D.length1 pixels - <span class="hljs-number">1</span>] 
    |&gt; Seq.map (<span class="hljs-keyword">fun</span> x -&gt; pixels.[x, <span class="hljs-number">0.</span>.Array2D.length2 pixels - <span class="hljs-number">1</span>] |&gt; List.ofArray)      

  Seq.foldBack splitIntoSymbols pixelColumns []
  |&gt; List.map matchSymbol
  |&gt; Array.ofSeq
  |&gt; String.Concat
</code></pre>
<p>Then we use it with a specific recognition patterns, e.g. known digits in case
of numbers recognition:</p>
<pre class="highlight"><code class="hljs fs"><span class="hljs-keyword">let</span> recognizeNumber x =
  recognizeString (getChar numberPatterns) x
</code></pre>
<p>A way to produce these patterns is discussed in <a href="http://mikhail.io/2016/02/building-a-poker-bot-card-recognition/">the previous part</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>String recognition takes a bit more steps to execute comparing to the recognition
of fixed objects. Nevertheless it&#39;s pretty straightforward to implement once
we split it into small and well-understood conversion steps. The full code 
for card recognition can be found in <a href="https://github.com/mikhailshilkov/mikhailio-samples/blob/master/StringRecognition.fs">my github repo</a>.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/poker-bot/'>poker bot</a>, <a href='/tags/f#/'>F#</a>, <a href='/tags/image-recognition/'>image recognition</a>, <a href='/tags/ocr/'>OCR</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 8th, 2016</div>
    
    <h1><a href='/2016/02/akka-net-style-actors-in-service-fabric'>Akka.NET-style actors in Service Fabric</a></h1>
    
    <div class="post-content">
        <p>Akka.NET and Service Fabric are the two actor frameworks that emerged in .NET world in the last year.
The two implementations of actor models are quite different. These differences are multi-faceted but
today I want to focus on API to define an actor and to communicate to it.</p>
<h2 id="service-fabric-actors">Service Fabric Actors</h2>
<p>Every actor in Service Fabric has a public interface which describes its behaviour. For this article
I&#39;m going to use a toy example based on weather reports. Our actor will be able to get whether reports
and then return the maximum temperature for a given period. An instance of actor will be created
for each city (geo partitioning). Here is our interface in Service Fabric:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IWeatherActor</span> : <span class="hljs-title">IActor</span>
{
    <span class="hljs-function">Task <span class="hljs-title">AddWeatherReport</span><span class="hljs-params">(WeatherReport report)</span></span>;

    Task&lt;<span class="hljs-keyword">int</span>?&gt; GetMaxTemperature(Period period);
}
</code></pre>
<p>We have two operations: a command and a query. They are both async (return <code>Task</code>). The data classes
are required to be mutable DTOs based on <code>DataContract</code>:</p>
<pre class="highlight"><code class="hljs cs">[DataContract]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WeatherReport</span>
{
    [DataMember]
    <span class="hljs-keyword">public</span> DateTime Moment { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    [DataMember]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Temperature { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    [DataMember]
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Humidity { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}

[DataContract]
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Period</span>
{
    [DataMember]
    <span class="hljs-keyword">public</span> DateTime From { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    [DataMember]
    <span class="hljs-keyword">public</span> DateTime Until { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
</code></pre>
<p>And here is the implementation of the weather actor:</p>
<pre class="highlight"><code class="hljs undefined">internal class WeatherActor : StatefulActor&lt;List&lt;WeatherReport&gt;&gt;, IWeatherActor
{
    public Task AddWeatherReport(WeatherReport report)
    {
        this.State = this.State ?? new List&lt;WeatherReport&gt;();
        this.State.Add(report);
        return Task.FromResult(0);
    }

    public Task&lt;int?&gt; GetMaxTemperature(Period period)
    {
        return Task.FromResult(
            (this.State ?? Enumerable.Empty&lt;WeatherReport&gt;())
            .Where(r =&gt; r.Moment &gt; period.From &amp;&amp; r. Moment &lt;= period.Until)
            .Max(r =&gt; (int?)r.Temperature));
    }
}
</code></pre>
<p>Service Fabric provides reliable storage out of the box, so we are using it to
store our reports. There&#39;s no code required to instantiate an actor. Here is the
code to use it:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-comment">// Submit a new report</span>
IWeatherActor actor = ActorProxy.Create&lt;IWeatherActor&gt;(<span class="hljs-keyword">new</span> ActorId(<span class="hljs-string">"Amsterdam"</span>));
actor.AddWeatherReport(
    <span class="hljs-keyword">new</span> WeatherReport { Moment = DateTime.Now, Temperature = <span class="hljs-number">22</span>, Humidity = <span class="hljs-number">55</span> });

<span class="hljs-comment">// Make a query somewhere else</span>
IWeatherActor actor = ActorProxy.Create&lt;IWeatherActor&gt;(<span class="hljs-keyword">new</span> ActorId(<span class="hljs-string">"Amsterdam"</span>));
<span class="hljs-keyword">var</span> result = actor.GetMaxTemperature(<span class="hljs-keyword">new</span> Period { From = monthAgo, Until = now });
</code></pre>
<h2 id="akka-net-actors">Akka.NET Actors</h2>
<p>Actors in Akka.NET are message-based. The messages are immutable POCOs, which 
is a great design decision. Here are the messages for our scenario:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WeatherReport</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">WeatherReport</span><span class="hljs-params">(DateTime moment, <span class="hljs-keyword">int</span> temperature, <span class="hljs-keyword">int</span> humidity)</span>
    </span>{
        <span class="hljs-keyword">this</span>.Moment = moment;
        <span class="hljs-keyword">this</span>.Temperature = temperature;
        <span class="hljs-keyword">this</span>.Humidity = humidity;
    }

    <span class="hljs-keyword">public</span> DateTime Moment { <span class="hljs-keyword">get</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Temperature { <span class="hljs-keyword">get</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Humidity { <span class="hljs-keyword">get</span>; }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Period</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Period</span><span class="hljs-params">(DateTime <span class="hljs-keyword">from</span>, DateTime until)</span>
    </span>{
        <span class="hljs-keyword">this</span>.From = <span class="hljs-keyword">from</span>;
        <span class="hljs-keyword">this</span>.Until = until;
    }

    <span class="hljs-keyword">public</span> DateTime From { <span class="hljs-keyword">get</span>; }
    <span class="hljs-keyword">public</span> DateTime Until { <span class="hljs-keyword">get</span>; }
}
</code></pre>
<p>There&#39;s no need to define any interfaces. The basic actor implementation derives from
<code>ReceiveActor</code> and calls <code>Receive</code> generic method to setup a callback which is called
when a message of specified type is received:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WeatherActor</span> : <span class="hljs-title">ReceiveActor</span>
{
    <span class="hljs-keyword">private</span> List&lt;WeatherReport&gt; state = <span class="hljs-keyword">new</span> List&lt;WeatherReport&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">WeatherActor</span><span class="hljs-params">()</span>
    </span>{
        Receive&lt;WeatherReport&gt;(<span class="hljs-keyword">this</span>.AddWeatherReport);
        Receive&lt;Period&gt;(<span class="hljs-keyword">this</span>.GetMaxTemperature);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddWeatherReport</span><span class="hljs-params">(WeatherReport report)</span>
    </span>{
        <span class="hljs-keyword">this</span>.state.Add(report);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetMaxTemperature</span><span class="hljs-params">(Period period)</span>
    </span>{
        <span class="hljs-keyword">var</span> response = <span class="hljs-keyword">this</span>.state
            .Where(r =&gt; r.Moment &gt; period.From &amp;&amp; r. Moment &lt;= period.Until)
            .Max(r =&gt; (<span class="hljs-keyword">int</span>?)r.Temperature);
        Sender.Tell(response, Self);
    }
}
</code></pre>
<p>Note a couple more differences in this implementation comparing to Fabric style:</p>
<ul>
<li><p>State is stored in a normal class field and is not persistent or replicated
by default. This can be solved by Akka.NET Persistence, which would save all
messages (and potentially snapshots) to the external database. Still, it won&#39;t
be the same level of convenience as in-built Service Fabric statefullness.</p>
</li>
<li><p><code>GetMaxTemperature</code> method does not return anything, because nobody would look
at the returned value. Instead, it sends yet another message to the sender actor.
So, <code>Request-Response</code> workflow is supported but is a bit less convenient and
explicit.</p>
</li>
</ul>
<p>Let&#39;s have a look at the client code. <code>ActorSelection</code> is the closest notion to
Fabric&#39;s <code>ActorProxy</code>: it does not create an actor, but just gets an endpoint
based on the name. Note that Akka.NET actor needs to be explicitly created by
another actor, but lifetime management is a separate discussion, so we&#39;ll skip 
it for now. Here is the report sender:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-comment">// Submit a new report</span>
<span class="hljs-keyword">var</span> msg = <span class="hljs-keyword">new</span> WeatherReport { Moment = DateTime.Now, Temperature = <span class="hljs-number">22</span>, Humidity = <span class="hljs-number">55</span> };
Context.ActorSelection(<span class="hljs-string">"/user/weather/Amsterdam"</span>).Tell(msg);
</code></pre>
<p>Asking <code>ActorSelection</code> is not directly possible, we would need to setup an
inbox and receive callback messages. We&#39;ll pretend that we have an <code>ActorRef</code>
for the sake of simplicity:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-comment">// Make a query somewhere else</span>
ActoRef actor = ... ; <span class="hljs-comment">// we have it</span>
<span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> actor.Ask(<span class="hljs-keyword">new</span> Period { From = monthAgo, Until = now });
</code></pre>
<h2 id="the-best-of-two-worlds">The Best of Two Worlds</h2>
<p>Now my goals is to come up with an implementation of Service Fabric actors with
the properties that combine the good parts of both frameworks (without explicitly
using Akka.NET), i.e.</p>
<ul>
<li>Use the full power of Service Fabric actors, including lifetime management,
cluster management and reliable state</li>
<li>Use the simplicity of Request-Response pattern implementation of Service Fabric</li>
<li>Support immutable POCO messages instead of <code>DataContract</code> DTOs</li>
<li>Use <code>ReceiveActor</code>-like API for message processing</li>
</ul>
<p>Here is the third implementation of our Weather Actor (the definitions of messages
from Akka.NET example are intact):</p>
<pre class="highlight"><code class="hljs undefined">[ActorService(Name = "WeatherActor")]
public class WeatherActor : StetefulReceiveActor&lt;List&lt;WeatherReport&gt;&gt;
{
    public WeatherActor()
    {
        Receive&lt;WeatherReport&gt;(this.AddWeatherReport);
        Receive&lt;Period, int&gt;(this.GetMaxTemperature);
    }

    public Task&lt;List&lt;WeatherReport&gt;&gt; AddWeatherReport(
        List&lt;WeatherReport&gt; state, WeatherReport report)
    {
        state = state ?? new List&lt;WeatherReport&gt;();
        state.Add(report);
        return Task.FromResult(state);
    }

    public Task&lt;int?&gt; GetMaxTemperature(List&lt;WeatherReport&gt; state, Period period)
    {
        return Task.FromResult(
            (state ?? Enumerable.Empty&lt;WeatherReport&gt;())
            .Where(r =&gt; r.Moment &gt; period.From &amp;&amp; r. Moment &lt;= period.Until)
            .Max(r =&gt; (int?)r.Temperature));
    }
}
</code></pre>
<p>The base <code>ReceiveActor</code> class is not defined yet, we&#39;ll do it in the next section. Here is
how it&#39;s being used:</p>
<ul>
<li>The base class is generic and it accepts the type of the state (similar to normal Fabric actors)</li>
<li>Constructor registers two <code>Receive</code> handlers: message handler and request handler. Note
that the later one accepts two type parameters: request type and response type</li>
<li>Both handlers get the current state as the first argument instead of pulling it from the property of
the base class</li>
<li>The both return <code>Task</code>&#39;ed data. Message handler is allowed to change the state, while
request handler does  not change the state but just returns the response back</li>
<li><code>ServiceName</code> attribute is required because there are (may be) multiple classes implementing
the same interface</li>
</ul>
<p>The client code uses our own <code>MessageActorProxy</code> class to create non-generic proxies which
are capable to <code>Tell</code> (send a message one way) and <code>Ask</code> (do request and wait for response):</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-comment">// Submit a new report</span>
<span class="hljs-keyword">var</span> actor = MessageActorProxy.Create(<span class="hljs-keyword">new</span> ActorId(<span class="hljs-string">"Amsterdam"</span>), <span class="hljs-string">"WeatherActor"</span>);
actor.Tell(<span class="hljs-keyword">new</span> WeatherReport { Moment = DateTime.Now, Temperature = <span class="hljs-number">22</span>, Humidity = <span class="hljs-number">55</span> });

<span class="hljs-comment">// Make a query somewhere else</span>
<span class="hljs-keyword">var</span> actor = MessageActorProxy.Create(<span class="hljs-keyword">new</span> ActorId(<span class="hljs-string">"Amsterdam"</span>), <span class="hljs-string">"WeatherActor"</span>);
<span class="hljs-keyword">var</span> result = actor.Ask(<span class="hljs-keyword">new</span> Period { From = monthAgo, Until = now });
</code></pre>
<h2 id="implementation-of-receiveactor">Implementation of ReceiveActor</h2>
<p>Let&#39;s start with the interface definition:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IReceiveActor</span> : <span class="hljs-title">IActor</span>
{
    <span class="hljs-function">Task <span class="hljs-title">Tell</span><span class="hljs-params">(<span class="hljs-keyword">string</span> typeName, <span class="hljs-keyword">byte</span>[] message)</span></span>;

    [Readonly]
    Task&lt;<span class="hljs-keyword">byte</span>[]&gt; Ask(<span class="hljs-keyword">string</span> typeName, <span class="hljs-keyword">byte</span>[] message);
}
</code></pre>
<p>The two methods for <code>Tell</code> and <code>Ask</code> accept serializes data together with fully qualified
type name. This will allow passing any kind of objects which can be handled by a serializer
of choice (I used Newtonsoft JSON serializer).</p>
<p>Actor implementation derives from <code>StatefulActor</code> and uses another type/bytes pair to store
the serialized state:</p>
<pre class="highlight"><code class="hljs undefined">    public abstract class StatefulReceiveActor : StatefulActor&lt;StateContainer&gt;, 
                                                 IReceiveActor
    {
        // ...
    }

    [DataContract]
    public class StateContainer
    {
        [DataMember]
        public string TypeName { get; set; }

        [DataMember]
        public byte[] Data { get; set; }
    }
</code></pre>
<p>The simplistic implementation of <code>Receive</code> generic methods uses two dictionaries
to store the handlers:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">private</span> Dictionary&lt;Type, Func&lt;<span class="hljs-keyword">object</span>, <span class="hljs-keyword">object</span>, Task&lt;<span class="hljs-keyword">object</span>&gt;&gt;&gt; handlers;
<span class="hljs-keyword">private</span> Dictionary&lt;Type, Func&lt;<span class="hljs-keyword">object</span>, <span class="hljs-keyword">object</span>, Task&lt;<span class="hljs-keyword">object</span>&gt;&gt;&gt; askers;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ReceiveActor</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">this</span>.handlers = <span class="hljs-keyword">new</span> Dictionary&lt;Type, Func&lt;<span class="hljs-keyword">object</span>, <span class="hljs-keyword">object</span>, Task&lt;<span class="hljs-keyword">object</span>&gt;&gt;&gt;();
    <span class="hljs-keyword">this</span>.askers = <span class="hljs-keyword">new</span> Dictionary&lt;Type, Func&lt;<span class="hljs-keyword">object</span>, <span class="hljs-keyword">object</span>, Task&lt;<span class="hljs-keyword">object</span>&gt;&gt;&gt;();
}

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> Receive&lt;T&gt;(Func&lt;<span class="hljs-keyword">object</span>, T, Task&lt;<span class="hljs-keyword">object</span>&gt;&gt; handler)
    =&gt; <span class="hljs-keyword">this</span>.handlers.Add(<span class="hljs-keyword">typeof</span>(T), <span class="hljs-keyword">async</span> (s, m) =&gt; <span class="hljs-function"><span class="hljs-keyword">await</span> <span class="hljs-title">handler</span><span class="hljs-params">(s, (T)</span>m))</span>;

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> Receive&lt;TI, TO&gt;(Func&lt;<span class="hljs-keyword">object</span>, TI, Task&lt;TO&gt;&gt; asker)
    =&gt; <span class="hljs-keyword">this</span>.askers.Add(<span class="hljs-keyword">typeof</span>(TI), <span class="hljs-keyword">async</span> (s, m) =&gt; <span class="hljs-function"><span class="hljs-keyword">await</span> <span class="hljs-title">asker</span><span class="hljs-params">(s, (TI)</span>m))</span>;
</code></pre>
<p>The <code>Tell</code> method deserializes the message and state, then picks a handler based on
the message type, executes it and serializes the produced state back:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Tell</span><span class="hljs-params">(<span class="hljs-keyword">string</span> typeName, <span class="hljs-keyword">byte</span>[] message)</span>
</span>{
    <span class="hljs-keyword">var</span> type = Type.GetType(typeName);
    <span class="hljs-keyword">var</span> typedMessage = <span class="hljs-keyword">this</span>.serializer.Deserialize(message, type);

    <span class="hljs-keyword">var</span> typedState = <span class="hljs-keyword">this</span>.State != <span class="hljs-keyword">null</span>
        ? <span class="hljs-keyword">this</span>.serializer.Deserialize(<span class="hljs-keyword">this</span>.State.Data, Type.GetType(<span class="hljs-keyword">this</span>.State.TypeName))
        : <span class="hljs-keyword">null</span>;
    <span class="hljs-keyword">var</span> handler = <span class="hljs-keyword">this</span>.handlers.FirstOrDefault(t =&gt; t.Key.IsAssignableFrom(type)).Value;
    <span class="hljs-keyword">if</span> (handler != <span class="hljs-keyword">null</span>)
    {
        <span class="hljs-keyword">var</span> newState = <span class="hljs-function"><span class="hljs-keyword">await</span> <span class="hljs-title">handler</span><span class="hljs-params">(typedState, typedMessage)</span></span>;
        <span class="hljs-keyword">this</span>.State =
            newState != <span class="hljs-keyword">null</span>
            ? <span class="hljs-keyword">new</span> StateContainer 
              { 
                  Data = <span class="hljs-keyword">this</span>.serializer.Serialize(newState), 
                  TypeName = newState.GetType().AssemblyQualifiedName 
              }
            : <span class="hljs-keyword">null</span>;
    }
}
</code></pre>
<p>The implementation of <code>Ask</code> is almost identical, so I&#39;ll skip it. <code>MessageActorProxy</code> 
encapsulates the serialization around passing data to normal <code>ActorProxy</code> class:</p>
<pre class="highlight"><code class="hljs cs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MessageActorProxy</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IStatefulMessageActor proxy;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ISerializer serializer = <span class="hljs-keyword">new</span> JsonByteSerializer();

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">MessageActorProxy</span><span class="hljs-params">(ActorId actorId, <span class="hljs-keyword">string</span> serviceName)</span>
    </span>{
        <span class="hljs-keyword">this</span>.proxy = ActorProxy.Create&lt;IReceiveActor&gt;(actorId, serviceName: serviceName);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">Tell</span><span class="hljs-params">(<span class="hljs-keyword">object</span> message)</span>
    </span>{
        <span class="hljs-keyword">var</span> serialized = <span class="hljs-keyword">this</span>.serializer.Serialize(message);
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.proxy.Send(message.GetType().AssemblyQualifiedName, serialized);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;T&gt; Ask&lt;T&gt;(<span class="hljs-keyword">object</span> message)
    {
        <span class="hljs-keyword">var</span> serialized = <span class="hljs-keyword">this</span>.serializer.Serialize(message);
        <span class="hljs-keyword">var</span> fullName = message.GetType().AssemblyQualifiedName;
        <span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.proxy.Ask(fullName, serialized);
        <span class="hljs-keyword">return</span> (T)<span class="hljs-keyword">this</span>.serializer.Deserialize(response, <span class="hljs-keyword">typeof</span>(T));
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MessageActorProxy <span class="hljs-title">Create</span><span class="hljs-params">(ActorId actorId, <span class="hljs-keyword">string</span> serviceType)</span>
    </span>{
        <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title">MessageActorProxy</span><span class="hljs-params">(actorId, serviceType)</span></span>;
    }
}
</code></pre>
<p>Let&#39;s briefly wrap it up.</p>
<h2 id="conclusion">Conclusion</h2>
<p>At this stage Azure Service Fabric lacks support of some actor model best practices
like message-based API and immutable POCO classes. At the same time, it provides
super powerful setup regarding cluster resource management, state replication, fault
tolerance and reliable communication. We can borrow some approaches that are used in Akka.NET
framework to improve the developer experience who wants to leverage the power
of Service Fabric.</p>

    </div>

    

    
    <div class="post-tags">
        Posted In: <a href='/tags/service-fabric/'>service fabric</a>, <a href='/tags/akka.net/'>akka.net</a>, <a href='/tags/actor-model/'>actor model</a>
    </div>
    
</article>



    <article class="post">
    <div class="post-date">Feb 1st, 2016</div>
    <h1><a href='/2016/02/building-a-poker-bot-card-recognition'>Building a Poker Bot: Card Recognition</a></h1>
    <div class="post-content">
        This is the first part of **Building a Poker Bot** series where I describe my experience developing bot software for online poker rooms. I'm building the bot with .NET framework and F# language which makes the task relatively easy and very enjoyable.
    </div>
    <div class="post-goundercut">
        <a href='/2016/02/building-a-poker-bot-card-recognition'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/poker-bot/'>poker bot</a>, <a href='/tags/f#/'>F#</a>, <a href='/tags/image-recognition/'>image recognition</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Jan 25th, 2016</div>
    <h1><a href='/2016/01/monads-explained-in-csharp'>Monads explained in C#</a></h1>
    <div class="post-content">
        It looks like there is a mandatory post that every blogger who learns functional programming should write: what a Monad is. Monads have the reputation of being something very abstract and very confusing for every developer who is not a hipster Haskell programmer. They say that once you understand what a monad is, you loose the ability to explain it in simple language. Doug Crockford was the first one to lay this rule down, but it becomes kind of obvious once you read 3 or 5 &quot;explanations&quot; on the web. Here is my attempt.
    </div>
    <div class="post-goundercut">
        <a href='/2016/01/monads-explained-in-csharp'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/functional-programming/'>functional programming</a>, <a href='/tags/monads/'>monads</a>, <a href='/tags/maybe/'>maybe</a>, <a href='/tags/linq/'>LINQ</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Jan 13th, 2016</div>
    <h1><a href='/2016/01/fire-and-forget-in-service-fabric-actors'>Fire-and-forget in Service Fabric actors</a></h1>
    <div class="post-content">
        At the [recent Webscale Architecture meetup](http://www.meetup.com/Webscale-Architecture-NL/events/225979118/) we discussed two implementations of the Actor model in the .NET ecosystem: [Akka.NET](http://akka.net) and [Azure Service Fabric Actors](https://azure.microsoft.com/en-us/documentation/articles/service-fabric-reliable-actors-introduction/). One important discussion was around **Ask** vs **Tell** call model. With **Tell** model, the Sender just sends the message to the Recipient without waiting for a result to come back. **Ask** model means the Sender will at some point get a response back from the Receiver, potencially blocking its own execution.
    </div>
    <div class="post-goundercut">
        <a href='/2016/01/fire-and-forget-in-service-fabric-actors'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/actor-model/'>Actor model</a>, <a href='/tags/azure/'>Azure</a>, <a href='/tags/akka.net/'>Akka.NET</a>, <a href='/tags/service-fabric/'>Service Fabric</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Jan 6th, 2016</div>
    <h1><a href='/2016/01/validation-with-either-data-type-in-csharp'>Validation with Either data type in C#</a></h1>
    <div class="post-content">
        In this article we will employ a functional monadic concept **Either** to make validation code more expressive and easier to maintain.
    </div>
    <div class="post-goundercut">
        <a href='/2016/01/validation-with-either-data-type-in-csharp'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/functional-programming/'>functional programming</a>, <a href='/tags/clean-code/'>clean code</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Dec 22nd, 2015</div>
    <h1><a href='/2015/12/weaving-your-domain-classes-with-fody'>Weaving your domain classes with Fody</a></h1>
    <div class="post-content">
        When I model the business domain with C#, the resulting data structures tend to contain a lot of boilerplate code. It's repeated from class to class and it gets more difficult to see the essence of the model behind the repetitive cruft. In this article I show off one trick to reduce this boilerplate code with Fody library.
    </div>
    <div class="post-goundercut">
        <a href='/2015/12/weaving-your-domain-classes-with-fody'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/fody/'>Fody</a>, <a href='/tags/ddd/'>DDD</a>, <a href='/tags/code-generation/'>code generation</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Dec 14th, 2015</div>
    <h1><a href='/2015/12/deploy-your-spa-to-azure'>Deploy your SPA to Azure</a></h1>
    <div class="post-content">
        In this post I want to share a simple tutorial on how to deploy your single page application into the Azure cloud. I have a Single Page Application (SPA) done with HTML/JavaScript in a separate local Git repository. I alsp have a ASP.NET 4.6 Web API service which serves the data for SPA in another local Git repository. Now I want to deploy both to the Azure cloud, and make it easy to deploy changes in the future.
    </div>
    <div class="post-goundercut">
        <a href='/2015/12/deploy-your-spa-to-azure'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/azure/'>Azure</a>, <a href='/tags/asp.net-web-api/'>ASP.NET Web API</a>, <a href='/tags/spa/'>SPA</a>, <a href='/tags/continuous-deployment/'>Continuous deployment</a>, <a href='/tags/git/'>Git</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Nov 24th, 2015</div>
    <h1><a href='/2015/11/review-of-jspm-course'>Review of the course &quot;Modern, Modular JavaScript with SystemJS and jspm&quot;</a></h1>
    <div class="post-content">
        Recently I was playing with [Aurelia](http://aurelia.io) SPA framework, which makes heavy use of jspm and SystemJS for modules/packaging. This package manager is new to me, and it looked a bit like magic sometimes. So when I saw a jspm course on Pluralsight, I decided to give it a try. And I did not regret: the course is great. It's so good, that I decided to write a brief review for it, even though I have never done that before.
    </div>
    <div class="post-goundercut">
        <a href='/2015/11/review-of-jspm-course'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/pluralsight/'>pluralsight</a>, <a href='/tags/course/'>course</a>, <a href='/tags/learning/'>learning</a>, <a href='/tags/javascript/'>javascript</a>, <a href='/tags/es2015/'>ES2015</a>, <a href='/tags/jspm/'>jspm</a>, <a href='/tags/systemjs/'>SystemJS</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Aug 11th, 2015</div>
    <h1><a href='/2015/08/units-of-measurement-in-domain-design'>Units of measurement in domain design</a></h1>
    <div class="post-content">
        If you have business application of any decent size, your most important code probably resides in domain logic. When working with 3rd party code, you can always find an answer on stack overflow or official documentation, but your domain is all yours. Try to make it as simple and readable as possible, and it will always pay you back. Today I want to discuss one aspect of writing clean domain code: units of measurement. It is important for any domain (or sub-domain) where you operate some physical measurements.
    </div>
    <div class="post-goundercut">
        <a href='/2015/08/units-of-measurement-in-domain-design'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/units-of-measurement/'>units of measurement</a>, <a href='/tags/domain-design/'>domain design</a>, <a href='/tags/ddd/'>DDD</a>, <a href='/tags/clean-code/'>clean code</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Jul 28th, 2015</div>
    <h1><a href='/2015/07/aurelia-element-animation-with-custom-attribute'>Aurelia element animation with custom attribute</a></h1>
    <div class="post-content">
        I've been exploring Aurelia javascript UI framework recently to get some experience needed for our next big project. One thing that I couldn't implement out of the box was a kind of animation. I have a grid of values bound to View Model. View Model communicates to server, receives any updates of data and the grid got immediately updated, all that works great with Aurelia. Now I want to highlight the cell which has just received an updated value with a small background animation...
    </div>
    <div class="post-goundercut">
        <a href='/2015/07/aurelia-element-animation-with-custom-attribute'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/javascript/'>javascript</a>, <a href='/tags/es2015/'>ES2015</a>, <a href='/tags/aurelia/'>Aurelia</a>, <a href='/tags/animation/'>animation</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">May 27th, 2015</div>
    <h1><a href='/2015/05/peer-code-review-whys-hows-and-whats'>Peer code review Why's, How's and What's</a></h1>
    <div class="post-content">
        This post is a short summary on why do code reviews, what the steps are and what should actually be reviewed. The text was created to set some common ground for my team, which was just starting to conduct code reviews in a consistent way. By any means, this text is not a complete guide but rather a checklist and a starting point for discussion. Get familiar with my 5 WHY's, 8 HOW's and 18 WHAT's of code review.
    </div>
    <div class="post-goundercut">
        <a href='/2015/05/peer-code-review-whys-hows-and-whats'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/code-review/'>code review</a>, <a href='/tags/best-practices/'>best practices</a>, <a href='/tags/checklist/'>checklist</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Apr 8th, 2015</div>
    <h1><a href='/2015/04/unit-testing-null-parameter-checks'>Unit testing null parameter checks</a></h1>
    <div class="post-content">
        We use constructor dependency injection throughout our application. This means that most service classes have constructors, which accept all dependencies in form of interfaces. They are then saved to private fields to be used while class methods are executed. We also use TDD, which means we must write unit tests for every aspect of our code. So I want to discuss one specific aspect: guarding the constructor parameters from null values and testing this guard.
    </div>
    <div class="post-goundercut">
        <a href='/2015/04/unit-testing-null-parameter-checks'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/unit-testing/'>unit testing</a>, <a href='/tags/dependency-injection/'>dependency injection</a>, <a href='/tags/guard/'>guard</a>, <a href='/tags/clean-code/'>clean code</a>, <a href='/tags/best-practices/'>best practices</a>, <a href='/tags/reflection/'>reflection</a>, <a href='/tags/c#/'>C#</a>, <a href='/tags/code-samples/'>code samples</a>, <a href='/tags/tdd/'>TDD</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Mar 15th, 2015</div>
    <h1><a href='/2015/03/the-green-hackfest-my-first-hackathon'>The Green Hackfest - my first hackathon</a></h1>
    <div class="post-content">
        In this post I'd like to share my experience about the first hackathon that I took part in. It was called The Green Hackfest and took place in Utrecht, the Netherlands on 10-12 October 2014. My team won a price of 1000 EURO, so read on to know what hackathon is, why you should go there, and how to score the price. And of course, pictures, pictures, pictures.
    </div>
    <div class="post-goundercut">
        <a href='/2015/03/the-green-hackfest-my-first-hackathon'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/hackathon/'>hackathon</a>, <a href='/tags/hackfest/'>hackfest</a>, <a href='/tags/challenge/'>challenge</a>, <a href='/tags/green-hackfest/'>Green Hackfest</a>, <a href='/tags/green-technologies/'>green technologies</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 17th, 2015</div>
    <h1><a href='/2015/02/how-i-fixed-a-bug-in-sql-server'>How I fixed a bug in SQL Server</a></h1>
    <div class="post-content">
        Our production databases were migrated from SQL Server 2012 to SQL Server 2014. Among other improvements in the latter, the new cardinality estimator was introduced. In two words, cardinality estimator is a piece of SQL functionality which estimates how many rows the engine might get for a specific query or a query part. The new estimator is supposed to be smarter than the old one, of course. It takes more factors into account, and thus should give better results with some query plans. But &quot;new&quot; also means &quot;less tested&quot;...
    </div>
    <div class="post-goundercut">
        <a href='/2015/02/how-i-fixed-a-bug-in-sql-server'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/sql-server/'>SQL Server</a>, <a href='/tags/execution-plan/'>execution plan</a>, <a href='/tags/query-plan/'>query plan</a>, <a href='/tags/database/'>database</a>, <a href='/tags/repro/'>repro</a>, <a href='/tags/erland-sommarskog/'>Erland Sommarskog</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 5th, 2015</div>
    <h1><a href='/2015/02/how-we-do-message-processing'>How we do message processing</a></h1>
    <div class="post-content">
        Our team develops a back-end system that processes messages from mobile devices. The devices collect information from complex machines and send messages to our data center. In this article I want to share our approaches to building such processing software. The ideas are quite general and can be applied to any system of the following architecture...
    </div>
    <div class="post-goundercut">
        <a href='/2015/02/how-we-do-message-processing'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/architecture/'>architecture</a>, <a href='/tags/design/'>design</a>, <a href='/tags/messages/'>messages</a>, <a href='/tags/message-processing/'>message processing</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Oct 16th, 2014</div>
    <h1><a href='/2014/10/16/nice-way-to-kill-your-sql-server'>Nice way to kill your SQL Server</a></h1>
    <div class="post-content">
        The short story about how to crash your complete system by missing one line of code in SQL Server stored procedure.
    </div>
    <div class="post-goundercut">
        <a href='/2014/10/16/nice-way-to-kill-your-sql-server'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/bugs/'>Bugs</a>, <a href='/tags/error-log/'>Error log</a>, <a href='/tags/sql-server/'>SQL Server</a>, <a href='/tags/sql-server-service broker/'>SQL Server Service Broker</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Jun 3rd, 2014</div>
    <h1><a href='/2014/06/03/sql-produce-resultset-with-n-rows'>SQL: produce resultset with N rows</a></h1>
    <div class="post-content">
        Sometimes you need to produce a result set, which would contain N rows with numbers 1...N in each row. For example, I needed to calculate some statistics per week for N weeks starting from today and going back to the past.
    </div>
    <div class="post-goundercut">
        <a href='/2014/06/03/sql-produce-resultset-with-n-rows'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/performance/'>performance</a>, <a href='/tags/sql-server/'>SQL Server</a>, <a href='/tags/t-sql/'>T-SQL</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">May 21st, 2014</div>
    <h1><a href='/2014/05/21/sgen-to-precompile-classes-for-xmpserializer'>Sgen to precompile classes for XmlSerializer</a></h1>
    <div class="post-content">
        During my investigation of our ASP.NET application performance issue, I've found out that XmlSerializer may require a long warm-up. The first time, when it's used for a specific class (de-)serialization, can take up to 500 ms om my machine! We use XmlSerializer to encode/decode user preferences. Having 40 different classes being deserialized at user login lead to a massive delay of 14 seconds.
    </div>
    <div class="post-goundercut">
        <a href='/2014/05/21/sgen-to-precompile-classes-for-xmpserializer'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/.net/'>.NET</a>, <a href='/tags/asp.net/'>ASP.NET</a>, <a href='/tags/c#/'>C#</a>, <a href='/tags/debugging/'>debugging</a>, <a href='/tags/msbuild/'>MSBuild</a>, <a href='/tags/performance/'>performance</a>, <a href='/tags/sgen/'>Sgen</a>, <a href='/tags/xmlserializer/'>XmlSerializer</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Jan 6th, 2013</div>
    <h1><a href='/2013/01/06/poker-money-application-for-windows-store'>Poker Money application for Windows Store</a></h1>
    <div class="post-content">
        Windows 8 / Windows RT / Windows Store all arrived in October 2012. I've decided to take a shot on writing a commercial application for this new platform. And that's how Poker Money app appeared.
    </div>
    <div class="post-goundercut">
        <a href='/2013/01/06/poker-money-application-for-windows-store'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/full-tilt-poker/'>Full Tilt Poker</a>, <a href='/tags/poker/'>Poker</a>, <a href='/tags/poker-money/'>Poker Money</a>, <a href='/tags/poker-money-application/'>Poker Money application</a>, <a href='/tags/poker-stars/'>Poker Stars</a>, <a href='/tags/windows-8/'>Windows 8</a>, <a href='/tags/windows-rt/'>Windows RT</a>, <a href='/tags/windows-store/'>Windows Store</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Dec 26th, 2012</div>
    <h1><a href='/2012/12/26/one-certificate-missing-one-received-unexpectedly'>One certificate missing, one received unexpectedly</a></h1>
    <div class="post-content">
        Today I want to give a note about two more online courses that I completed. The last one (10 weeks in September-November) was called Introduction to Computational Finance and Financial Econometrics and was lead by Eric Zivot from University of Washington. First of all, it was the most intense course out of all that I took to date.
    </div>
    <div class="post-goundercut">
        <a href='/2012/12/26/one-certificate-missing-one-received-unexpectedly'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/coursera/'>Coursera</a>, <a href='/tags/online-classes/'>Online Classes</a>, <a href='/tags/online-learning/'>Online Learning</a>, <a href='/tags/statement-of-accomplishment/'>Statement of Accomplishment</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Nov 1st, 2012</div>
    <h1><a href='/2012/11/01/finance-class-at-coursera'>Introduction to Finance class at Coursera</a></h1>
    <div class="post-content">
        I've recently received a statement of accomplishment document for Coursera's online Introduction to Finance class that I took in July-September this year.
    </div>
    <div class="post-goundercut">
        <a href='/2012/11/01/finance-class-at-coursera'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/coursera/'>Coursera</a>, <a href='/tags/finance/'>finance</a>, <a href='/tags/online-classes/'>Online Classes</a>, <a href='/tags/online-learning/'>Online Learning</a>, <a href='/tags/statement-of-accomplishment/'>Statement of Accomplishment</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Oct 29th, 2012</div>
    <h1><a href='/2012/10/29/gamification-class-at-coursera'>Gamification class at Coursera</a></h1>
    <div class="post-content">
        I've recently received a statement of accomplishment document for Coursera's online Gamification class that I took in August-October this year.
    </div>
    <div class="post-goundercut">
        <a href='/2012/10/29/gamification-class-at-coursera'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/coursera/'>Coursera</a>, <a href='/tags/gamification/'>gamification</a>, <a href='/tags/online-classes/'>Online Classes</a>, <a href='/tags/online-learning/'>Online Learning</a>, <a href='/tags/statement-of-accomplishment/'>Statement of Accomplishment</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Sep 2nd, 2012</div>
    <h1><a href='/2012/09/02/use-fiddler-to-debug-urlfetch-requests-in-google-appengine'>Use Fiddler to debug urlfetch requests in Google AppEngine</a></h1>
    <div class="post-content">
        In TripBenefit application, we use a lot of web crawling to get data from third-party websites. As the application works on top of Google AppEngine, the urlfetch.fetch() function is used to send HTTP requests and get responses. Some crawling is not as easy as just a simple GET request, so we have to send specific POST data, cookies and HTTP headers. And all this needs to be debugged. Fiddler2 is the gold standard for web debugging tools, so I'd like to use it in this case too. I.e. I want to see urlfetch requests displayed in Fiddler, while I'm on development env.
    </div>
    <div class="post-goundercut">
        <a href='/2012/09/02/use-fiddler-to-debug-urlfetch-requests-in-google-appengine'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/appengine/'>AppEngine</a>, <a href='/tags/debugging/'>debugging</a>, <a href='/tags/fiddler/'>Fiddler</a>, <a href='/tags/google-appengine/'>Google AppEngine</a>, <a href='/tags/python/'>Python</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Aug 14th, 2012</div>
    <h1><a href='/2012/08/14/google-adds-public-transit-into-api'>Google adds Public Transit into API</a></h1>
    <div class="post-content">
        Now, both Google Directions Web Services and Google Maps JavaScript API include building the routes with Public Transit.
    </div>
    <div class="post-goundercut">
        <a href='/2012/08/14/google-adds-public-transit-into-api'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/google-maps/'>Google Maps</a>, <a href='/tags/google-transit/'>Google Transit</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Jul 26th, 2012</div>
    <h1><a href='/2012/07/26/enable-jinja2-and-i18n-translations-on-google-appengine'>Enable jinja2 and i18n translations on Google AppEngine</a></h1>
    <div class="post-content">
        My initial goal was to make our new application (based on python/AppEngine) translatable. This means the following requirements: (1) All strings in the application must be translatable (2) Translations should preferably stored in separate files (3) It should be easy to use the translations both in .py files and html templates
    </div>
    <div class="post-goundercut">
        <a href='/2012/07/26/enable-jinja2-and-i18n-translations-on-google-appengine'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/appengine/'>AppEngine</a>, <a href='/tags/i18n/'>i18n</a>, <a href='/tags/jinja2/'>jinja2</a>, <a href='/tags/python/'>Python</a>, <a href='/tags/translations/'>Translations</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Jun 21st, 2012</div>
    <h1><a href='/2012/06/21/model-thinking-class-at-coursera'>Model Thinking class at Coursera</a></h1>
    <div class="post-content">
        I've recently received a statement of accomplishment document for Coursera's online Model Thinking Class that I took in April-May this year.
    </div>
    <div class="post-goundercut">
        <a href='/2012/06/21/model-thinking-class-at-coursera'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/coursera/'>Coursera</a>, <a href='/tags/model-thinking/'>Model Thinking</a>, <a href='/tags/online-classes/'>Online Classes</a>, <a href='/tags/online-learning/'>Online Learning</a>, <a href='/tags/statement-of-accomplishment/'>Statement of Accomplishment</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">May 17th, 2012</div>
    <h1><a href='/2012/05/17/api-to-get-the-list-of-hotels'>API to get the list of hotels</a></h1>
    <div class="post-content">
        In our travelling application, we need to show the list of hotels in a city (St. Petersburg, Russia at the moment, but more will be needed in the future). The idea was to find a hotel information provider, and then upload the complete list into our own database.
    </div>
    <div class="post-goundercut">
        <a href='/2012/05/17/api-to-get-the-list-of-hotels'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/hotels-api/'>Hotels API</a>, <a href='/tags/hotelscombined/'>HotelsCombined</a>, <a href='/tags/public-api/'>Public API</a>, <a href='/tags/python/'>Python</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">May 16th, 2012</div>
    <h1><a href='/2012/05/16/books-that-ive-recently-read-part-2'>Books that Ive recently read, part 2</a></h1>
    <div class="post-content">
        Reviews of &quot;Rework&quot; by Jason Fried and David Heinemeier Hansson, &quot;Don't Make Me Think&quot; by Steve Krug, &quot;The Non-Designer's Design Book&quot; by Robin Williams and &quot;The Toilet Paper Entrepreneur&quot; by Mike Michaliwicz.
    </div>
    <div class="post-goundercut">
        <a href='/2012/05/16/books-that-ive-recently-read-part-2'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/books/'>Books</a>, <a href='/tags/business-books/'>Business books</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Apr 10th, 2012</div>
    <h1><a href='/2012/04/10/google-transit-api-research'>Google Transit API research</a></h1>
    <div class="post-content">
        Recently, Google has launch a Transit service for the biggest cities of Russia: a service to caculate routes with public transport options. As a part of RnD for upcoming project, I need to understand whether there's any feasible way to calculate public transport route programmatically. I.e. I need Google Transit API.
    </div>
    <div class="post-goundercut">
        <a href='/2012/04/10/google-transit-api-research'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/api/'>API</a>, <a href='/tags/google-maps/'>Google Maps</a>, <a href='/tags/google-transit/'>Google Transit</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Mar 13th, 2012</div>
    <h1><a href='/2012/03/13/multi-level-teleriks-tileview'>Multi-level telerik's TileView</a></h1>
    <div class="post-content">
        We were investigating the options for visual representation of hierarchical dashboard in our Silverlight application. This means, we want to display the number of gauges with tree-like structure. Here is a sample...
    </div>
    <div class="post-goundercut">
        <a href='/2012/03/13/multi-level-teleriks-tileview'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/c#/'>C#</a>, <a href='/tags/silverlight/'>Silverlight</a>, <a href='/tags/telerik/'>Telerik</a>, <a href='/tags/tileview/'>TileView</a>, <a href='/tags/user-contol/'>User Contol</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Mar 1st, 2012</div>
    <h1><a href='/2012/03/01/books-that-ive-recently-read'>Books that I've recently read</a></h1>
    <div class="post-content">
        My reviews of &quot;Steve Jobs&quot; by Walter Isaacson, &quot;The Art of the Start&quot; by Guy Kawasaki, &quot;How to Become a Businessman&quot; and &quot;I'm Just Like Anyone Else&quot; by Oleg Tinkov.
    </div>
    <div class="post-goundercut">
        <a href='/2012/03/01/books-that-ive-recently-read'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/books/'>Books</a>, <a href='/tags/business-books/'>Business books</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 28th, 2012</div>
    <h1><a href='/2012/02/28/gauge-control-with-two-values-silverlight'>Gauge control with two values (Silverlight)</a></h1>
    <div class="post-content">
        While developing the dashboard to display several performance indexes, I bumped into the task of visualizing the pair of numbers on a single gauge. One number would show a person's performance metric, while the other one would display the person group's performance indicator to compare with. I couldn't find a ready control to use, so I decided to design my own.
    </div>
    <div class="post-goundercut">
        <a href='/2012/02/28/gauge-control-with-two-values-silverlight'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/gauge-control/'>gauge control</a>, <a href='/tags/silverlight/'>Silverlight</a>, <a href='/tags/user-control/'>User Control</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 5th, 2012</div>
    <h1><a href='/2012/02/05/hunting-memory-leaks-in-silverlight'>Hunting memory leaks in Silverlight</a></h1>
    <div class="post-content">
        Recently, I've spent a couple of days seeking and fixing memory leaks in our Silverlight application. It might be tough sometimes, but it's a good 'brain-teasing' practice and it's a good way to learn how inner things work.
    </div>
    <div class="post-goundercut">
        <a href='/2012/02/05/hunting-memory-leaks-in-silverlight'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/c#/'>C#</a>, <a href='/tags/fixing-memory-leaks/'>fixing memory leaks</a>, <a href='/tags/memory-leaks/'>Memory leaks</a>, <a href='/tags/silverlight/'>Silverlight</a>, <a href='/tags/windbg/'>WinDbg</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Feb 1st, 2012</div>
    <h1><a href='/2012/02/01/machine-learning-class-at-stanford-online'>Machine Learning class at Stanford online</a></h1>
    <div class="post-content">
        Several days ago, I've received a Statement of Accomplishment document from Andrew Ng and Machine Learning online class team.
    </div>
    <div class="post-goundercut">
        <a href='/2012/02/01/machine-learning-class-at-stanford-online'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/machine-learning/'>Machine Learning</a>, <a href='/tags/online-classes/'>Online Classes</a>, <a href='/tags/online-learning/'>Online Learning</a>, <a href='/tags/stanford/'>Stanford</a>, <a href='/tags/statement-of-accomplishment/'>Statement of Accomplishment</a>
    </div>
    
</article>

    <article class="post">
    <div class="post-date">Jan 26th, 2012</div>
    <h1><a href='/2012/01/26/speech-bubble-control-in-sl'>Speech bubble custom border control in Silverlight</a></h1>
    <div class="post-content">
        Recently, I was trying to find a Silverlight control, which works like a standard Border, but looks like a Speech Bubble instead. This means the border would have a &quot;leader&quot; triangle, which could point to a related visual element.
    </div>
    <div class="post-goundercut">
        <a href='/2012/01/26/speech-bubble-control-in-sl'>Read further</a>
    </div>

    
    <div class="post-tags">
        Posted In: <a href='/tags/c#/'>C#</a>, <a href='/tags/silverlight/'>Silverlight</a>, <a href='/tags/speech-bubble/'>Speech Bubble</a>, <a href='/tags/user-control/'>User Control</a>, <a href='/tags/wpf/'>WPF</a>
    </div>
    
</article>


<div id="me">
    <p itemscope itemtype="http://data-vocabulary.org/Person">
        <img src="/images/Headshot-Square.jpg" alt="Mikhail Shilkov" itemprop="photo" />
        I'm <b><span itemprop="name">Mikhail Shilkov</span></b>, a <span itemprop="title">software developer</span>. I enjoy C#, Javascript and SQL development and I blog about my experience on this website.
    </p>
    <p>
        <a href="https://www.linkedin.com/in/mikhailshilkov/">LinkedIn</a> &#8226;
        <a href="http://twitter.com/mikhailshilkov">@mikhailshilkov</a> &#8226;
        <a href="https://github.com/mikhailshilkov">GitHub</a> &#8226;
        <a href="http://stackoverflow.com/users/1171619/mikhail">Stack Overflow</a>
    </p>
</div>

</div>
<div class="container">
    <div class="navbar navbar-footer">
        <p class="navbar-center navbar-text">Content copyright &copy; 2015 Mikhail Shilkov</p>
    </div>
</div>



<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script>
<script src="/vendor/highlight.pack.js"></script>
<script src="/site.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59218480-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>