<!DOCTYPE html>
<html lang="en-us" prefix="og: http://ogp.me/ns#"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	
	<link rel="icon" type="image/png" href="/favicon.ico">
	
	
	<title>Unit Testing Cloud Deployments with Pulumi in F# | Mikhail Shilkov</title>
	
	
	
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
	
	<link rel="stylesheet" href="/sass/main.css">

	
	<link rel="canonical" href="https://www.pulumi.com/blog/unit-testing-cloud-deployments-with-dotnet/">
	
	
	<meta property="og:title" content="Unit Testing Cloud Deployments with Pulumi in F#" />
	<meta property="og:description" content="Developing infrastructure programs in F# with unit tests, TDD, and mocks" />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="https://mikhail.io/2020/05/unit-testing-cloud-deployments-with-pulumi-in-fsharp/" />

	
	
	
	
	<meta property="og:image" content="https://mikhail.io/2020/05/unit-testing-cloud-deployments-with-pulumi-in-fsharp/dotnet-testing.png" />
	
	


	
	
	<meta property="article:tag" content="Pulumi" />
	
	<meta property="article:tag" content="Unit Testing" />
	
	<meta property="article:tag" content="TDD" />
	
	<meta property="article:tag" content="FSharp" />
	

	
	
	<meta name="twitter:card" content="summary_large_image"/>
	
	<meta name="twitter:image" content="https://mikhail.io/2020/05/unit-testing-cloud-deployments-with-pulumi-in-fsharp/dotnet-testing.png" />
	
	

	<meta name="twitter:title" content="Unit Testing Cloud Deployments with Pulumi in F#"/>
	<meta name="twitter:description" content="Developing infrastructure programs in F# with unit tests, TDD, and mocks"/>
	<meta name="twitter:creator" content="@MikhailShilkov"></meta>
</head>
<body><script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load("current", {packages:["corechart"]});
    function addChart(make) {
        google.charts.setOnLoadCallback(drawChart);
        function drawChart() {
            const data = new google.visualization.DataTable();

            const options = {
                height: 420,  
                chartArea: { width: '85%', height: '70%' },
                legend: 'none',
                hAxis: { minValue: 0 },
                vAxis: {},
                series: {      
                    0: { tooltip : false}
                }
            };
            const chart = make(data, options);
            options.hAxis.textStyle = options.hAxis.titleTextStyle 
                = options.vAxis.textStyle = options.vAxis.titleTextStyle = { fontName: 'Merriweather' };

            chart.draw(data, options);
        }
    }
</script>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container pr-0">
        <a class="navbar-brand" href="/">
            <img class="author-thumb" src="/images/author.jpg" alt="Mikhail Shilkov">
            <span class="text-primary">Mikhail Shilkov</span>
        </a>

        
               


        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        
        <div class="collapse navbar-collapse" id="navbarMediumish">
            
            <ul class="navbar-nav ml-auto">
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">TOPICS</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/archives/">ARCHIVES</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/talks/">TALKS</a>
                </li>
                 
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">ABOUT</a>
                </li>
                <li class="nav-item">
    <a class="nav-link" href="https://mikhail.io/feed/"><i class="fas fa-rss social-icon" aria-hidden="true"></i></a>
</li>

<li class="nav-item">
    <a class="nav-link" href="https://www.twitter.com/MikhailShilkov"><i class="fab fa-twitter social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://dev.to/mikhailshilkov"><i class="fab fa-dev social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://medium.com/@MikhailShilkov"><i class="fab fa-medium social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://github.com/MikhailShilkov"><i class="fab fa-github social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/MikhailShilkov"><i class="fab fa-linkedin social-icon" aria-hidden="true"></i></a>
</li>

</ul>
        </div>
        
    </div>
</nav>


        <div class="container">

<div class="main-content">
    
    <div class="container">
        <div class="row">
            
            <div class="col-lg-2 pl-0"><div class="share">
    <ul>
        <li class="ml-1 mr-1" title="Say 'Thank You' for this article">
            <a href="#" onclick="heart();return false;">
                <i class="fas fa-heart" style="color: red"></i>
            </a>
            <div class="count" style="float: right; padding-left: .5em; padding-top: .25em" id="heartcount"></div>
        </li>

        <li class="ml-1 mr-1" title="Tweet this article">
            <a target="_blank"
                href="https://twitter.com/intent/tweet?text=Unit%20Testing%20Cloud%20Deployments%20with%20Pulumi%20in%20F%23%20by%20@MikhailShilkov&url=https%3a%2f%2fmikhail.io%2f2020%2f05%2funit-testing-cloud-deployments-with-pulumi-in-fsharp%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=435');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1" title="See the responses or write a response">
            <a href="#comments">
                <i class="fas fa-comment"></i>
            </a>
        </li>
    </ul>
</div></div>
            
            <div class="col-lg-9 flex-first flex-lg-unordered">

                <div class="mainheading">
                    
                    <h1 class="posttitle">Unit Testing Cloud Deployments with Pulumi in F#</h1>
                    
                    <div class="post-top-meta">
                        <div>
                            
                                
                                <span class="post-date">Originally published on the <a
                                        href='https://www.pulumi.com/blog/unit-testing-cloud-deployments-with-dotnet/'>Pulumi Blog</a> on
                                    May 21, 2020
                                
                            
                            
                        &nbsp;&middot;&nbsp; 12 min read</span></span>
                        </div>
                    </div>
                </div>
                
                
                

                
                <div class="article-post">
                    <p>Because Pulumi uses general-purpose programming languages to provision cloud resources, you can take advantage of native tools and perform automated tests of your infrastructure. The full power of each language is available, including access to libraries and frameworks for testing.</p>
<p>This blog post takes a deeper dive into mock-based unit testing of Pulumi programs written in F#. You can find a C# version of this blog post <a href="/2020/05/unit-testing-cloud-deployments-with-pulumi-in-csharp/">here</a>.</p>
<h2 id="how-unit-testing-works-in-pulumi">How Unit Testing Works in Pulumi</h2>
<p>Let&rsquo;s start with a picture showing how Pulumi components interact during a typical deployment process.</p>
<p><img src="./engine.png" alt="Pulumi Components Interaction"></p>
<p>Whenever a new resource is instantiated in code, the program makes a remote call to the engine. The engine receives the resource&rsquo;s input values, validates them, and translates the request to an invocation of a cloud API. The API returns some data, which are translated to resource outputs and sent back to the program.</p>
<p>The remote calls may be slow, unreliable, and non-deterministic, which makes testing of these interactions hard.</p>
<p>Our <a href="https://www.pulumi.com/docs/guides/testing/">testing guide</a> outlines several testing methods, but today I want to focus on unit testing.</p>
<p>The Pulumi SDK provides a hook to replace all the remote calls with mocks. Mocks run in the same process and can respond immediately with hard-coded or calculated on-the-fly data.</p>
<p><img src="./mocks.png" alt="Pulumi with Mocks"></p>
<p>We can write fully deterministic and blazingly fast automated tests as all remote calls and uncertainty are eliminated. There is no cloud to respond to resource creation, so it&rsquo;s a developer&rsquo;s responsibility to mimic the cloud behavior with mocks adequately.</p>
<p>This blog post walks you through an example of unit testing and mocking with the .NET SDK.</p>
<h2 id="define-the-base-structure">Define the Base Structure</h2>
<p>In this article, I build a program that deploys a static website to Azure. I use TDD to add new tests and deployment components bit-by-bit.</p>
<p>Let&rsquo;s start with an empty project—go ahead and create a .NET Core Console Application with the .NET CLI or your favorite IDE.</p>
<h3 id="install-nuget-packages">Install NuGet packages</h3>
<p>You are free to choose your unit testing frameworks, mocking and assertions libraries. I&rsquo;m using NUnit with FluentAssertions, and my program tests Azure resources, so this is my project file:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">&lt;Project Sdk=<span style="color:#a31515">&#34;Microsoft.NET.Sdk&#34;</span>&gt;

    &lt;PropertyGroup&gt;
        &lt;OutputType&gt;Exe&lt;/OutputType&gt;
        &lt;TargetFramework&gt;netcoreapp3.1&lt;/TargetFramework&gt;
        &lt;Nullable&gt;enable&lt;/Nullable&gt;
    &lt;/PropertyGroup&gt;

    &lt;ItemGroup&gt;
        &lt;PackageReference Include=<span style="color:#a31515">&#34;FluentAssertions&#34;</span> Version=<span style="color:#a31515">&#34;5.10.2&#34;</span> /&gt;
        &lt;PackageReference Include=<span style="color:#a31515">&#34;Microsoft.NET.Test.Sdk&#34;</span> Version=<span style="color:#a31515">&#34;16.5.0&#34;</span> /&gt;
        &lt;PackageReference Include=<span style="color:#a31515">&#34;NUnit&#34;</span> Version=<span style="color:#a31515">&#34;3.12.0&#34;</span> /&gt;
        &lt;PackageReference Include=<span style="color:#a31515">&#34;NUnit3TestAdapter&#34;</span> Version=<span style="color:#a31515">&#34;3.16.1&#34;</span> /&gt;
        &lt;PackageReference Include=<span style="color:#a31515">&#34;Pulumi.Azure&#34;</span> Version=<span style="color:#a31515">&#34;3.*&#34;</span> /&gt;
        &lt;PackageReference Include=<span style="color:#a31515">&#34;Pulumi.FSharp&#34;</span> Version=<span style="color:#a31515">&#34;2.*&#34;</span> /&gt;
    &lt;/ItemGroup&gt;

    &lt;ItemGroup&gt;
        &lt;Compile Include=<span style="color:#a31515">&#34;Testing.fs&#34;</span> /&gt;
        &lt;Compile Include=<span style="color:#a31515">&#34;WebsiteStack.fs&#34;</span> /&gt;
        &lt;Compile Include=<span style="color:#a31515">&#34;WebsiteStackTests.fs&#34;</span> /&gt;
    &lt;/ItemGroup&gt;

&lt;/Project&gt;
</code></pre></div><h3 id="stack">Stack</h3>
<p>A Pulumi stack is the &ldquo;unit&rdquo; of our testing. Every test instantiates a stack, retrieves the resources that the stack defines, and makes assertions about them.</p>
<p>Here is my starting point in <code>WebsiteStack.fs</code> file:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">namespace</span> UnitTesting

<span style="color:#00f">open</span> Pulumi
<span style="color:#00f">open</span> Pulumi.FSharp
<span style="color:#00f">open</span> Pulumi.Azure.Core

<span style="color:#00f">type</span> <span style="color:#2b91af">WebsiteStack</span>() =
    <span style="color:#00f">inherit</span> Stack()

    <span style="color:#008000">// &lt;-- Cloud resources go here
</span></code></pre></div><p>This class is precisely what Pulumi expects to start deploying your resources to the cloud. Once the test suite is ready and green, you can deploy the stack with <code>pulumi up</code>.</p>
<h3 id="mocks">Mocks</h3>
<p>As I explained above, unit tests replace the real Pulumi engine with mocks. Mocks get all calls and respond with predefined values.</p>
<p>A mock class has to implement two methods of <code>Pulumi.Testing.IMocks</code> interface. <code>NewResourceAsync</code> is called whenever a new resource is defined, while <code>CallAsync</code> is invoked when our program retrieves information about existing cloud resources. We&rsquo;ll focus on the former in this post, but we still need to define both.</p>
<p>While you are free to use your favorite mocking library, I&rsquo;ll keep it simple and define the mocks as a plain class.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">namespace</span> UnitTesting

<span style="color:#00f">open</span> System
<span style="color:#00f">open</span> System.Collections.Immutable
<span style="color:#00f">open</span> System.Threading.Tasks
<span style="color:#00f">open</span> Pulumi.Testing

<span style="color:#00f">type</span> <span style="color:#2b91af">Mocks</span>() =
    <span style="color:#00f">interface</span> IMocks <span style="color:#00f">with</span>
        <span style="color:#00f">member</span> this.NewResourceAsync(typeName: <span style="color:#2b91af">string</span>, name: <span style="color:#2b91af">string</span>, inputs: ImmutableDictionary&lt;<span style="color:#2b91af">string</span>, <span style="color:#2b91af">obj</span>&gt;, provider: <span style="color:#2b91af">string</span>, id: <span style="color:#2b91af">string</span>): Task&lt;ValueTuple&lt;<span style="color:#2b91af">string</span>,<span style="color:#2b91af">obj</span>&gt;&gt; =
            <span style="color:#008000">// Forward all input parameters as resource outputs, so that we could test them.
</span><span style="color:#008000"></span>            <span style="color:#00f">let</span> dict = inputs.ToImmutableDictionary() :&gt; <span style="color:#2b91af">obj</span>

            <span style="color:#008000">// &lt;-- We&#39;ll customize the mocks here
</span><span style="color:#008000"></span>
            <span style="color:#008000">// Default the resource ID to `{name}_id`.
</span><span style="color:#008000"></span>            <span style="color:#00f">let</span> id = <span style="color:#00f">if</span> id = <span style="color:#00f">null</span> <span style="color:#00f">then</span> sprintf <span style="color:#a31515">&#34;%s_id&#34;</span> name <span style="color:#00f">else</span> id
            Task.FromResult(<span style="color:#00f">struct</span> (id, outputs :&gt; <span style="color:#2b91af">obj</span>))

        <span style="color:#00f">member</span> this.CallAsync(token: <span style="color:#2b91af">string</span>, inputs: ImmutableDictionary&lt;<span style="color:#2b91af">string</span>, <span style="color:#2b91af">obj</span>&gt;, provider: <span style="color:#2b91af">string</span>): Task&lt;<span style="color:#2b91af">obj</span>&gt; =
            <span style="color:#008000">// We don&#39;t use this method in this particular test suite.
</span><span style="color:#008000"></span>            <span style="color:#008000">// Default to returning whatever we got as input.
</span><span style="color:#008000"></span>            Task.FromResult(<span style="color:#00f">null</span> :&gt; <span style="color:#2b91af">obj</span>)
</code></pre></div><p>Both methods receive several parameters and need to return a result. Notably, they get the list of <code>inputs</code>—the arguments that our program defined for the given resource. The goal of the mocks is to return the list of outputs, similarly to what a cloud provider would do.</p>
<p>My default implementation returns the outputs that include all the inputs and nothing else. That&rsquo;s a sensible default: usually, real outputs are a superset of inputs. We&rsquo;ll extend this behavior as we need later on.</p>
<h3 id="test-fixture">Test Fixture</h3>
<p>The next class to add is the container for my future unit tests. I named the file <code>WebsiteStackTests.fs</code> and it defines a test container, called a &ldquo;test fixture&rdquo; in NUnit:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">namespace</span> UnitTesting

<span style="color:#00f">open</span> System
<span style="color:#00f">open</span> System.Collections.Immutable
<span style="color:#00f">open</span> System.Threading.Tasks
<span style="color:#00f">open</span> NUnit.Framework
<span style="color:#00f">open</span> FluentAssertions
<span style="color:#00f">open</span> Pulumi
<span style="color:#00f">open</span> Pulumi.Azure.Core
<span style="color:#00f">open</span> Pulumi.Azure.Storage
<span style="color:#00f">open</span> Pulumi.Testing

[&lt;TestFixture&gt;]
<span style="color:#00f">type</span> <span style="color:#2b91af">WebserverStackTests</span>() =
    <span style="color:#00f">let</span> runTest(): ImmutableArray&lt;Resource&gt; =
        <span style="color:#00f">let</span> options = <span style="color:#00f">new</span> TestOptions(IsPreview = Nullable&lt;<span style="color:#2b91af">bool</span>&gt; <span style="color:#00f">false</span>)
        Deployment.TestAsync&lt;WebsiteStack&gt;(<span style="color:#00f">new</span> Mocks(), options)
        |&gt; Async.AwaitTask
        |&gt; Async.RunSynchronously

    <span style="color:#008000">// &lt;-- Tests go here
</span></code></pre></div><p>I defined a helper method <code>TestAsync</code> that points Pulumi&rsquo;s <code>Deployment.TestAsync</code> to our stack and mock classes.</p>
<p>As we progress through the article, I will add tests to this class one-by-one.</p>
<h3 id="retrieve-output-values">Retrieve output values</h3>
<p>Finally, I need a small extension method to extract values from outputs. Every Pulumi resource returns values wrapped inside an <code>Output&lt;T&gt;</code> container. While the real engine runs, those values may be known or unknown, but my mock-based tests always return known values. It&rsquo;s safe to get those values and convert them to a <code>Task&lt;T&gt;</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">let</span> getValue(output: Output&lt;<span style="color:#00f">&#39;</span>a&gt;): <span style="color:#00f">&#39;</span>a =
    <span style="color:#00f">let</span> tcs = <span style="color:#00f">new</span> TaskCompletionSource&lt;<span style="color:#00f">&#39;</span>a&gt;()
    output.Apply(<span style="color:#00f">fun</span> v -&gt; tcs.SetResult(v); v) |&gt; ignore
    tcs.Task.Result
</code></pre></div><p>To learn more about outputs, read <a href="https://www.pulumi.com/docs/intro/concepts/programming-model/#stack-outputs">this article</a>.</p>
<h2 id="first-test">First Test</h2>
<p>The setup is done, time to write my first unit test! True to the TDD spirit, I write the tests before I define any resources.</p>
<p>Every Azure resource has to live inside a resource group, so my first test checks that a new resource group is defined.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp">[&lt;Test&gt;]
<span style="color:#00f">member</span> this.SingleResourceGroupExists() =
    <span style="color:#00f">let</span> resources = runTest()

    <span style="color:#00f">let</span> resourceGroupCount = resources.OfType&lt;ResourceGroup&gt;() |&gt; Seq.length
    resourceGroupCount.Should().Be(1, <span style="color:#a31515">&#34;a single resource group is expected&#34;</span>) |&gt; ignore
</code></pre></div><p>This code is great to illustrate the overall structure of each test:</p>
<ol>
<li>Call the <code>TestAsync</code> method to evaluate the stack.</li>
<li>Find the target resource in the collection of created resources.</li>
<li>Assert a property of the target resource.</li>
</ol>
<p>In this case, the test validates that there is one and only one resource group defined.</p>
<p>I can run <code>dotnet test</code> and see the expected test failure:</p>
<pre><code>$ dotnet test
...

X SingleResourceGroupExists [238ms]
  Error Message:
   Expected resourceGroups.Count to be 1 because a single resource group is expected, but found 0.
...
Total tests: 1
     Failed: 1
 Total time: 0.9270 Seconds
</code></pre><p>I go ahead and add the following definition to the <code>WebsiteStack</code> constructor.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">let</span> resourceGroup = <span style="color:#00f">new</span> ResourceGroup(<span style="color:#a31515">&#34;www-prod-rg&#34;</span>)
</code></pre></div><p>This change is enough to make the tests green!</p>
<pre><code>$ dotnet test
...
Test Run Successful.
Total tests: 1
     Passed: 1
 Total time: 0.8462 Seconds
</code></pre><h2 id="tags">Tags</h2>
<p>For billing and lifecycle management, I want all my resource groups to be tagged. Therefore, my second test validates that the resource group has an <code>Environment</code> tag on it:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp">[&lt;Test&gt;]
<span style="color:#00f">member</span> this.ResourceGroupHasEnvironmentTag() =
    <span style="color:#00f">let</span> resources = runTest()
    <span style="color:#00f">let</span> resourceGroup = resources.OfType&lt;ResourceGroup&gt;() |&gt; Seq.head

    <span style="color:#00f">let</span> tags = getValue resourceGroup.Tags
    tags.Should().NotBeNull(<span style="color:#a31515">&#34;Tags must be defined&#34;</span>) |&gt; ignore
    tags.Should().ContainKey(<span style="color:#a31515">&#34;Environment&#34;</span>, <span style="color:#00f">null</span>) |&gt; ignore
</code></pre></div><p>The test finds the resource group and then checks that the <code>Tags</code> dictionary is not null and contains a tag with the name <code>Environment</code>. Predictably, the test fails:</p>
<pre><code>$ dotnet test
...
  X ResourceGroupHasEnvironmentTag [240ms]
  Error Message:
   Expected tags not to be &lt;null&gt; because Tags must be defined.
...
Test Run Failed.
</code></pre><p>Now, I edit the stack class and change the resource group definition.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">let</span> resourceGroup =
    <span style="color:#00f">new</span> ResourceGroup(
        <span style="color:#a31515">&#34;www-prod-rg&#34;</span>,
        <span style="color:#00f">new</span> ResourceGroupArgs(Tags = inputMap([<span style="color:#a31515">&#34;Environment&#34;</span>, input <span style="color:#a31515">&#34;production&#34;</span>])))
</code></pre></div><p>This change makes the test suite green again, and we are good to proceed.</p>
<h2 id="storage-account">Storage Account</h2>
<p>It&rsquo;s time to add a test for a second resource in the stack: a Storage Account. To make things more interesting, I want to check that the storage account belongs to our resource group.</p>
<p>There&rsquo;s no direct link between a storage account object and a resource group object. Instead, we need to check the <code>ResourceGroupName</code> property of the account. The test below expects the account to belong to a resource group called <code>www-prod-rg</code>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp">[&lt;Test&gt;]
<span style="color:#00f">member</span> this.StorageAccountBelongsToResourceGroup() =
    <span style="color:#00f">let</span> resources = runTest()
    <span style="color:#00f">let</span> storageAccount = resources.OfType&lt;Account&gt;() |&gt; Seq.tryHead |&gt; Option.toObj
    storageAccount.Should().NotBeNull(<span style="color:#a31515">&#34;Storage account not found&#34;</span>) |&gt; ignore

    <span style="color:#00f">let</span> resourceGroupName = getValue storageAccount.ResourceGroupName
    resourceGroupName.Should().Be(<span style="color:#a31515">&#34;www-prod-rg&#34;</span>, <span style="color:#00f">null</span>) |&gt; ignore
</code></pre></div><p>Of course, the test fails. I try to fix it with what I think is the minimal change to make the test pass by adding a new resource to the stack and pointing it to the resource group.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">let</span> storageAccount =
    <span style="color:#00f">new</span> Account(
        <span style="color:#a31515">&#34;wwwprodsa&#34;</span>,
        <span style="color:#00f">new</span> AccountArgs(ResourceGroupName = io resourceGroup.Name))
</code></pre></div><p>However, when I rerun the test suite, all three tests fail. They complain about the missing required properties <code>AccountReplicationType</code> and <code>AccountTier</code> on the storage account, so I have to add those.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">let</span> storageAccount =
    <span style="color:#00f">new</span> Account(
        <span style="color:#a31515">&#34;wwwprodsa&#34;</span>,
        <span style="color:#00f">new</span> AccountArgs(
            ResourceGroupName = io resourceGroup.Name,
            AccountTier = input <span style="color:#a31515">&#34;Standard&#34;</span>,
            AccountReplicationType = input <span style="color:#a31515">&#34;LRS&#34;</span>,
            StaticWebsite = input (<span style="color:#00f">new</span> AccountStaticWebsiteArgs(IndexDocument = input <span style="color:#a31515">&#34;index.html&#34;</span>))))
</code></pre></div><p>I defined the <code>StaticWebsite</code> property as well: I&rsquo;ll leave testing these values as an exercise for the reader.</p>
<p>Two resource group tests are back to green again, but the storage account test fails with a new error message.</p>
<pre><code>X StorageAccountBelongsToResourceGroup [84ms]
  Error Message:
   Expected resourceGroupName to be &quot;www-prod-rg&quot;, but found &lt;null&gt;.
</code></pre><p>What&rsquo;s going on, and why is it <code>null</code>?</p>
<p>I defined the account name like this: <code>ResourceGroupName = resourceGroup.Name</code>. However, if we look closely, the <code>resourceGroup</code> resource doesn&rsquo;t have an input property <code>Name</code> defined. <code>www-prod-rg</code> is a logical name for Pulumi deployment, not the physical name of the resource.</p>
<p>Under normal circumstances, the Pulumi engine would use the logical name to produce the physical name of the resource group automatically (see <a href="https://www.pulumi.com/docs/intro/concepts/programming-model/#names">resource names</a> for details). However, my mocks don&rsquo;t do that.</p>
<p>That&rsquo;s a good reason to change the <code>Mocks</code> implementation. I add the following lines to the <code>NewResourceAsync</code> method.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">let</span> inputKVs = inputs |&gt; Seq.map(<span style="color:#00f">fun</span> kv -&gt; kv.Key, kv.Value) |&gt; Seq.toList
<span style="color:#00f">let</span> nameKVs = <span style="color:#00f">if</span> inputs.ContainsKey(<span style="color:#a31515">&#34;name&#34;</span>) <span style="color:#00f">then</span> [] <span style="color:#00f">else</span> [(<span style="color:#a31515">&#34;name&#34;</span>, name :&gt; <span style="color:#2b91af">obj</span>)]

<span style="color:#00f">let</span> outputs = [inputKVs; nameKVs] |&gt; Seq.concat |&gt; Seq.map KeyValuePair
<span style="color:#00f">let</span> dict = outputs.ToImmutableDictionary() :&gt; <span style="color:#2b91af">obj</span>
</code></pre></div><p>Note that mocks operate on weakly-typed dictionaries, so I need to get the property name right. Pulumi SDKs are open source, so I looked <a href="https://github.com/pulumi/pulumi-azure/blob/1fdcab88065175ced768d900e7dcedf3b1d1b0a7/sdk/dotnet/Core/ResourceGroup.cs#L90">here</a> to double-check the exact value.</p>
<p>After this change in <code>Mocks</code>, my tests go green again.</p>
<pre><code>Test Run Successful.
Total tests: 3
     Passed: 3
</code></pre><h2 id="website-files">Website Files</h2>
<p>The next step is to upload some files to the static website. Well, instead, to write an automated test that validates the upload with mocks.</p>
<p>I create a <code>wwwroot</code> folder with two HTML files in it and copy the folder to the build&rsquo;s output. Here is my change in the project file.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">&lt;ItemGroup&gt;
    &lt;None Update=<span style="color:#a31515">&#34;wwwroot\**\*.*&#34;</span>&gt;
        &lt;CopyToOutputDirectory&gt;PreserveNewest&lt;/CopyToOutputDirectory&gt;
    &lt;/None&gt;
&lt;/ItemGroup&gt;
</code></pre></div><p>Now, the test is straightforward: it expects two <code>Blob</code> resources in the stack.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp">[&lt;Test&gt;]
<span style="color:#00f">member</span> this.UploadsTwoFiles() =
    <span style="color:#00f">let</span> resources = runTest()
    <span style="color:#00f">let</span> filesCount = resources.OfType&lt;Blob&gt;() |&gt; Seq.length
    filesCount.Should().Be(2, <span style="color:#a31515">&#34;Should have uploaded files from `wwwroot`&#34;</span>) |&gt; ignore
</code></pre></div><p>As intended, the test fails immediately.</p>
<pre><code>X UploadsTwoFiles [95ms]
  Error Message:
   Expected files.Count to be 2 because Should have uploaded files from `wwwroot`, but found 0.
</code></pre><p>I extend my stack with the following loop that navigates through the files and creates a storage blob for each of them.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">let</span> files =
    <span style="color:#00f">let</span> fileNames = Directory.GetFiles(<span style="color:#a31515">&#34;wwwroot&#34;</span>)
    fileNames
    |&gt; Seq.map(<span style="color:#00f">fun</span> file -&gt;
        <span style="color:#00f">new</span> Blob(
            file,
            <span style="color:#00f">new</span> BlobArgs(
                ContentType = input <span style="color:#a31515">&#34;application/html&#34;</span>,
                Source = input (<span style="color:#00f">new</span> FileAsset(file) :&gt; AssetOrArchive),
                StorageAccountName = io storageAccount.Name,
                StorageContainerName = input <span style="color:#a31515">&#34;$web&#34;</span>,
                Type = input <span style="color:#a31515">&#34;Block&#34;</span>)))
    |&gt; List.ofSeq
</code></pre></div><p>However, this change breaks the stack and all tests in the suite:</p>
<pre><code>Error Message:
   Pulumi.RunException : Running program failed with an unhandled exception:
System.InvalidOperationException: Unsupported value when converting to protobuf: Pulumi.FileAsset
   at Pulumi.Serialization.Serializer.CreateValue(Object value)
...
</code></pre><p>Once again, our mocks fail to represent the behavior of the engine accurately. The Pulumi engine knows about the <code>FileAsset</code> class pointing to a file on the disk and how to convert it to an uploaded blob. But, the engine doesn&rsquo;t copy this property to outputs. I need to adjust the mocks again.</p>
<p>I&rsquo;m not particularly interested in testing the binary contents of the files now, so I&rsquo;ll change the <code>Mocks</code> class to ignore the <code>source</code> property and not to include it into the output dictionary.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">let</span> outputs =
    [inputKVs; nameKVs]
    |&gt; Seq.concat
    |&gt; Seq.filter (<span style="color:#00f">fun</span> (k, _) -&gt; typeName &lt;&gt; <span style="color:#a31515">&#34;azure:storage/blob:Blob&#34;</span> || k &lt;&gt; <span style="color:#a31515">&#34;source&#34;</span>)
    |&gt; Seq.map KeyValuePair
</code></pre></div><p>This change makes my test suite happy again.</p>
<pre><code>Test Run Successful.
Total tests: 4
     Passed: 4
</code></pre><h2 id="validate-website-url">Validate Website URL</h2>
<p>So far, I&rsquo;ve been validating the input parameters of resources. What if I want to test something that is usually done by the cloud provider?</p>
<p>For instance, when Azure creates a static website, it automatically assigns a public endpoint. The endpoint is then available in the <code>PrimaryWebEndpoint</code> property after the Pulumi program ran and resources are created. I may want to export this value from stack outputs and validate it in a unit test.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp">[&lt;Test&gt;]
<span style="color:#00f">member</span> this.StackExportsWebsiteUrl() =
    <span style="color:#00f">let</span> resources = runTest()
    <span style="color:#00f">let</span> stack = resources.OfType&lt;WebsiteStack&gt;() |&gt; Seq.head

    <span style="color:#00f">let</span> endpoint = getValue stack.Endpoint
    endpoint.Should().Be(<span style="color:#a31515">&#34;https://wwwprodsa.web.core.windows.net&#34;</span>, <span style="color:#00f">null</span>) |&gt; ignore
</code></pre></div><p>This test doesn&rsquo;t even compile yet, so I have to define the <code>Endpoint</code> property and assign a value to it. Here is the complete implementation of the stack with the output property defined at the end.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">type</span> <span style="color:#2b91af">WebsiteStack</span>() =
    <span style="color:#00f">inherit</span> Stack()

    <span style="color:#00f">let</span> resourceGroup =
        <span style="color:#00f">new</span> ResourceGroup(
            <span style="color:#a31515">&#34;www-prod-rg&#34;</span>,
            <span style="color:#00f">new</span> ResourceGroupArgs(Tags = inputMap([<span style="color:#a31515">&#34;Environment&#34;</span>, input <span style="color:#a31515">&#34;production&#34;</span>])))

    <span style="color:#00f">let</span> storageAccount =
        <span style="color:#00f">new</span> Account(
            <span style="color:#a31515">&#34;wwwprodsa&#34;</span>,
            <span style="color:#00f">new</span> AccountArgs(
                ResourceGroupName = io resourceGroup.Name,
                AccountTier = input <span style="color:#a31515">&#34;Standard&#34;</span>,
                AccountReplicationType = input <span style="color:#a31515">&#34;LRS&#34;</span>,
                StaticWebsite = input (<span style="color:#00f">new</span> AccountStaticWebsiteArgs(IndexDocument = input <span style="color:#a31515">&#34;index.html&#34;</span>))))

    <span style="color:#00f">let</span> files =
        <span style="color:#00f">let</span> fileNames = Directory.GetFiles(<span style="color:#a31515">&#34;wwwroot&#34;</span>)
        fileNames
        |&gt; Seq.map(<span style="color:#00f">fun</span> file -&gt;
            <span style="color:#00f">new</span> Blob(
                file,
                <span style="color:#00f">new</span> BlobArgs(
                    ContentType = input <span style="color:#a31515">&#34;application/html&#34;</span>,
                    Source = input (<span style="color:#00f">new</span> FileAsset(file) :&gt; AssetOrArchive),
                    StorageAccountName = io storageAccount.Name,
                    StorageContainerName = input <span style="color:#a31515">&#34;$web&#34;</span>,
                    Type = input <span style="color:#a31515">&#34;Block&#34;</span>)))
        |&gt; List.ofSeq

    [&lt;Output&gt;]
    <span style="color:#00f">member</span> <span style="color:#00f">val</span> Endpoint = storageAccount.PrimaryWebEndpoint <span style="color:#00f">with</span> get, set
</code></pre></div><p>Now, the test compiles but fails when executed:</p>
<pre><code>X StackExportsWebsiteUrl [85ms]
  Error Message:
   Expected endpoint to be &quot;https://wwwprodsa.web.core.windows.net&quot;, but found &lt;null&gt;.
</code></pre><p>That&rsquo;s because there is no call to Azure to populate the endpoint. It&rsquo;s time to make the last change to my <code>Mocks</code> class to emulate that assignment.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#00f">let</span> endpointKVs =
    <span style="color:#00f">if</span> typeName = <span style="color:#a31515">&#34;azure:storage/account:Account&#34;</span>
    <span style="color:#00f">then</span> [<span style="color:#a31515">&#34;primaryWebEndpoint&#34;</span>, sprintf <span style="color:#a31515">&#34;https://%s.web.core.windows.net&#34;</span> name :&gt; <span style="color:#2b91af">obj</span>]
    <span style="color:#00f">else</span> []

<span style="color:#00f">let</span> outputs =
    [inputKVs; nameKVs; endpointKVs]
<span style="color:#008000">// ...
</span></code></pre></div><p>And that&rsquo;s it! My static website is ready and tested!</p>
<pre><code>Test Run Successful.
Total tests: 5
     Passed: 5
 Total time: 0.9338 Seconds
</code></pre><p>Note that it still takes less than a second to run my test suite so that I can iterate very quickly.</p>
<h2 id="get-started">Get Started</h2>
<p>The tests above cover the basics of unit testing with Pulumi .NET SDK. You can take it from here and apply the techniques and practices that you use while testing the application code. You may also try more advanced practices like property-based testing or behavior-driven development—we believe that the mocks enable many testing styles.</p>
<p>Here are several useful pointers to get started with testing in Pulumi:</p>
<ul>
<li><a href="https://www.pulumi.com/docs/guides/testing/">Testing Guide</a>.</li>
<li><a href="https://github.com/pulumi/examples/tree/72c9480f4c1240f795f6020f50801733fbef37f2/testing-unit-fs-mocks">Full code for this blog post</a>.</li>
</ul>

                </div>

                
                <div class="after-post-tags">
                    <ul class="tags">
                        
                        <li>
                            
                            
                            <a href="/tags/pulumi">Pulumi</a>
                            
                        </li>
                        
                        <li>
                            
                            
                            <a href="/tags/unit-testing">Unit Testing</a>
                            
                        </li>
                        
                        <li>
                            
                            
                            <a href="/tags/tdd">TDD</a>
                            
                        </li>
                        
                        <li>
                            
                            
                            <a href="/tags/fsharp">F#</a>
                            
                        </li>
                        
                    </ul>
                </div>
                

                <hr/>

            </div>
            
        </div>
    </div>
    
    <div class="container">
    <div id="sharepane" class="row justify-content-center">
        <div class="col-md-2">

        </div>
        <div class="contact-intro col-md-2 text-center">
            <img class="profile-small d-inline-block mx-auto rounded-circle mb-3" height="100px"
                src="/images/author.jpg" alt="">
        </div>
        <div class="col-md-8">
            <section class="article-open_author">
                <div class="article-open_author_bio">
                    <h5 itemprop="author" itemscope="" itemtype="http://schema.org/Person">Author: Mikhail Shilkov</h5>
                    <p>
                        <div>Cloud developer and researcher.</div><div>Software engineer at Pulumi. Microsoft Azure MVP.</div>
                    </p>
                </div>
            </section>
            <a href="https://twitter.com/MikhailShilkov?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @MikhailShilkov</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        </div>
    </div>
</div>
<div class="container">
    <div id="comments" class="row justify-content-center mb-5">
        <div class="col-md-8">
            
            <div class="mb-5">
                <h5 class="float-left">Responses</h5>
                <div class="float-right"><a
                        href='https://github.com/mikhailshilkov/mikhailio-hugo/issues/39'>Write a
                        response</a></div>
            </div>
            <div id="gh-comments-list" style="display: none">39</div>
            <div class="mt-4">Visit the <b><a
                        href='https://github.com/mikhailshilkov/mikhailio-hugo/issues/39'>Github
                        Issue</a></b> to comment on this page</div>
            
        </div>
    </div>
</div>
</div>

        </div>
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                &copy; Copyright Mikhail Shilkov - All rights reserved
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                
            </div>
        </div>
    </div>
</footer>











<script src="/js/bundle.min.js"></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-59218480-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
    </body>
</html>
