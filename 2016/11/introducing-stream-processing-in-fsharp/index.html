<!DOCTYPE html>
<html lang="en-us" prefix="og: http://ogp.me/ns#"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	
	<link rel="icon" type="image/png" href="/favicon.ico">
	
	
	<title>Introducing Stream Processing in F# | Mikhail Shilkov</title>
	
	
	
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
	
	<link rel="stylesheet" href="/sass/main.css">

	
	
	<meta property="og:title" content="Introducing Stream Processing in F#" />
	<meta property="og:description" content="The post was published for
F# Advent Calendar 2016,
thus the examples are themed around the Christmas gifts.
This article is my naive introduction to the data processing discipline called Stream Processing." />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="https://mikhail.io/2016/11/introducing-stream-processing-in-fsharp/" />

	
	
	
	
	<meta property="og:image" content="https://mikhail.io/2016/11/introducing-stream-processing-in-fsharp/teaser.png" />
	
	


	
	
	<meta property="article:tag" content="Stream Processing" />
	
	<meta property="article:tag" content="FSharp" />
	
	<meta property="article:tag" content="Advent Calendar" />
	
	<meta property="article:tag" content="Data Processing" />
	

	
	
	<meta name="twitter:card" content="summary_large_image"/>
	
	<meta name="twitter:image" content="https://mikhail.io/2016/11/introducing-stream-processing-in-fsharp/teaser.png" />
	
	

	<meta name="twitter:title" content="Introducing Stream Processing in F#"/>
	<meta name="twitter:description" content="The post was published for
F# Advent Calendar 2016,
thus the examples are themed around the Christmas gifts.
This article is my naive introduction to the data processing discipline called Stream Processing."/>
	<meta name="twitter:creator" content="@MikhailShilkov"></meta>
</head>
<body><script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load("current", {packages:["corechart"]});
    function addChart(make) {
        google.charts.setOnLoadCallback(drawChart);
        function drawChart() {
            const data = new google.visualization.DataTable();

            const options = {
                height: 420,  
                chartArea: { width: '85%', height: '70%' },
                legend: 'none',
                hAxis: { minValue: 0 },
                vAxis: {},
                series: {      
                    0: { tooltip : false}
                }
            };
            const chart = make(data, options);
            options.hAxis.textStyle = options.hAxis.titleTextStyle 
                = options.vAxis.textStyle = options.vAxis.titleTextStyle = { fontName: 'Merriweather' };

            chart.draw(data, options);
        }
    }
</script>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container pr-0">
        <a class="navbar-brand" href="/">
            <img class="author-thumb" src="/images/author.jpg" alt="Mikhail Shilkov">
            <span class="text-primary">Mikhail Shilkov</span>
        </a>

        
               


        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        
        <div class="collapse navbar-collapse" id="navbarMediumish">
            
            <ul class="navbar-nav ml-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">TOPICS</a>
                </li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/archives/">ARCHIVES</a>
                </li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/talks/">TALKS</a>
                </li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">ABOUT</a>
                </li>
                <li class="nav-item">
    <a class="nav-link" href="https://mikhail.io/feed/"><i class="fas fa-rss social-icon" aria-hidden="true"></i></a>
</li>

<li class="nav-item">
    <a class="nav-link" href="https://x.com/MikhailShilkov"><i class="fab fa-twitter social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://dev.to/mikhailshilkov"><i class="fab fa-dev social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://medium.com/@MikhailShilkov"><i class="fab fa-medium social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://github.com/MikhailShilkov"><i class="fab fa-github social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/MikhailShilkov"><i class="fab fa-linkedin social-icon" aria-hidden="true"></i></a>
</li>

</ul>
        </div>
        
    </div>
</nav>


        <div class="container">

<div class="main-content">
    
    <div class="container">
        <div class="row">
            
            <div class="col-lg-2 pl-0"><div class="share">
    <ul>
        <li class="ml-1 mr-1" title="Say 'Thank You' for this article">
            <a href="#" onclick="heart();return false;">
                <i class="fas fa-heart" style="color: red"></i>
            </a>
            <div class="count" style="float: right; padding-left: .5em; padding-top: .25em" id="heartcount"></div>
        </li>

        <li class="ml-1 mr-1" title="Tweet this article">
            <a target="_blank"
                href="https://x.com/intent/tweet?text=Introducing%20Stream%20Processing%20in%20F%23%20by%20@MikhailShilkov&url=https%3a%2f%2fmikhail.io%2f2016%2f11%2fintroducing-stream-processing-in-fsharp%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=435');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1" title="See the responses or write a response">
            <a href="#comments">
                <i class="fas fa-comment"></i>
            </a>
        </li>
    </ul>
</div></div>
            
            <div class="col-lg-9 flex-first flex-lg-unordered">

                <div class="mainheading">
                    
                    <h1 class="posttitle">Introducing Stream Processing in F#</h1>
                    
                    <div class="post-top-meta">
                        <div>
                            
                                
                                <span class="post-date">Published on Nov 29, 2016
                                
                            
                            
                        &nbsp;&middot;&nbsp; 14 min read</span></span>
                        </div>
                    </div>
                </div>
                
                
                

                
                <div class="article-post">
                    <p><em>The post was published for
<a href="https://sergeytihon.wordpress.com/2016/10/23/f-advent-calendar-in-english-2016/">F# Advent Calendar 2016</a>,
thus the examples are themed around the Christmas gifts.</em></p>
<p>This article is my naive introduction to the data processing discipline called <strong>Stream Processing</strong>.</p>
<p>I describe stream processing from the developer perspective, using the
following (rather unusual) angle:</p>
<ul>
<li>F# as the primary language</li>
<li>Concepts and principles are more important than frameworks and tools</li>
<li>Start with modeling the domain problem and then solve just the problems
that your domain has</li>
</ul>
<p>We begin the journey by introducing what stream processing is all about.</p>
<h2 id="whats-and-whys">What&rsquo;s and Why&rsquo;s</h2>
<p>There are several techniques to process data that are flowing into your
applications, and stream processing is one of them.</p>
<p>Stream processing is focused on the real-time processing of data
continuously, concurrently, and in a record-by-record fashion. Stream
processing is designed to analyze and act on live data flow, using
&ldquo;continuous queries&rdquo; expressed in user code. Data is structured
as a continuous stream of events over time:</p>
<p><img src="eventflow.png" alt="Flow of events"></p>
<p>In contrast to some other approaches to reason about application
structure, stream processing concepts are drawn around the data structures,
flows and transformations rather than services or remote calls.</p>
<p>Although the approach is nothing new, it gained much more traction
during the last years, especially in big data community. Products
like <em>Storm</em>, <em>Kafka</em>, <em>Flink</em>, <em>Samza</em> (all under <em>Apache Foundation</em>),
<em>Google Cloud Dataflow</em>, <em>Akka Streams</em> are popularizing the programming
model and bringing the tools to make it reliable and scalable.</p>
<p>These products are born from the need to run data processing in
massively distributed environments. They are all about scaling out
and solving or mitigating the issues of distributed systems which
are inherintly not reliable.</p>
<p>While this is a noble and mission-critical goal for internet-scale companies, most
applications do not require such massive performances and scale.</p>
<p>There is something to be said for the domain-driven approach, when
an application is built around the main asset and burden of enterprise
systems: the core business logic. It may happen that you don&rsquo;t need
a general purpose framework with the lowest processing latency. Instead
your choice of tools might lean towards the cleanest code possible, tailored
for your own needs, and maintainable over time.</p>
<p>Knowing the landscape can help you do the right trade-off.</p>
<p>The recent Stream Processing boom comes from <em>Apache</em> / <em>JVM</em> world.
Unfortunately, stream processing frameworks and underlying concepts
are mostly unfamiliar to <em>.NET</em> developers.</p>
<p>While <em>Azure Cloud</em> provides a managed service called <em>Azure Stream Analytics</em>,
the product is built around SQL-like language and is rather limited in
extensibility.</p>
<p>We will have a look at other options in .NET space in the further posts
of the series.</p>
<p>For now, I want to start filling the gap and introduce the basic concepts
with F#. As a bonus, we are not limited by particular tools and
implementations, but can start from the ground up.</p>
<h2 id="elements-of-a-stream">Elements of a Stream</h2>
<p>As I already mentioned above, people are doing stream processing for long
time. In fact, if you receive events and then apply the transformation
logic structured around a single event at a time - you are already
doing stream processing.</p>
<p>Here is a simple picture which illustrates the elements of processing:</p>
<p><img src="stage.png" alt="Stream Processing Stage"></p>
<p>The data <strong>Source</strong> is responsible for injection of events
into the pipeline. They are the input intergration points, typically they can
be persistent message queues, logs or subscription feeds.</p>
<p>A sequence of events in the same Source is called <strong>Stream</strong> (thus Stream Processing).
Streams have <strong>unbounded</strong> nature, which means that the amount
of data points is not limited in size or time. There is no &ldquo;end&rdquo; of data: events
will potentially keep coming as long as the processing application is alive.</p>
<p>The high-level purpose of the <strong>Transformation</strong> is to extract
value from the events. That&rsquo;s where the business logic resides, and that&rsquo;s
where development effort goes to. Transformations can also be refered as Stages,
Flows, Tasks, Jobs and so on, depending on the context.</p>
<p>The most simple transformation like format conversion can be stateless.
However, other transformations will often use some kind of <strong>State Store</strong>,
as a means to</p>
<ul>
<li>Aggregate data from multiple events of the same stream</li>
<li>Correlate events from several streams</li>
<li>Enrich event data with external lookup data</li>
</ul>
<p>Data <strong>Sink</strong> represents the output of the pipeline, the place where the transformed,
aggregated and enriched events end up at.</p>
<p>A Sink can be a database of any kind, which stores the processed data, ready
to be consumed by user queries and reports.</p>
<p>Another Sink can become a Source for another stream of events. This way
the series of transformations are sequenced together into <strong>Processing Pipelines</strong>
(or <strong>Topologies</strong>).</p>
<p>On the high-level, the pipelines can usually be represented as directed graphs,
with data streams in nodes and transformations in edges:</p>
<p><img src="topology.png" alt="Stream Processing Pipeline"></p>
<p>In real-world applications, the pipelines can have lots of interconnected
elements and flow branches. We will start with a simplistic example.</p>
<h2 id="gift-count-pipeline">Gift Count Pipeline</h2>
<p>Word Count is the Hello World and TODO app of the data
processing world. Here are the reference implementations for
<a href="https://cloud.google.com/dataflow/examples/wordcount-example">Dataflow</a>,
<a href="https://github.com/apache/flink/blob/master/flink-examples/flink-examples-batch/src/main/java/org/apache/flink/examples/java/wordcount/WordCount.java">Flink</a> and
<a href="https://github.com/nathanmarz/storm-starter/blob/master/src/jvm/storm/starter/WordCountTopology.java">Storm</a>.</p>
<p>To make it a bit more fun, we&rsquo;ll make a Gift Count pipeline out of it.
The following image summarizes our Gift Count topology:</p>
<p><img src="giftcount.png" alt="Gift Count Pipeline"></p>
<p>The pipeline consists of one source, one sink and two transformations.
The input of the pipeline is the source of gift lists (each list is a comma
separated line of text).</p>
<p>The purpose of the processing is to tokenize gift lists into separate gifts,
and then count the occurances of each gift in the stream. The output
is written into a database sink, e.g. a key value store with gifts as keys and
amounts as values.</p>
<p>Note that while Split stage is stateless, the Count stage needs to keep some
internal state to be able to aggregate data over multiple entries.</p>
<p>Let&rsquo;s start thinking about the implementation. How do we model transformations
and pipelines in code?</p>
<h2 id="transformations">Transformations</h2>
<p>Here&rsquo;s how a transformation is typically represented in <em>Apache Storm</em>, the grand
daddy of Big Data Stream Processing systems (transformations are called
<em>Bolts</em> in Storm, and code is Java):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">class</span> <span style="color:#1f2328">TokenizerBolt</span><span style="color:#fff"> </span><span style="color:#cf222e">implements</span><span style="color:#fff"> </span>IRichBolt<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">void</span><span style="color:#fff"> </span><span style="color:#6639ba">execute</span><span style="color:#1f2328">(</span>Tuple<span style="color:#fff"> </span>input<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>String<span style="color:#fff"> </span>wishlist<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>input<span style="color:#1f2328">.</span><span style="color:#1f2328">getString</span><span style="color:#1f2328">(</span>0<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">for</span><span style="color:#1f2328">(</span>String<span style="color:#fff"> </span>gift<span style="color:#1f2328">:</span><span style="color:#fff"> </span>wishlist<span style="color:#1f2328">.</span><span style="color:#1f2328">split</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;, &#34;</span><span style="color:#1f2328">))</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>collector<span style="color:#1f2328">.</span><span style="color:#1f2328">emit</span><span style="color:#1f2328">(</span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>Values<span style="color:#1f2328">(</span>gift<span style="color:#1f2328">));</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>collector<span style="color:#1f2328">.</span><span style="color:#1f2328">ack</span><span style="color:#1f2328">(</span>input<span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">// Other code is omitted</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre></div><p>Tokenizer is a class which implements a predefined interface with <code>execute</code>
method in it. The method accepts a container class <code>Tuple</code> from where
we can extract real data using position-based indexing. Something like a
<code>DataRow</code> from ADO.NET. The method does not return anything, but instead
calls an effect-ful method <code>emit</code>, passing a tuple to the next transformation
in the pipeline.</p>
<p>Clearly, there is some room for improvement here. We don&rsquo;t want to put our important
domain logic into amorphous functions of type <code>Collector -&gt; Tuple -&gt; unit</code>. Here
is what we can do:</p>
<ul>
<li>Use strong typing to see what function does based on its signature</li>
<li>Use pure functions to make them easy to test and reason about</li>
<li>Use domain-specific types with F# records and ADTs</li>
</ul>
<p>Our domain is very simple in Gift Count example. Still, we could describe <code>Gift</code>
type to restrict it to be lowercase, not empty etc. But for the sake of simplisity
I&rsquo;ll limit it to one liner:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Gift</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">string</span>
</span></span></code></pre></div><p>Now, the type of the first transformation should be <code>string -&gt; Gift list</code>. So,
our transformation is based on a function</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#cf222e">let</span> <span style="color:#953800">tokenize</span> <span style="color:#0550ae">(</span>wishlist<span style="color:#0550ae">:</span> <span style="color:#cf222e">string</span><span style="color:#0550ae">)</span> <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>  wishlist<span style="color:#0550ae">.</span>ToLowerInvariant<span style="color:#6a737d">()</span><span style="color:#0550ae">.</span>Split<span style="color:#0550ae">(</span><span style="color:#0a3069">&#34;, &#34;</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">List</span><span style="color:#1f2328">.</span>ofArray
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">List</span><span style="color:#1f2328">.</span>map <span style="color:#0550ae">(</span><span style="color:#cf222e">fun</span> x <span style="color:#0550ae">-&gt;</span> x<span style="color:#0550ae">.</span>Trim<span style="color:#6a737d">()</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">List</span><span style="color:#1f2328">.</span>filter <span style="color:#0550ae">(</span><span style="color:#cf222e">fun</span> x <span style="color:#0550ae">-&gt;</span> x<span style="color:#0550ae">.</span>Length <span style="color:#0550ae">&gt;</span> 0<span style="color:#0550ae">)</span>
</span></span></code></pre></div><p>The counting transformation is modeled in a similar way. The base function
is of type <code>Gift list -&gt; (Gift * int) list</code> and is actually implemented as</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#cf222e">let</span> <span style="color:#953800">count</span> xs <span style="color:#0550ae">=</span> <span style="color:#24292e">List</span><span style="color:#1f2328">.</span>countBy id xs
</span></span></code></pre></div><p>Instead of using a real database, we will just print the counts to console.
So the last optional step for our examples will be to print out the counts
one by one. Here is a helper function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#cf222e">let</span> <span style="color:#953800">print</span> <span style="color:#0550ae">(</span>gift<span style="color:#0550ae">,</span> count<span style="color:#0550ae">)</span> <span style="color:#0550ae">=</span> sprintf <span style="color:#0a3069">&#34;%i %s&#34;</span> count gift
</span></span></code></pre></div><p>Now, we can tokenize and count the gifts in a single list. But how do we
aggregate data over time? Let&rsquo;s leave this to the pipelines.</p>
<h2 id="pipelines">Pipelines</h2>
<p>Let&rsquo;s have a look at a definition of a Storm pipeline (in Java):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>TopologyBuilder<span style="color:#fff"> </span>builder<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>TopologyBuilder<span style="color:#1f2328">();</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>builder<span style="color:#1f2328">.</span><span style="color:#1f2328">setSpout</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;line-reader&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>LineReaderSpout<span style="color:#1f2328">());</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>builder<span style="color:#1f2328">.</span><span style="color:#1f2328">setBolt</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;gifts-spitter&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>GiftSpitterBolt<span style="color:#1f2328">()).</span><span style="color:#1f2328">shuffleGrouping</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;line-reader&#34;</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span>builder<span style="color:#1f2328">.</span><span style="color:#1f2328">setBolt</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;gift-counter&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>GiftCounterBolt<span style="color:#1f2328">()).</span><span style="color:#1f2328">shuffleGrouping</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;gifts-spitter&#34;</span><span style="color:#1f2328">);</span><span style="color:#fff">
</span></span></span></code></pre></div><p>There is a <code>Builder</code> class, which is capable to add Sources (<code>Spouts</code>) and Transformations
(<code>Bolts</code>) to the pipeline. But again, there&rsquo;s no type story here: the stages are linked
by name, and the types are just implementations of predefined interfaces.</p>
<p>Here is another example of the pipeline, now from <em>Google Dataflow SDK</em> (still Java):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Pipeline<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">.</span><span style="color:#1f2328">create</span><span style="color:#1f2328">(</span>options<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">.</span><span style="color:#1f2328">apply</span><span style="color:#1f2328">(</span>TextIO<span style="color:#1f2328">.</span><span style="color:#1f2328">Read</span><span style="color:#1f2328">.</span><span style="color:#1f2328">from</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;...&#34;</span><span style="color:#1f2328">))</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">.</span><span style="color:#1f2328">apply</span><span style="color:#1f2328">(</span>ParDo<span style="color:#1f2328">.</span><span style="color:#1f2328">named</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;ExtractGifts&#34;</span><span style="color:#1f2328">).</span><span style="color:#1f2328">of</span><span style="color:#1f2328">(</span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>DoFn<span style="color:#0550ae">&lt;</span>String<span style="color:#1f2328">,</span><span style="color:#fff"> </span>String<span style="color:#0550ae">&gt;</span><span style="color:#1f2328">()</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span><span style="color:#cf222e">public</span><span style="color:#fff"> </span><span style="color:#cf222e">void</span><span style="color:#fff"> </span><span style="color:#6639ba">processElement</span><span style="color:#1f2328">(</span>ProcessContext<span style="color:#fff"> </span>c<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff"> </span><span style="color:#57606a">/* Implements tokenizer */</span><span style="color:#fff"> </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}))</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">.</span><span style="color:#1f2328">apply</span><span style="color:#1f2328">(</span>Count<span style="color:#1f2328">.</span><span style="color:#0550ae">&lt;</span>String<span style="color:#0550ae">&gt;</span>perElement<span style="color:#1f2328">())</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">.</span><span style="color:#1f2328">apply</span><span style="color:#1f2328">(</span>MapElements<span style="color:#1f2328">.</span><span style="color:#1f2328">via</span><span style="color:#1f2328">(</span><span style="color:#cf222e">new</span><span style="color:#fff"> </span>SimpleFunction<span style="color:#0550ae">&lt;</span>KV<span style="color:#0550ae">&lt;</span>String<span style="color:#1f2328">,</span><span style="color:#fff"> </span>Long<span style="color:#0550ae">&gt;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>String<span style="color:#0550ae">&gt;</span><span style="color:#1f2328">()</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">         </span><span style="color:#cf222e">public</span><span style="color:#fff"> </span>String<span style="color:#fff"> </span><span style="color:#6639ba">apply</span><span style="color:#1f2328">(</span>KV<span style="color:#0550ae">&lt;</span>String<span style="color:#1f2328">,</span><span style="color:#fff"> </span>Long<span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span>element<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff"> </span><span style="color:#57606a">/* Formats results */</span><span style="color:#fff"> </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}))</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">.</span><span style="color:#1f2328">apply</span><span style="color:#1f2328">(</span>TextIO<span style="color:#1f2328">.</span><span style="color:#1f2328">Write</span><span style="color:#1f2328">.</span><span style="color:#1f2328">to</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;...&#34;</span><span style="color:#1f2328">));</span><span style="color:#fff">
</span></span></span></code></pre></div><p>I consider this to be more descriptive. There is a clear flow of operations chained
together. The types are visible and checked at compile time.</p>
<p>How would we like to see this pipeline in F#? Our motivation example is going to
be the same processing applied to a normal F# list of wishlists (strings). The following
code snippet counts the gifts in wishlists and prints the result:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>wishlists
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">List</span><span style="color:#1f2328">.</span>collect tokenize
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">List</span><span style="color:#1f2328">.</span>countBy id
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">List</span><span style="color:#1f2328">.</span>map print
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">List</span><span style="color:#1f2328">.</span>iter <span style="color:#0550ae">(</span><span style="color:#24292e">Console</span><span style="color:#1f2328">.</span>WriteLine<span style="color:#0550ae">)</span>
</span></span></code></pre></div><p>My goal for the rest of the article will be to define a <code>Flow</code> module which would
enable me to write a Stream Processing pipeline in the same fashion. Here is the
target code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>sourceOfWishlists
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Flow</span><span style="color:#1f2328">.</span>collect tokenize
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Flow</span><span style="color:#1f2328">.</span>countBy id
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Flow</span><span style="color:#1f2328">.</span>map print
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Flow</span><span style="color:#1f2328">.</span>connectTo sinkForCounts
</span></span></code></pre></div><p>So, how do we implement something like this? Let&rsquo;s start with clarifying how
Source and Sink can be defined.</p>
<h2 id="source-and-sink">Source and Sink</h2>
<p>We declared the source of a stream to be unbounded, not limited in time
or event count.</p>
<p>However, the modern stream processing systems like <em>Flink</em> and <em>Dataflow</em>
(both with ideas from <em>Apache Beam</em>) are trying to sit on two chairs at the same time by declaring
that bounded data sources are just sub-case of unbounded streams. If your
goal is to process a fixed batch of data, you could represent it as
one-by-one sequence of events.</p>
<p>Big Data world has a well known approach when batch processing and real time
stream processing are done in parallel, with separate tools and separate code base.
The approach is called <em>Lambda Architecture</em>. Beam is declaring this approach outdated,
offering a way to reuse streaming code and capacity also for bounded data workloads.</p>
<p>To follow this modern path, we will declare our <code>Source</code> as following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">BoundedSource</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>T<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">unit</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">&#39;</span>T seq
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">UnboundedSource</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>T<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">(</span><span style="color:#cf222e">&#39;</span>T <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">unit</span><span style="color:#0550ae">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">unit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Source</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>T<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">|</span> Bounded <span style="color:#cf222e">of</span> BoundedSource<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>T<span style="color:#0550ae">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">|</span> Unbounded <span style="color:#cf222e">of</span> UnboundedSource<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>T<span style="color:#0550ae">&gt;</span>
</span></span></code></pre></div><p><code>Source</code> is a generic discriminated union with two cases. <code>Bounded</code> case represents
a side effect-ful function, which returns a sequence of elements when called.
The argument of <code>unit</code> is there to delay the processing: we need to declare
sources long before they start to emit values.</p>
<p>The <code>Unbounded</code> case is a bit harder to understand. It accepts an action to be
executed as the argument and returns nothing meaningful (<code>unit</code> again). You will
see a usage example later.</p>
<p>The <code>Sink</code> represents an action to happen at the end of pipeline. I&rsquo;ve made it
a discriminated union too, but with just one case:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Sink</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>T<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">|</span> Action <span style="color:#cf222e">of</span> <span style="color:#0550ae">(</span><span style="color:#cf222e">&#39;</span>T <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">unit</span><span style="color:#0550ae">)</span>
</span></span></code></pre></div><p>Now, we should be able to simulate an empty processing pipeline: directly connect
a source to a sink. Let&rsquo;s start with bounded data:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#cf222e">let</span> <span style="color:#953800">copyPipeline</span> source sink <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">match</span> source<span style="color:#0550ae">,</span> sink <span style="color:#cf222e">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">|</span> Bounded b<span style="color:#0550ae">,</span> Action a <span style="color:#0550ae">-&gt;</span> b<span style="color:#6a737d">()</span> <span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Seq</span><span style="color:#1f2328">.</span>iter a
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">|</span> <span style="color:#0550ae">_</span> <span style="color:#0550ae">-&gt;</span> failwith <span style="color:#0a3069">&#34;Not supported yet&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">let</span> <span style="color:#953800">gifts</span> <span style="color:#0550ae">=</span> seq <span style="color:#0550ae">[</span><span style="color:#0a3069">&#34;Ball&#34;</span><span style="color:#0550ae">;</span> <span style="color:#0a3069">&#34;Train&#34;</span><span style="color:#0550ae">;</span> <span style="color:#0a3069">&#34;Doll&#34;</span><span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">let</span> <span style="color:#953800">giftBoundedSource</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">(</span><span style="color:#cf222e">fun</span><span style="color:#6a737d">()</span> <span style="color:#0550ae">-&gt;</span> gifts<span style="color:#0550ae">)</span> <span style="color:#0550ae">|&gt;</span> Bounded
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">let</span> <span style="color:#953800">consoleSink</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">(</span><span style="color:#cf222e">fun</span> <span style="color:#0550ae">(</span>s<span style="color:#0550ae">:</span> <span style="color:#cf222e">string</span><span style="color:#0550ae">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#24292e">Console</span><span style="color:#1f2328">.</span>WriteLine s<span style="color:#0550ae">)</span> <span style="color:#0550ae">|&gt;</span> Action
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>copyPipeline giftBoundedSource consoleSink
</span></span></code></pre></div><p>This code will print out all the gift names from the sequence. Now, let&rsquo;s extend it to
stream unbounded data. Before we can do that, let&rsquo;s introduce a helper class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Triggered</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>T<span style="color:#0550ae">&gt;</span><span style="color:#6a737d">()</span> <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">let</span> <span style="color:#953800">subscribers</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">new</span> List<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>T <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">unit</span><span style="color:#0550ae">&gt;</span><span style="color:#6a737d">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">member</span> this<span style="color:#1f2328">.</span><span style="color:#6639ba">DoNext</span> x <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>    subscribers<span style="color:#0550ae">.</span>ForEach<span style="color:#0550ae">(</span><span style="color:#cf222e">fun</span> s <span style="color:#0550ae">-&gt;</span> s x<span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">member</span> this<span style="color:#1f2328">.</span><span style="color:#6639ba">Subscribe</span> <span style="color:#0550ae">=</span> subscribers<span style="color:#0550ae">.</span>Add
</span></span></code></pre></div><p>An instance of such class keeps a mutable list of subscribers. Subscribers are
added by calling <code>Subscribe</code> method. Someone else can then call <code>DoNext</code> method,
and each subscriber will get an item every time.</p>
<p>Here&rsquo;s how we can use it for unbounded data processing:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#cf222e">let</span> <span style="color:#953800">copyPipeline</span> source sink <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">match</span> source<span style="color:#0550ae">,</span> sink <span style="color:#cf222e">with</span>
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">|</span> Bounded b<span style="color:#0550ae">,</span> Action a <span style="color:#0550ae">-&gt;</span> b<span style="color:#6a737d">()</span> <span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Seq</span><span style="color:#1f2328">.</span>iter a
</span></span><span style="display:flex;"><span>  <span style="color:#0550ae">|</span> Unbounded ub<span style="color:#0550ae">,</span> Action a <span style="color:#0550ae">-&gt;</span> ub a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">let</span> <span style="color:#953800">consoleSource</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">new</span> Triggered<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">string</span><span style="color:#0550ae">&gt;</span><span style="color:#6a737d">()</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">let</span> <span style="color:#953800">unboundedSource</span> <span style="color:#0550ae">=</span> consoleSource<span style="color:#0550ae">.</span>Subscribe <span style="color:#0550ae">|&gt;</span> Unbounded
</span></span><span style="display:flex;"><span>copyPipeline unboundedSource consoleSink
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#24292e">Seq</span><span style="color:#1f2328">.</span>initInfinite <span style="color:#0550ae">(</span><span style="color:#cf222e">fun</span> <span style="color:#0550ae">_</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#24292e">Console</span><span style="color:#1f2328">.</span>ReadLine<span style="color:#6a737d">()</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Seq</span><span style="color:#1f2328">.</span>takeWhile <span style="color:#0550ae">((&lt;&gt;)</span> <span style="color:#0a3069">&#34;q&#34;</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Seq</span><span style="color:#1f2328">.</span>iter consoleSource<span style="color:#0550ae">.</span>DoNext
</span></span></code></pre></div><p>This little program will echo whatever you enter into the console until you type
<code>q</code> to quit. That is an example of unbounded data: you can type as long as
you want, there is no hard limit.</p>
<p>Here&rsquo;s how it works:</p>
<ol>
<li><code>Triggered</code> source is created.</li>
<li>Unbounded source is declared by subscribing to the trigger.</li>
<li>Our dummy pipeline links the source to the action of writing to console.</li>
<li>Every time a new line is entered, <code>DoNext</code> method of the trigger is called
and the data flows to the sink.</li>
</ol>
<p>Stop here and make sure you understand the example before going further.</p>
<h2 id="flow">Flow</h2>
<p>Now it&rsquo;s time to implement the contracts for the flow that we defined
in Gift Count example. The contract consists of two parts. The first part
is a generic interface which defines all the operations that we need:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">Runnable</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">unit</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">unit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">IFlow</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>a<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">abstract</span> <span style="color:#cf222e">member</span> Map<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">:</span> <span style="color:#0550ae">(</span><span style="color:#cf222e">&#39;</span>a <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">)</span> <span style="color:#0550ae">-&gt;</span> IFlow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">abstract</span> <span style="color:#cf222e">member</span> Collect<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">:</span> <span style="color:#0550ae">(</span><span style="color:#cf222e">&#39;</span>a <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">&#39;</span>b <span style="color:#cf222e">list</span><span style="color:#0550ae">)</span> <span style="color:#0550ae">-&gt;</span> IFlow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">abstract</span> <span style="color:#cf222e">member</span> CountBy<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b <span style="color:#cf222e">when</span> <span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">:</span> equality<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">:</span> <span style="color:#0550ae">(</span><span style="color:#cf222e">&#39;</span>a <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">)</span> <span style="color:#0550ae">-&gt;</span> IFlow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b <span style="color:#0550ae">*</span> int<span style="color:#0550ae">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">abstract</span> <span style="color:#cf222e">member</span> To<span style="color:#0550ae">:</span> Sink<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>a<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">-&gt;</span> Runnable
</span></span></code></pre></div><p>Then we define a module which is just a wrapper around the interface to
enable F#-style API:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#cf222e">module</span> <span style="color:#24292e">Flow</span> <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">let</span> <span style="color:#953800">map</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>TI<span style="color:#0550ae">,</span> <span style="color:#cf222e">&#39;</span>TO<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">(</span>f<span style="color:#0550ae">:</span> <span style="color:#cf222e">&#39;</span>TI <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">&#39;</span>TO<span style="color:#0550ae">)</span> <span style="color:#0550ae">(</span>flow<span style="color:#0550ae">:</span> IFlow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>TI<span style="color:#0550ae">&gt;)</span> <span style="color:#0550ae">=</span> flow<span style="color:#0550ae">.</span>Map f
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">let</span> <span style="color:#953800">collect</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>TI<span style="color:#0550ae">,</span> <span style="color:#cf222e">&#39;</span>TO<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">(</span>f<span style="color:#0550ae">:</span> <span style="color:#cf222e">&#39;</span>TI <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">&#39;</span>TO <span style="color:#cf222e">list</span><span style="color:#0550ae">)</span> <span style="color:#0550ae">(</span>flow<span style="color:#0550ae">:</span> IFlow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>TI<span style="color:#0550ae">&gt;)</span> <span style="color:#0550ae">=</span> flow<span style="color:#0550ae">.</span>Collect f
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">let</span> <span style="color:#953800">countBy</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>T<span style="color:#0550ae">,</span> <span style="color:#cf222e">&#39;</span>TK <span style="color:#cf222e">when</span> <span style="color:#cf222e">&#39;</span>TK<span style="color:#0550ae">:</span> equality<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">(</span>f<span style="color:#0550ae">:</span> <span style="color:#cf222e">&#39;</span>T <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">&#39;</span>TK<span style="color:#0550ae">)</span> <span style="color:#0550ae">(</span>flow<span style="color:#0550ae">:</span> IFlow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>T<span style="color:#0550ae">&gt;)</span> <span style="color:#0550ae">=</span> flow<span style="color:#0550ae">.</span>CountBy f
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">let</span> <span style="color:#953800">connectTo</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>T<span style="color:#0550ae">&gt;</span> sink <span style="color:#0550ae">(</span>flow<span style="color:#0550ae">:</span> IFlow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>T<span style="color:#0550ae">&gt;)</span> <span style="color:#0550ae">=</span> flow<span style="color:#0550ae">.</span>To sink
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">let</span> <span style="color:#953800">run</span> <span style="color:#0550ae">(</span>r<span style="color:#0550ae">:</span> Runnable<span style="color:#0550ae">)</span> <span style="color:#0550ae">=</span> r<span style="color:#6a737d">()</span>
</span></span></code></pre></div><p>Then, we just need an implementation of <code>IFlow</code> and a factory method to create
an initial instance of flow given a data source.</p>
<p>Now I&rsquo;d like to emphasize that there are multiple possible implementations
of <code>IFlow</code> depending on the required properties for the pipeline. They might make
use of different libraries or frameworks, or be a naive simple implementation like
the one below, suitable for modeling and testing.</p>
<p>In fact, one of my implementations doesn&rsquo;t run the pipeline, but instead uses reflection
to build a visual graph of processing stages, to be used for documentation and discussion
purposes.</p>
<p>We will have a look at more advanced implementations in the further articles, but
for now here is a naive version:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#cf222e">module</span> <span style="color:#24292e">Runner</span> <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">let</span> <span style="color:#953800">private</span> mapTransform map <span style="color:#0550ae">=</span> <span style="color:#cf222e">function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">|</span> Bounded bs <span style="color:#0550ae">-&gt;</span> bs <span style="color:#0550ae">&gt;&gt;</span> <span style="color:#24292e">Seq</span><span style="color:#1f2328">.</span>map map <span style="color:#0550ae">|&gt;</span> Bounded
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">|</span> Unbounded us <span style="color:#0550ae">-&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#cf222e">fun</span> subscriber <span style="color:#0550ae">-&gt;</span> map <span style="color:#0550ae">&gt;&gt;</span> subscriber <span style="color:#0550ae">|&gt;</span> us
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">|&gt;</span> Unbounded
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">let</span> <span style="color:#953800">private</span> collectTransform mapToMany <span style="color:#0550ae">=</span> <span style="color:#cf222e">function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">|</span> Bounded bs <span style="color:#0550ae">-&gt;</span> bs <span style="color:#0550ae">&gt;&gt;</span> <span style="color:#24292e">Seq</span><span style="color:#1f2328">.</span>map mapToMany <span style="color:#0550ae">&gt;&gt;</span> <span style="color:#24292e">Seq</span><span style="color:#1f2328">.</span>concat <span style="color:#0550ae">|&gt;</span> Bounded
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">|</span> Unbounded us <span style="color:#0550ae">-&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#cf222e">fun</span> subscriber <span style="color:#0550ae">-&gt;</span> mapToMany <span style="color:#0550ae">&gt;&gt;</span> <span style="color:#24292e">Seq</span><span style="color:#1f2328">.</span>iter subscriber <span style="color:#0550ae">|&gt;</span> us
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">|&gt;</span> Unbounded
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">let</span> <span style="color:#953800">private</span> countByTransform<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>a<span style="color:#0550ae">,</span> <span style="color:#cf222e">&#39;</span>b <span style="color:#cf222e">when</span> <span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">:</span> equality<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">(</span>getKey<span style="color:#0550ae">:</span> <span style="color:#cf222e">&#39;</span>a <span style="color:#0550ae">-&gt;</span> <span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">)</span> source <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">let</span> <span style="color:#953800">state</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">new</span> Dictionary<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">,</span> int<span style="color:#0550ae">&gt;</span><span style="color:#6a737d">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">let</span> <span style="color:#953800">addItem</span> i <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#cf222e">let</span> <span style="color:#953800">key</span> <span style="color:#0550ae">=</span> getKey i
</span></span><span style="display:flex;"><span>      <span style="color:#cf222e">let</span> <span style="color:#953800">value</span> <span style="color:#0550ae">=</span> <span style="color:#cf222e">if</span> state<span style="color:#0550ae">.</span>ContainsKey key <span style="color:#cf222e">then</span> state<span style="color:#0550ae">.[</span>key<span style="color:#0550ae">]</span> <span style="color:#cf222e">else</span> 0
</span></span><span style="display:flex;"><span>      <span style="color:#cf222e">let</span> <span style="color:#953800">newValue</span> <span style="color:#0550ae">=</span> value <span style="color:#0550ae">+</span> 1
</span></span><span style="display:flex;"><span>      state<span style="color:#0550ae">.[</span>key<span style="color:#0550ae">]</span> <span style="color:#0550ae">&lt;-</span> newValue
</span></span><span style="display:flex;"><span>      <span style="color:#0550ae">(</span>key<span style="color:#0550ae">,</span> newValue<span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">match</span> source <span style="color:#cf222e">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">|</span> Bounded bs <span style="color:#0550ae">-&gt;</span> bs <span style="color:#0550ae">&gt;&gt;</span> <span style="color:#24292e">Seq</span><span style="color:#1f2328">.</span>countBy getKey <span style="color:#0550ae">|&gt;</span> Bounded
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">|</span> Unbounded us <span style="color:#0550ae">-&gt;</span> <span style="color:#0550ae">(</span><span style="color:#cf222e">fun</span> s <span style="color:#0550ae">-&gt;</span> addItem <span style="color:#0550ae">&gt;&gt;</span> s<span style="color:#0550ae">)</span> <span style="color:#0550ae">&gt;&gt;</span> us <span style="color:#0550ae">|&gt;</span> Unbounded
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">let</span> <span style="color:#953800">private</span> stage source transform sink <span style="color:#6a737d">()</span> <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">match</span> transform source<span style="color:#0550ae">,</span> sink <span style="color:#cf222e">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">|</span> Bounded bs<span style="color:#0550ae">,</span> Action a <span style="color:#0550ae">-&gt;</span> bs<span style="color:#6a737d">()</span> <span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Seq</span><span style="color:#1f2328">.</span>iter a
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">|</span> Unbounded us<span style="color:#0550ae">,</span> Action a <span style="color:#0550ae">-&gt;</span> us a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">type</span> <span style="color:#1f2328">private</span> Flow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>a<span style="color:#0550ae">&gt;(</span>source<span style="color:#0550ae">:</span> Source<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>a<span style="color:#0550ae">&gt;,</span> connect<span style="color:#0550ae">:</span> Sink<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>a<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">-&gt;</span> Runnable<span style="color:#0550ae">)</span> <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">member</span> this<span style="color:#1f2328">.</span><span style="color:#6639ba">Apply</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">&gt;</span> t <span style="color:#0550ae">=</span> <span style="color:#cf222e">new</span> Flow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">&gt;(</span>t source<span style="color:#0550ae">,</span> stage source t<span style="color:#0550ae">)</span> <span style="color:#0550ae">:&gt;</span> IFlow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">interface</span> IFlow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>a<span style="color:#0550ae">&gt;</span> <span style="color:#cf222e">with</span>
</span></span><span style="display:flex;"><span>      <span style="color:#cf222e">member</span> this<span style="color:#1f2328">.</span><span style="color:#6639ba">Map</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">&gt;</span> map <span style="color:#0550ae">=</span> this<span style="color:#0550ae">.</span>Apply<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">(</span>mapTransform map<span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#cf222e">member</span> this<span style="color:#1f2328">.</span><span style="color:#6639ba">Collect</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">&gt;</span> map <span style="color:#0550ae">=</span> this<span style="color:#0550ae">.</span>Apply<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">(</span>collectTransform map<span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#cf222e">member</span> this<span style="color:#1f2328">.</span><span style="color:#6639ba">CountBy</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b <span style="color:#cf222e">when</span> <span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">:</span> equality<span style="color:#0550ae">&gt;(</span>getKey<span style="color:#0550ae">)</span> <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>        this<span style="color:#0550ae">.</span>Apply<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>b <span style="color:#0550ae">*</span> int<span style="color:#0550ae">&gt;</span> <span style="color:#0550ae">(</span>countByTransform<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>a<span style="color:#0550ae">,</span> <span style="color:#cf222e">&#39;</span>b<span style="color:#0550ae">&gt;</span> getKey<span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#cf222e">member</span> this<span style="color:#1f2328">.</span><span style="color:#6639ba">To</span><span style="color:#0550ae">(</span>sink<span style="color:#0550ae">)</span> <span style="color:#0550ae">=</span> connect<span style="color:#0550ae">(</span>sink<span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">let</span> <span style="color:#953800">from</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>a<span style="color:#0550ae">&gt;</span> source <span style="color:#0550ae">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">new</span> Flow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>a<span style="color:#0550ae">&gt;(</span>source<span style="color:#0550ae">,</span> stage source <span style="color:#0550ae">(</span>mapTransform id<span style="color:#0550ae">))</span> <span style="color:#0550ae">:&gt;</span> IFlow<span style="color:#0550ae">&lt;</span><span style="color:#cf222e">&#39;</span>a<span style="color:#0550ae">&gt;</span>
</span></span></code></pre></div><p>The implementation details are not that important at the moment (even though it&rsquo;s
just 37 lines of code), so I&rsquo;ll just proceed to the pipeline definition:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>unboundedSource                <span style="color:#57606a">// e.g. same console source as before
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Runner</span><span style="color:#1f2328">.</span>from                 <span style="color:#57606a">// create Runner implementation of IFlow
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Flow</span><span style="color:#1f2328">.</span>collect tokenize
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Flow</span><span style="color:#1f2328">.</span>countBy id
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Flow</span><span style="color:#1f2328">.</span>map print
</span></span><span style="display:flex;"><span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Flow</span><span style="color:#1f2328">.</span>connectTo consoleSink  <span style="color:#57606a">// connect to the Sink
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#0550ae">|&gt;</span> <span style="color:#24292e">Flow</span><span style="color:#1f2328">.</span>run                    <span style="color:#57606a">// start listening for events
</span></span></span></code></pre></div><p>Here you can find
<a href="https://github.com/mikhailshilkov/mikhailio-samples/blob/master/streamprocessing/GiftCount.fs">the full code of the Gift Count example</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this article, we started reasoning about low-latency processing
pipelines from the domain logic point of view. We
tried to reuse well known F# idioms like ADTs and HOFs
to show how stream processing is not much different from other types
of applications.</p>
<p>Although this post is quite long by now, we just scratched the surface
of the stream processing. Here are some focus areas for the
follow-ups:</p>
<ul>
<li>More complex pipeline topologies</li>
<li>State management</li>
<li>Concepts of time, windowing and out-of-order events</li>
<li>Reliability, retries and guarantees</li>
<li>Scaling out</li>
<li>Using 3rd parties for all of that</li>
<li>Documentation and formal analysis</li>
</ul>

                </div>

                
                <div class="after-post-tags">
                    <ul class="tags">
                        
                        <li>
                            
                            
                            <a href="/tags/stream-processing">Stream Processing</a>
                            
                        </li>
                        
                        <li>
                            
                            
                            <a href="/tags/fsharp">F#</a>
                            
                        </li>
                        
                        <li>
                            
                            
                            <a href="/tags/advent-calendar">Advent Calendar</a>
                            
                        </li>
                        
                        <li>
                            
                            
                            <a href="/tags/data-processing">Data Processing</a>
                            
                        </li>
                        
                    </ul>
                </div>
                

                <hr/>

            </div>
            
        </div>
    </div>
    
    <div class="container">
    <div id="sharepane" class="row justify-content-center">
        <div class="col-md-2">

        </div>
        <div class="contact-intro col-md-2 text-center">
            <img class="profile-small d-inline-block mx-auto rounded-circle mb-3" height="100px"
                src="/images/author.jpg" alt="">
        </div>
        <div class="col-md-8">
            <section class="article-open_author">
                <div class="article-open_author_bio">
                    <h5 itemprop="author" itemscope="" itemtype="http://schema.org/Person">Author: Mikhail Shilkov</h5>
                    <p>
                        <div>Cloud and AI developer and researcher.</div>
                    </p>
                </div>
            </section>
            <a href="https://x.com/MikhailShilkov?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @MikhailShilkov</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        </div>
    </div>
</div>
<div class="container">
    <div id="comments" class="row justify-content-center mb-5">
        <div class="col-md-8">
            
            
            
        </div>
    </div>
</div>
</div>

        </div>
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                &copy; Copyright Mikhail Shilkov - All rights reserved
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                
            </div>
        </div>
    </div>
</footer>


<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('code.language-diff span span').forEach(function(span) {
        const text = span.textContent;
        if (text.startsWith('-')) {
            span.style.backgroundColor = '#ffdddd';
            span.style.color = '#d73a49';
            span.style.display = 'block';
        } else if (text.startsWith('+')) {
            span.style.backgroundColor = '#ddffdd';
            span.style.color = '#28a745';
            span.style.display = 'block';
        }
    });
});
</script>











<script src="/js/bundle.min.js"></script>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-NL7F82LX48"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-NL7F82LX48');
        }
      </script>
    </body>
</html>
