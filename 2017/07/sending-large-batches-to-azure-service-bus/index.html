<!DOCTYPE html>
<html lang="en-us" prefix="og: http://ogp.me/ns#"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	
	<link rel="icon" type="image/png" href="/favicon.ico">
	
	
	<title>Sending Large Batches to Azure Service Bus | Mikhail Shilkov</title>
	
	
	
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
	
	<link rel="stylesheet" href="/sass/main.css">

	
	
	<meta property="og:title" content="Sending Large Batches to Azure Service Bus" />
	<meta property="og:description" content="Azure Service Bus client supports sending messages in batches. However, the size of a single batch must stay below 256k bytes, otherwise the whole batch will get rejected." />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="https://mikhail.io/2017/07/sending-large-batches-to-azure-service-bus/" />

	
	
	
	
	<meta property="og:image" content="https://mikhail.io/2017/07/sending-large-batches-to-azure-service-bus/teaser.png" />
	
	


	
	
	<meta property="article:tag" content="Azure" />
	
	<meta property="article:tag" content="Azure Service Bus" />
	

	
	
	<meta name="twitter:card" content="summary_large_image"/>
	
	<meta name="twitter:image" content="https://mikhail.io/2017/07/sending-large-batches-to-azure-service-bus/teaser.png" />
	
	

	<meta name="twitter:title" content="Sending Large Batches to Azure Service Bus"/>
	<meta name="twitter:description" content="Azure Service Bus client supports sending messages in batches. However, the size of a single batch must stay below 256k bytes, otherwise the whole batch will get rejected."/>
	<meta name="twitter:creator" content="@MikhailShilkov"></meta>
</head>
<body><script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load("current", {packages:["corechart"]});
    function addChart(make) {
        google.charts.setOnLoadCallback(drawChart);
        function drawChart() {
            const data = new google.visualization.DataTable();

            const options = {
                height: 420,  
                chartArea: { width: '85%', height: '70%' },
                legend: 'none',
                hAxis: { minValue: 0 },
                vAxis: {},
                series: {      
                    0: { tooltip : false}
                }
            };
            const chart = make(data, options);
            options.hAxis.textStyle = options.hAxis.titleTextStyle 
                = options.vAxis.textStyle = options.vAxis.titleTextStyle = { fontName: 'Merriweather' };

            chart.draw(data, options);
        }
    }
</script>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container pr-0">
        <a class="navbar-brand" href="/">
            <img class="author-thumb" src="/images/author.jpg" alt="Mikhail Shilkov">
            <span class="text-primary">Mikhail Shilkov</span>
        </a>

        
               


        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        
        <div class="collapse navbar-collapse" id="navbarMediumish">
            
            <ul class="navbar-nav ml-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">TOPICS</a>
                </li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/archives/">ARCHIVES</a>
                </li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/talks/">TALKS</a>
                </li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">ABOUT</a>
                </li>
                <li class="nav-item">
    <a class="nav-link" href="https://mikhail.io/feed/"><i class="fas fa-rss social-icon" aria-hidden="true"></i></a>
</li>

<li class="nav-item">
    <a class="nav-link" href="https://x.com/MikhailShilkov"><i class="fab fa-twitter social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://dev.to/mikhailshilkov"><i class="fab fa-dev social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://medium.com/@MikhailShilkov"><i class="fab fa-medium social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://github.com/MikhailShilkov"><i class="fab fa-github social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/MikhailShilkov"><i class="fab fa-linkedin social-icon" aria-hidden="true"></i></a>
</li>

</ul>
        </div>
        
    </div>
</nav>


        <div class="container">

<div class="main-content">
    
    <div class="container">
        <div class="row">
            
            <div class="col-lg-2 pl-0"><div class="share">
    <ul>
        <li class="ml-1 mr-1" title="Say 'Thank You' for this article">
            <a href="#" onclick="heart();return false;">
                <i class="fas fa-heart" style="color: red"></i>
            </a>
            <div class="count" style="float: right; padding-left: .5em; padding-top: .25em" id="heartcount"></div>
        </li>

        <li class="ml-1 mr-1" title="Tweet this article">
            <a target="_blank"
                href="https://x.com/intent/tweet?text=Sending%20Large%20Batches%20to%20Azure%20Service%20Bus%20by%20@MikhailShilkov&url=https%3a%2f%2fmikhail.io%2f2017%2f07%2fsending-large-batches-to-azure-service-bus%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=435');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1" title="See the responses or write a response">
            <a href="#comments">
                <i class="fas fa-comment"></i>
            </a>
        </li>
    </ul>
</div></div>
            
            <div class="col-lg-9 flex-first flex-lg-unordered">

                <div class="mainheading">
                    
                    <h1 class="posttitle">Sending Large Batches to Azure Service Bus</h1>
                    
                    <div class="post-top-meta">
                        <div>
                            
                                
                                <span class="post-date">Published on Jul 4, 2017
                                
                            
                            
                        &nbsp;&middot;&nbsp; 7 min read</span></span>
                        </div>
                    </div>
                </div>
                
                
                

                
                <div class="article-post">
                    <p>Azure Service Bus client supports sending messages in batches (<code>SendBatch</code>
and <code>SendBatchAsync</code> methods of <code>QueueClient</code> and <code>TopicClient</code>). However,
the size of a single batch must stay below 256k bytes, otherwise the whole
batch will get rejected.</p>
<p>How do we make sure that the batch-to-be-sent is going to fit? The rest
of this article will try to answer this seemingly simple question.</p>
<h2 id="problem-statement">Problem Statement</h2>
<p>Given a list of messages of arbitrary type <code>T</code>, we want to send them to Service
Bus in batches. The amount of batches should be close to minimal, but
obviously each one of them must satisfy the restriction of 256k max size.</p>
<p>So, we want to implement a method with the following signature:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#cf222e">public</span> Task SendBigBatchAsync<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;(</span>IEnumerable<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;</span> messages<span style="color:#1f2328">);</span>
</span></span></code></pre></div><p>which would work for collections of any size.</p>
<p>To limit the scope, I will restrict the article to the following assumptions:</p>
<ul>
<li>
<p>Each individual message is less than 256k serialized. If that wasn&rsquo;t true,
we&rsquo;d have to put the body into external blob storage first, and then send
the reference. It&rsquo;s not directly related to the topic of discussion.</p>
</li>
<li>
<p>I&rsquo;ll use <code>public BrokeredMessage(object serializableObject)</code> constructor.
Custom serialization could be used, but again, it&rsquo;s not related to batching,
so I&rsquo;ll ignore it.</p>
</li>
<li>
<p>We won&rsquo;t care about transactions, i.e. if connectivity dies in the middle
of sending the big batch, we might end up with partially sent batch.</p>
</li>
</ul>
<h2 id="messages-of-known-size">Messages of Known Size</h2>
<p>Let&rsquo;s start with a simple use case: the size of each message is known to us.
It&rsquo;s defined by hypothetical <code>Func&lt;T, long&gt; getSize</code> function. Here is a
helpful extension method that will split an arbitrary collection based on
a metric function and maximum chunk size:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#cf222e">public</span> <span style="color:#cf222e">static</span> List<span style="color:#1f2328">&lt;</span>List<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;&gt;</span> ChunkBy<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;(</span><span style="color:#cf222e">this</span> IEnumerable<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;</span> source<span style="color:#1f2328">,</span> Func<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">,</span> <span style="color:#cf222e">long</span><span style="color:#1f2328">&gt;</span> metric<span style="color:#1f2328">,</span> <span style="color:#cf222e">long</span> maxChunkSize<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> source
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">.</span>Aggregate<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">new</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                Sum <span style="color:#1f2328">=</span> <span style="color:#0550ae">0L</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                Current <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span>List<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;)</span><span style="color:#cf222e">null</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                Result <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> List<span style="color:#1f2328">&lt;</span>List<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;&gt;()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">},</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">(</span>agg<span style="color:#1f2328">,</span> item<span style="color:#1f2328">)</span> <span style="color:#1f2328">=&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">var</span> <span style="color:#cf222e">value</span> <span style="color:#1f2328">=</span> metric<span style="color:#1f2328">(</span>item<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>agg<span style="color:#1f2328">.</span>Current <span style="color:#1f2328">==</span> <span style="color:#cf222e">null</span> <span style="color:#1f2328">||</span> agg<span style="color:#1f2328">.</span>Sum <span style="color:#1f2328">+</span> <span style="color:#cf222e">value</span> <span style="color:#1f2328">&gt;</span> maxChunkSize<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">var</span> current <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> List<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;</span> <span style="color:#1f2328">{</span> item <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>                    agg<span style="color:#1f2328">.</span>Result<span style="color:#1f2328">.</span>Add<span style="color:#1f2328">(</span>current<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">return</span> <span style="color:#cf222e">new</span> <span style="color:#1f2328">{</span> Sum <span style="color:#1f2328">=</span> <span style="color:#cf222e">value</span><span style="color:#1f2328">,</span> Current <span style="color:#1f2328">=</span> current<span style="color:#1f2328">,</span> agg<span style="color:#1f2328">.</span>Result <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                agg<span style="color:#1f2328">.</span>Current<span style="color:#1f2328">.</span>Add<span style="color:#1f2328">(</span>item<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">return</span> <span style="color:#cf222e">new</span> <span style="color:#1f2328">{</span> Sum <span style="color:#1f2328">=</span> agg<span style="color:#1f2328">.</span>Sum <span style="color:#1f2328">+</span> <span style="color:#cf222e">value</span><span style="color:#1f2328">,</span> agg<span style="color:#1f2328">.</span>Current<span style="color:#1f2328">,</span> agg<span style="color:#1f2328">.</span>Result <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">.</span>Result<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>Now, the implementation of <code>SendBigBatchAsync</code> is simple:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#cf222e">public</span> <span style="color:#cf222e">async</span> Task SendBigBatchAsync<span style="color:#1f2328">(</span>IEnumerable<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;</span> messages<span style="color:#1f2328">,</span> Func<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">,</span> <span style="color:#cf222e">long</span><span style="color:#1f2328">&gt;</span> getSize<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> chunks <span style="color:#1f2328">=</span> messages<span style="color:#1f2328">.</span>ChunkBy<span style="color:#1f2328">(</span>getSize<span style="color:#1f2328">,</span> MaxServiceBusMessage<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">foreach</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">var</span> chunk <span style="color:#cf222e">in</span> chunks<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">var</span> brokeredMessages <span style="color:#1f2328">=</span> chunk<span style="color:#1f2328">.</span>Select<span style="color:#1f2328">(</span>m <span style="color:#1f2328">=&gt;</span> <span style="color:#cf222e">new</span> BrokeredMessage<span style="color:#1f2328">(</span>m<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">await</span> client<span style="color:#1f2328">.</span>SendBatchAsync<span style="color:#1f2328">(</span>brokeredMessages<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">private</span> <span style="color:#cf222e">const</span> <span style="color:#cf222e">long</span> MaxServiceBusMessage <span style="color:#1f2328">=</span> <span style="color:#0550ae">256000</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">private</span> <span style="color:#cf222e">readonly</span> QueueClient client<span style="color:#1f2328">;</span>
</span></span></code></pre></div><p>Note that I do <code>await</code> for each chunk sequentially to preserve message ordering.
Another thing to notice is that we lost all-or-nothing guarantee: we might
be able to send the first chunk, and then get an exception from subsequent
parts. Some sort of retry mechanism is probably needed.</p>
<h2 id="brokeredmessagesize">BrokeredMessage.Size</h2>
<p>OK, how do we determine the size of each message? How do we implement
<code>getSize</code> function?</p>
<p><code>BrokeredMessage</code> class exposes <code>Size</code> property, so it might be tempting to
rewrite our method the following way:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#cf222e">public</span> <span style="color:#cf222e">async</span> Task SendBigBatchAsync<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;(</span>IEnumerable<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;</span> messages<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> brokeredMessages <span style="color:#1f2328">=</span> messages<span style="color:#1f2328">.</span>Select<span style="color:#1f2328">(</span>m <span style="color:#1f2328">=&gt;</span> <span style="color:#cf222e">new</span> BrokeredMessage<span style="color:#1f2328">(</span>m<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">var</span> chunks <span style="color:#1f2328">=</span> brokeredMessages<span style="color:#1f2328">.</span>ChunkBy<span style="color:#1f2328">(</span>bm <span style="color:#1f2328">=&gt;</span> bm<span style="color:#1f2328">.</span>Size<span style="color:#1f2328">,</span> MaxServiceBusMessage<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">foreach</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">var</span> chunk <span style="color:#cf222e">in</span> chunks<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">await</span> client<span style="color:#1f2328">.</span>SendBatchAsync<span style="color:#1f2328">(</span>chunk<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>Unfortunately, this won&rsquo;t work properly. A quote from documentation:</p>
<blockquote>
<p>The value of Size is only accurate after the BrokeredMessage
instance is sent or received.</p></blockquote>
<p>My experiments show that <code>Size</code> of a draft message returns the size of
the message body, ignoring headers. If the message bodies are large, and
each chunk has just a handful of them, the code might work ok-ish.</p>
<p>But it will significantly underestimate the size of large batches of messages
with small payload.</p>
<p>So, for the rest of this article I&rsquo;ll try to adjust the calculation for headers.</p>
<h2 id="fixed-header-size">Fixed Header Size</h2>
<p>It could be that the header size of each message is always the same.
Quite often people will set the same headers for all their messages,
or set no custom headers at all.</p>
<p>In this case, you might just measure this size once, and then put this
fixed value inside a configuration file.</p>
<p>Here is how you measure the headers of a <code>BrokeredMessage</code> message:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#cf222e">var</span> sizeBefore <span style="color:#1f2328">=</span> message<span style="color:#1f2328">.</span>Size<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>client<span style="color:#1f2328">.</span>Send<span style="color:#1f2328">(</span>message<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> sizeAfter <span style="color:#1f2328">=</span> message<span style="color:#1f2328">.</span>Size<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">var</span> headerSize <span style="color:#1f2328">=</span> sizeAfter <span style="color:#1f2328">-</span> sizeBefore<span style="color:#1f2328">;</span>
</span></span></code></pre></div><p>Now you just need to adjust one line from the previous version of
<code>SendBigBatchAsync</code> method</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#cf222e">var</span> chunks <span style="color:#1f2328">=</span> brokeredMessages<span style="color:#1f2328">.</span>ChunkBy<span style="color:#1f2328">(</span>bm <span style="color:#1f2328">=&gt;</span> FixedHeaderSize <span style="color:#1f2328">+</span> bm<span style="color:#1f2328">.</span>Size<span style="color:#1f2328">,</span> MaxServiceBusMessage<span style="color:#1f2328">);</span>
</span></span></code></pre></div><p><code>FixedHeaderSize</code> might be simply hard-coded, or taken from configuration
per application.</p>
<h2 id="measuring-of-header-size-per-message">Measuring of Header Size per Message</h2>
<p>If the size of headers varies per message, you need a way to adjust batching
algorithm accordingly.</p>
<p>Unfortunately, I haven&rsquo;t found a straightforward way to accomplish that. It looks like
you&rsquo;d have to serialize the headers yourself, and then measure the size of
resulting binary. This is not a trivial operation to do correctly,
and also implies some performance penalty.</p>
<p>Sean Feldman <a href="https://weblogs.asp.net/sfeldman/asb-batching-brokered-messages">came up</a>
with a way to <em>estimate</em> the size of headers. That might be a good way to go,
though the estimation tends to err on the safe side for messages with small
payload.</p>
<h2 id="heuristics--retry">Heuristics &amp; Retry</h2>
<p>The last possibility that I want to consider is actually allow yourself
violating the max size of the batch, but then handle the exception, retry
the send operation and adjust future calculations based on actual measured size
of the failed messages. The size is known after trying to <code>SendBatch</code>, even if
operation failed, so we can use this information.</p>
<p>Here is a sketch of how to do that in code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#57606a">// Sender is reused across requests</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">public</span> <span style="color:#cf222e">class</span> <span style="color:#1f2328">BatchSender</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">private</span> <span style="color:#cf222e">readonly</span> QueueClient queueClient<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">private</span> <span style="color:#cf222e">long</span> batchSizeLimit <span style="color:#1f2328">=</span> <span style="color:#0550ae">262000</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">private</span> <span style="color:#cf222e">long</span> headerSizeEstimate <span style="color:#1f2328">=</span> <span style="color:#0550ae">54</span><span style="color:#1f2328">;</span> <span style="color:#57606a">// start with the smallest header possible</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">public</span> BatchSender<span style="color:#1f2328">(</span>QueueClient queueClient<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">this</span><span style="color:#1f2328">.</span>queueClient <span style="color:#1f2328">=</span> queueClient<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">public</span> <span style="color:#cf222e">async</span> Task SendBigBatchAsync<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;(</span>IEnumerable<span style="color:#1f2328">&lt;</span>T<span style="color:#1f2328">&gt;</span> messages<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">var</span> packets <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">from</span> m <span style="color:#cf222e">in</span> messages
</span></span><span style="display:flex;"><span>                     <span style="color:#cf222e">let</span> bm <span style="color:#1f2328">=</span> <span style="color:#cf222e">new</span> BrokeredMessage<span style="color:#1f2328">(</span>m<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#cf222e">select</span> <span style="color:#cf222e">new</span> <span style="color:#1f2328">{</span> Source <span style="color:#1f2328">=</span> m<span style="color:#1f2328">,</span> Brokered <span style="color:#1f2328">=</span> bm<span style="color:#1f2328">,</span> BodySize <span style="color:#1f2328">=</span> bm<span style="color:#1f2328">.</span>Size <span style="color:#1f2328">}).</span>ToList<span style="color:#1f2328">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">var</span> chunks <span style="color:#1f2328">=</span> packets<span style="color:#1f2328">.</span>ChunkBy<span style="color:#1f2328">(</span>p <span style="color:#1f2328">=&gt;</span> <span style="color:#cf222e">this</span><span style="color:#1f2328">.</span>headerSizeEstimate <span style="color:#1f2328">+</span> p<span style="color:#1f2328">.</span>Brokered<span style="color:#1f2328">.</span>Size<span style="color:#1f2328">,</span> <span style="color:#cf222e">this</span><span style="color:#1f2328">.</span>batchSizeLimit<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">foreach</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">var</span> chunk <span style="color:#cf222e">in</span> chunks<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">try</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">await</span> <span style="color:#cf222e">this</span><span style="color:#1f2328">.</span>queueClient<span style="color:#1f2328">.</span>SendBatchAsync<span style="color:#1f2328">(</span>chunk<span style="color:#1f2328">.</span>Select<span style="color:#1f2328">(</span>p <span style="color:#1f2328">=&gt;</span> p<span style="color:#1f2328">.</span>Brokered<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">catch</span> <span style="color:#1f2328">(</span>MessageSizeExceededException<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">var</span> maxHeader <span style="color:#1f2328">=</span> packets<span style="color:#1f2328">.</span>Max<span style="color:#1f2328">(</span>p <span style="color:#1f2328">=&gt;</span> p<span style="color:#1f2328">.</span>Brokered<span style="color:#1f2328">.</span>Size <span style="color:#1f2328">-</span> p<span style="color:#1f2328">.</span>BodySize<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>maxHeader <span style="color:#1f2328">&gt;</span> <span style="color:#cf222e">this</span><span style="color:#1f2328">.</span>headerSizeEstimate<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a">// If failed messages had bigger headers, remember this header size </span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a">// as max observed and use it in future calculations</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">this</span><span style="color:#1f2328">.</span>headerSizeEstimate <span style="color:#1f2328">=</span> maxHeader<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">else</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#57606a">// Reduce max batch size to 95% of current value</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#cf222e">this</span><span style="color:#1f2328">.</span>batchSizeLimit <span style="color:#1f2328">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">long</span><span style="color:#1f2328">)(</span><span style="color:#cf222e">this</span><span style="color:#1f2328">.</span>batchSizeLimit <span style="color:#1f2328">*</span> <span style="color:#1f2328">.</span><span style="color:#0550ae">95</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#57606a">// Re-send the failed chunk</span>
</span></span><span style="display:flex;"><span>                <span style="color:#cf222e">await</span> <span style="color:#cf222e">this</span><span style="color:#1f2328">.</span>SendBigBatchAsync<span style="color:#1f2328">(</span>packets<span style="color:#1f2328">.</span>Select<span style="color:#1f2328">(</span>p <span style="color:#1f2328">=&gt;</span> p<span style="color:#1f2328">.</span>Source<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>The code example is quite involved, here is what actually happens:</p>
<ol>
<li>
<p>Create a brokered message for each message object, but also save the
corresponding source message. This is critical to be able to re-send items:
there&rsquo;s no way to send the same <code>BrokeredMessage</code> instance twice.</p>
</li>
<li>
<p>Also save the body size of the brokered message. We&rsquo;ll use it for retry
calculation.</p>
</li>
<li>
<p>Start with some guess of header size estimate. I start with 54 bytes,
which seems to be the minimal header size possible.</p>
</li>
<li>
<p>Split the batch into chunks the same way we did before.</p>
</li>
<li>
<p>Try sending chunks one by one.</p>
</li>
<li>
<p>If send operation fails with <code>MessageSizeExceededException</code>, iterate
through failed items and find out the actual header size of the message.</p>
</li>
<li>
<p>If that actual size is bigger than our known estimate, increase the estimate
to the newly observed value. Retry sending the chunk (not the whole batch) with
this new setting.</p>
</li>
<li>
<p>If the header is small, but message size is still too big - reduce the
allowed total size of the chunk. Retry again.</p>
</li>
</ol>
<p>The combination of checks of steps 7 and 8 should make the mechanism reliable
and self-adopting to message header payloads.</p>
<p>Since we reuse the sender between send operations, the size parameters will
also converge quite quickly and no more retries will be needed. Thus the
performance overhead should be minimal.</p>
<h2 id="conclusion">Conclusion</h2>
<p>It seems like there is no &ldquo;one size fits all&rdquo; solution for this problem at
the moment. The best implementation might depend on your messaging
requirements.</p>
<p>But if you have the silver bullet solution, please leave a comment under
this post and answer <a href="https://stackoverflow.com/questions/44779707/split-batch-of-messages-to-be-sent-to-azure-service-bus">my StackOverflow question</a>!</p>
<p>Otherwise, let&rsquo;s hope that the new
<a href="https://github.com/azure/azure-service-bus-dotnet">.NET Standard-compatible Service Bus client</a>
will solve this issue for us. Track <a href="https://github.com/Azure/azure-service-bus-dotnet/issues/109">this github issue</a>
for status updates.</p>

                </div>

                
                <div class="after-post-tags">
                    <ul class="tags">
                        
                        <li>
                            
                            
                            <a href="/tags/azure">Azure</a>
                            
                        </li>
                        
                        <li>
                            
                            
                            <a href="/tags/azure-service-bus">Azure Service Bus</a>
                            
                        </li>
                        
                    </ul>
                </div>
                

                <hr/>

            </div>
            
        </div>
    </div>
    
    <div class="container">
    <div id="sharepane" class="row justify-content-center">
        <div class="col-md-2">

        </div>
        <div class="contact-intro col-md-2 text-center">
            <img class="profile-small d-inline-block mx-auto rounded-circle mb-3" height="100px"
                src="/images/author.jpg" alt="">
        </div>
        <div class="col-md-8">
            <section class="article-open_author">
                <div class="article-open_author_bio">
                    <h5 itemprop="author" itemscope="" itemtype="http://schema.org/Person">Author: Mikhail Shilkov</h5>
                    <p>
                        <div>Cloud and AI developer and researcher.</div><div>Principal engineer at Pulumi.</div>
                    </p>
                </div>
            </section>
            <a href="https://x.com/MikhailShilkov?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @MikhailShilkov</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        </div>
    </div>
</div>
<div class="container">
    <div id="comments" class="row justify-content-center mb-5">
        <div class="col-md-8">
            
            
            
        </div>
    </div>
</div>
</div>

        </div>
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                &copy; Copyright Mikhail Shilkov - All rights reserved
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                
            </div>
        </div>
    </div>
</footer>


<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('code.language-diff span span').forEach(function(span) {
        const text = span.textContent;
        if (text.startsWith('-')) {
            span.style.backgroundColor = '#ffdddd';
            span.style.color = '#d73a49';
            span.style.display = 'block';
        } else if (text.startsWith('+')) {
            span.style.backgroundColor = '#ddffdd';
            span.style.color = '#28a745';
            span.style.display = 'block';
        }
    });
});
</script>











<script src="/js/bundle.min.js"></script>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-NL7F82LX48"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-NL7F82LX48');
        }
      </script>
    </body>
</html>
