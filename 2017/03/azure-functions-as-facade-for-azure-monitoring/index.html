<!DOCTYPE html>
<html lang="en-us" prefix="og: http://ogp.me/ns#"><head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	
	<link rel="icon" type="image/png" href="/favicon.ico">
	
	
	<title>Azure Functions as a Facade for Azure Monitoring | Mikhail Shilkov</title>
	
	
	
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
	
	<link rel="stylesheet" href="/sass/main.css">

	
	
	<meta property="og:title" content="Azure Functions as a Facade for Azure Monitoring" />
	<meta property="og:description" content="Azure Functions are the Function-as-a-Service offering from Microsoft Azure cloud.
Basically, an Azure Function is a piece of code which gets executed by Azure
every time an event of some kind happens. The environment manages deployment,
event triggers and scaling for you. This approach is often reffered as
Serverless." />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="https://mikhail.io/2017/03/azure-functions-as-facade-for-azure-monitoring/" />

	
	
	
	
	<meta property="og:image" content="https://mikhail.io/2017/03/azure-functions-as-facade-for-azure-monitoring/teaser.png" />
	
	


	
	
	<meta property="article:tag" content="Azure" />
	
	<meta property="article:tag" content="Azure Functions" />
	
	<meta property="article:tag" content="Metrics" />
	
	<meta property="article:tag" content="Monitoring" />
	
	<meta property="article:tag" content="PRTG" />
	

	
	
	<meta name="twitter:card" content="summary_large_image"/>
	
	<meta name="twitter:image" content="https://mikhail.io/2017/03/azure-functions-as-facade-for-azure-monitoring/teaser.png" />
	
	

	<meta name="twitter:title" content="Azure Functions as a Facade for Azure Monitoring"/>
	<meta name="twitter:description" content="Azure Functions are the Function-as-a-Service offering from Microsoft Azure cloud.
Basically, an Azure Function is a piece of code which gets executed by Azure
every time an event of some kind happens. The environment manages deployment,
event triggers and scaling for you. This approach is often reffered as
Serverless."/>
	<meta name="twitter:creator" content="@MikhailShilkov"></meta>
</head>
<body><script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load("current", {packages:["corechart"]});
    function addChart(make) {
        google.charts.setOnLoadCallback(drawChart);
        function drawChart() {
            const data = new google.visualization.DataTable();

            const options = {
                height: 420,  
                chartArea: { width: '85%', height: '70%' },
                legend: 'none',
                hAxis: { minValue: 0 },
                vAxis: {},
                series: {      
                    0: { tooltip : false}
                }
            };
            const chart = make(data, options);
            options.hAxis.textStyle = options.hAxis.titleTextStyle 
                = options.vAxis.textStyle = options.vAxis.titleTextStyle = { fontName: 'Merriweather' };

            chart.draw(data, options);
        }
    }
</script>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container pr-0">
        <a class="navbar-brand" href="/">
            <img class="author-thumb" src="/images/author.jpg" alt="Mikhail Shilkov">
            <span class="text-primary">Mikhail Shilkov</span>
        </a>

        
               


        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        
        <div class="collapse navbar-collapse" id="navbarMediumish">
            
            <ul class="navbar-nav ml-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">TOPICS</a>
                </li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/archives/">ARCHIVES</a>
                </li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/talks/">TALKS</a>
                </li>
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">ABOUT</a>
                </li>
                <li class="nav-item">
    <a class="nav-link" href="https://mikhail.io/feed/"><i class="fas fa-rss social-icon" aria-hidden="true"></i></a>
</li>

<li class="nav-item">
    <a class="nav-link" href="https://x.com/MikhailShilkov"><i class="fab fa-twitter social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://dev.to/mikhailshilkov"><i class="fab fa-dev social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://medium.com/@MikhailShilkov"><i class="fab fa-medium social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://github.com/MikhailShilkov"><i class="fab fa-github social-icon" aria-hidden="true"></i></a>
</li>


<li class="nav-item">
    <a class="nav-link" href="https://www.linkedin.com/in/MikhailShilkov"><i class="fab fa-linkedin social-icon" aria-hidden="true"></i></a>
</li>

</ul>
        </div>
        
    </div>
</nav>


        <div class="container">

<div class="main-content">
    
    <div class="container">
        <div class="row">
            
            <div class="col-lg-2 pl-0"><div class="share">
    <ul>
        <li class="ml-1 mr-1" title="Say 'Thank You' for this article">
            <a href="#" onclick="heart();return false;">
                <i class="fas fa-heart" style="color: red"></i>
            </a>
            <div class="count" style="float: right; padding-left: .5em; padding-top: .25em" id="heartcount"></div>
        </li>

        <li class="ml-1 mr-1" title="Tweet this article">
            <a target="_blank"
                href="https://x.com/intent/tweet?text=Azure%20Functions%20as%20a%20Facade%20for%20Azure%20Monitoring%20by%20@MikhailShilkov&url=https%3a%2f%2fmikhail.io%2f2017%2f03%2fazure-functions-as-facade-for-azure-monitoring%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=435');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1" title="See the responses or write a response">
            <a href="#comments">
                <i class="fas fa-comment"></i>
            </a>
        </li>
    </ul>
</div></div>
            
            <div class="col-lg-9 flex-first flex-lg-unordered">

                <div class="mainheading">
                    
                    <h1 class="posttitle">Azure Functions as a Facade for Azure Monitoring</h1>
                    
                    <div class="post-top-meta">
                        <div>
                            
                                
                                <span class="post-date">Published on Mar 16, 2017
                                
                            
                            
                        &nbsp;&middot;&nbsp; 10 min read</span></span>
                        </div>
                    </div>
                </div>
                
                
                

                
                <div class="article-post">
                    <p>Azure Functions are the Function-as-a-Service offering from Microsoft Azure cloud.
Basically, an Azure Function is a piece of code which gets executed by Azure
every time an event of some kind happens. The environment manages deployment,
event triggers and scaling for you. This approach is often reffered as
Serverless.</p>
<p>In this post I will describe one use case for Azure Functions: we implemented
a number of functions as a proxy layer between our operations/monitoring
tool and Azure metric APIs.</p>
<h2 id="problem">Problem</h2>
<p>Automated monitoring and alerting are crucial in order to ensure 24x7 smooth
operations of our business-critical applications. We host applications both
on-premise and in Azure cloud, and we use a single set of tools for monitoring
across this hybrid environment.</p>
<p>Particularly, we use <a href="https://www.paessler.com/prtg">PRTG Network Monitor</a>
to collect all kinds of metrics about the health of our systems and produce
both real-time alerts and historic trends.</p>
<p>A unit of monitoring in PRTG is called &ldquo;sensor&rdquo;. Each sensor polls a specific
data source to retrieve the current value of a metric. The data source can
be a performance counter, a JSON value in HTTP response, a SQL query result
and so on.</p>
<p>The problem is that there is no PRTG sensor for Azure metrics out of the box.
It might be possible to implement a sensor with custom code, e.g. in PowerShell,
but it would be problematic in two ways (at least):</p>
<ol>
<li>The custom code sensors are cumbersome to develop and maintain.</li>
<li>We would have to put sensitive information like Azure API keys and
connection strings to PRTG.</li>
</ol>
<h2 id="solution-overview">Solution Overview</h2>
<p>To overcome these problems we introduced an intermediate layer, as shown
on the following picture:</p>
<p><img src="prtg-http-azure.png" alt="PRTG to HTTP to Azure"></p>
<p>We use PRTG <code>HTTP XML/REST</code> sensor type. This sensor polls a given HTTP endpoint,
parses the response as JSON and finds a predefined field. This field is then
used as the sensor value. It takes 30 seconds to setup such sensor in PRTG.</p>
<p>The HTTP endpoint is hosted inside Azure. It provides a facade for metric
data access. All the sensitive information needed to access Azure metrics
API is stored inside Azure configuration itself. The implementation knows
which Azure API to use to get a specific metric, and it hides those
complications from the client code.</p>
<h2 id="azure-functions">Azure Functions</h2>
<p>We chose Azure Functions as the technology to implement and host such HTTP
facade.</p>
<p>The functions are very easy to create or modify. They are deployed independently
from any other code, so we can update them at any cadence. And no need to
provision any kind of servers anywhere - Azure will run the code for us.</p>
<p>Here is how the whole setup works:</p>
<p><img src="prtg-azure-flow.png" alt="Retrieval of data from Azure to PRTG"></p>
<ol>
<li>
<p>Every X minutes (configured per sensor), PRTG makes an HTTP request
to a predefined URL. The request includes an Access Key as a query parameter
(the key is stored in sensor URL configuration). Each access key enables
access to just one endpoint and is easily revokable.</p>
</li>
<li>
<p>For each Metric type there is an Azure Function listening for
HTTP requests from PRTG. Azure authorizes requests that contain valid
access keys.</p>
</li>
<li>
<p>Based on query parameters of the request, Azure Function retrieves a proper
metric value from Azure management API. Depending on the metric type, this
is accomplished with Azure .NET SDK or by sending a raw HTTP request to
Azure REST API.</p>
</li>
<li>
<p>Azure Function parses the response from Azure API and converts it to
just the value which is requested by PRTG.</p>
</li>
<li>
<p>The function returns a simple JSON object as HTTP response body. PRTG
parses JSON, extracts the numeric value, and saves it into the sensor history.</p>
</li>
</ol>
<p>At the time of writing, we have 13 sensors served by 5 Azure Functions:</p>
<p><img src="prtg-azure-services.png" alt="Map of PRTG sensors to Functions to Azure services"></p>
<p>I describe several functions below.</p>
<h2 id="service-bus-queue-size">Service Bus Queue Size</h2>
<p>The easiest function to implement is the one which gets the amount of
messages in the backlog of a given Azure Service Bus queue. The
<code>function.json</code> file configures input and output HTTP bindings, including
two parameters to derive from the URL: <code>account</code> (namespace) and queue <code>name</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;bindings&#34;: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;authLevel&#34;: <span style="color:#a31515">&#34;function&#34;</span>,
</span></span><span style="display:flex;"><span>      &#34;name&#34;: <span style="color:#a31515">&#34;req&#34;</span>,
</span></span><span style="display:flex;"><span>      &#34;type&#34;: <span style="color:#a31515">&#34;httpTrigger&#34;</span>,
</span></span><span style="display:flex;"><span>      &#34;direction&#34;: <span style="color:#a31515">&#34;in&#34;</span>,
</span></span><span style="display:flex;"><span>      &#34;route&#34;: <span style="color:#a31515">&#34;Queue/{account}/{name}&#34;</span>
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      &#34;name&#34;: <span style="color:#a31515">&#34;$return&#34;</span>,
</span></span><span style="display:flex;"><span>      &#34;type&#34;: <span style="color:#a31515">&#34;http&#34;</span>,
</span></span><span style="display:flex;"><span>      &#34;direction&#34;: <span style="color:#a31515">&#34;out&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ],
</span></span><span style="display:flex;"><span>  &#34;disabled&#34;: <span style="color:#00f">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The C# implementation uses standard Service Bus API and a connection string
from App Service configuration to retrieve the required data. And then returns
a dynamic object, which will be converted to JSON by Function App runtime.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="">#</span>r <span style="color:#a31515">&#34;Microsoft.ServiceBus&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">using</span> System.Net;
</span></span><span style="display:flex;"><span><span style="color:#00f">using</span> Microsoft.ServiceBus;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#2b91af">object</span> Run(HttpRequestMessage req, <span style="color:#2b91af">string</span> account, <span style="color:#2b91af">string</span> name)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> connectionString = Environment.GetEnvironmentVariable(<span style="color:#a31515">&#34;sb-&#34;</span> + account);
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> nsmgr = NamespaceManager.CreateFromConnectionString(connectionString);
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> queue = nsmgr.GetQueue(name);
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> <span style="color:#00f">new</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        messageCount = queue.MessageCountDetails.ActiveMessageCount,
</span></span><span style="display:flex;"><span>        dlq = queue.MessageCountDetails.DeadLetterMessageCount
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And that is all the code required to start monitoring the queues!</p>
<h2 id="service-bus-queue-statistics">Service Bus Queue Statistics</h2>
<p>In addition to queue backlog and dead letter queue size, we wanted to see
some queue statistics like amount of incoming and outgoing messages per
period of time. The corresponding API exists, but it&rsquo;s not that straightforward,
so I described the whole approach in a separate post:
<a href="https://mikhail.io/2017/03/azure-service-bus-entity-metrics-dotnet-apis/">Azure Service Bus Entity Metrics .NET APIs</a>.</p>
<p>In my Azure Function I&rsquo;m using the NuGet package that I mentioned in the post.
This is accomplished by adding a <code>project.json</code> file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  &#34;frameworks&#34;: {
</span></span><span style="display:flex;"><span>    &#34;net46&#34;:{
</span></span><span style="display:flex;"><span>      &#34;dependencies&#34;: {
</span></span><span style="display:flex;"><span>        &#34;MikhailIo.ServiceBusEntityMetrics&#34;: <span style="color:#a31515">&#34;0.1.2&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <code>function.json</code> file is similar to the previous one, but with one added
parameter called <code>metric</code>. I won&rsquo;t repeat the whole file here.</p>
<p>The Function implementation loads a certificate from the store, calls
metric API and returns the last metric value available:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#00f">using</span> System.Linq;
</span></span><span style="display:flex;"><span><span style="color:#00f">using</span> System.Security.Cryptography.X509Certificates;
</span></span><span style="display:flex;"><span><span style="color:#00f">using</span> MikhailIo.ServiceBusEntityMetrics;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">static</span> DataPoint Run(HttpRequestMessage req, <span style="color:#2b91af">string</span> account, <span style="color:#2b91af">string</span> name, <span style="color:#2b91af">string</span> metric)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> subscription = Environment.GetEnvironmentVariable(<span style="color:#a31515">&#34;SubscriptionID&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> thumbprint = Environment.GetEnvironmentVariable(<span style="color:#a31515">&#34;WEBSITE_LOAD_CERTIFICATES&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    X509Store certStore = <span style="color:#00f">new</span> X509Store(StoreName.My, StoreLocation.CurrentUser);
</span></span><span style="display:flex;"><span>    certStore.Open(OpenFlags.ReadOnly);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    X509Certificate2Collection certCollection = certStore.Certificates.Find(
</span></span><span style="display:flex;"><span>        X509FindType.FindByThumbprint,
</span></span><span style="display:flex;"><span>        thumbprint,
</span></span><span style="display:flex;"><span>        <span style="color:#00f">false</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> client = <span style="color:#00f">new</span> QueueStatistics(certCollection[0], subscription, account, name);
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> metrics = client.GetMetricSince(metric, DateTime.UtcNow.AddMinutes(-30));
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> metrics.LastOrDefault();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Don&rsquo;t forget to set <code>WEBSITE_LOAD_CERTIFICATES</code> setting to your certificate
thumbprint, otherwise Function App won&rsquo;t load it.</p>
<h2 id="web-app-instance-count">Web App Instance Count</h2>
<p>We are using Azure Web Jobs to run background data processing, e.g. for all
queue message handlers. The jobs are hosted in Web Apps, and have auto-scaling
enabled. When the load on the system grows, Azure spins up additional
instances to increase the overall throughput.</p>
<p>So, the next metric to be monitored is the amount of Web App instances running.</p>
<p>There is a REST endpoint to retrieve this information, but this time
authentication and authorization are implemented with Active Directory. I
created a helper class to wrap the authentication logic:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">class</span> <span style="color:#2b91af">RestClient</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">async</span> Task&lt;T&gt; Query&lt;T&gt;(<span style="color:#2b91af">string</span> url)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2b91af">var</span> token = <span style="color:#00f">await</span> GetAuthorizationHeader();
</span></span><span style="display:flex;"><span>        <span style="color:#2b91af">var</span> client = <span style="color:#00f">new</span> HttpClient();
</span></span><span style="display:flex;"><span>        client.DefaultRequestHeaders.Authorization = <span style="color:#00f">new</span> AuthenticationHeaderValue(<span style="color:#a31515">&#34;Bearer&#34;</span>, token);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#2b91af">var</span> response = <span style="color:#00f">await</span> client.GetAsync(url);
</span></span><span style="display:flex;"><span>        <span style="color:#2b91af">var</span> content = <span style="color:#00f">await</span> response.Content.ReadAsStringAsync();
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> JsonConvert.DeserializeObject&lt;T&gt;(content);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">private</span> <span style="color:#00f">static</span> <span style="color:#00f">async</span> Task&lt;<span style="color:#2b91af">string</span>&gt; GetAuthorizationHeader()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#2b91af">var</span> activeDirectoryID = Environment.GetEnvironmentVariable(<span style="color:#a31515">&#34;ActiveDirectoryID&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#2b91af">var</span> applicationID = Environment.GetEnvironmentVariable(<span style="color:#a31515">&#34;ActiveDirectoryApplicationID&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#2b91af">var</span> secret = Environment.GetEnvironmentVariable(<span style="color:#a31515">&#34;ActiveDirectorySecret&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#2b91af">var</span> context = <span style="color:#00f">new</span> AuthenticationContext(<span style="color:#a31515">$&#34;https://login.windows.net/{activeDirectoryID}&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#2b91af">var</span> credential = <span style="color:#00f">new</span> ClientCredential(applicationID, secret);
</span></span><span style="display:flex;"><span>        AuthenticationResult result =
</span></span><span style="display:flex;"><span>            <span style="color:#00f">await</span> context.AcquireTokenAsync(<span style="color:#a31515">&#34;https://management.core.windows.net/&#34;</span>, credential);
</span></span><span style="display:flex;"><span>        <span style="color:#00f">return</span> result.AccessToken;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The function then uses this REST client to query Web App management API,
converts JSON to strongly typed C# objects and extracts the amount of
instances into HTTP response:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">class</span> <span style="color:#2b91af">Instance</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#2b91af">string</span> id { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#2b91af">string</span> name { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">class</span> <span style="color:#2b91af">Response</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> Instance[] <span style="color:#00f">value</span> { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">async</span> Task&lt;HttpResponseMessage&gt; Run(HttpRequestMessage req)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> subscription = Environment.GetEnvironmentVariable(<span style="color:#a31515">&#34;SubscriptionID&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> resourceGroup = Environment.GetEnvironmentVariable(<span style="color:#a31515">&#34;ResourceGroup&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> appService = Environment.GetEnvironmentVariable(<span style="color:#a31515">&#34;AppService&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> url = <span style="color:#a31515">$&#34;https://management.azure.com/subscriptions/{subscription}/resourceGroups/{resourceGroup}&#34;</span> +
</span></span><span style="display:flex;"><span>              <span style="color:#a31515">$&#34;/providers/Microsoft.Web/sites/{appService}/instances?api-version=2015-08-01&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> response = <span style="color:#00f">await</span> RestClient.Query&lt;Response&gt;(url);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> req.CreateResponse(HttpStatusCode.OK, <span style="color:#00f">new</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        instanceCount = response.<span style="color:#00f">value</span>.Length
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Please follow <a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-create-service-principal-portal#create-an-active-directory-application">this walkthrough</a>
to setup your application in Active Directory, assign required permissions and
get the proper keys.</p>
<h2 id="azure-health">Azure Health</h2>
<p>Azure has a service which reports the health of different services at any
given moment, as acknowledged by Microsoft.</p>
<p>The handy part is that you can provide your subscription ID and then only
services used by that subscription will be reported.</p>
<p>The exact usage of health service may depend on your use case, but the
following example shows how to retrieve the basic counts of services per
reported status.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">class</span> <span style="color:#2b91af">ResourceProperties</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#2b91af">string</span> availabilityState { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#2b91af">string</span> summary { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#2b91af">string</span> detailedStatus { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#2b91af">string</span> reasonType { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#2b91af">string</span> occuredTime { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#2b91af">string</span> reasonChronicity { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#2b91af">string</span> reportedTime { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">class</span> <span style="color:#2b91af">Resource</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#2b91af">string</span> id { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> ResourceProperties properties { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">class</span> <span style="color:#2b91af">Response</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> Resource[] <span style="color:#00f">value</span> { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">async</span> Task&lt;HttpResponseMessage&gt; Run(HttpRequestMessage req)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> subscription = Environment.GetEnvironmentVariable(<span style="color:#a31515">&#34;SubscriptionID&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> url = <span style="color:#a31515">$&#34;https://management.azure.com/subscriptions/{subscription}/providers/Microsoft.ResourceHealth/availabilityStatuses?api-version=2015-01-01&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> r = <span style="color:#00f">await</span> RestClient.Query&lt;Response&gt;(url);
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> available = r.<span style="color:#00f">value</span>
</span></span><span style="display:flex;"><span>        .Where(v =&gt; v.properties.availabilityState == <span style="color:#a31515">&#34;Available&#34;</span>)
</span></span><span style="display:flex;"><span>        .Count();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> unknown = r.<span style="color:#00f">value</span>
</span></span><span style="display:flex;"><span>        .Where(v =&gt; v.properties.availabilityState == <span style="color:#a31515">&#34;Unknown&#34;</span>)
</span></span><span style="display:flex;"><span>        .Count();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> other = r.<span style="color:#00f">value</span>.Length - available - unknown;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> req.CreateResponse(HttpStatusCode.OK, <span style="color:#00f">new</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        available = available,
</span></span><span style="display:flex;"><span>        unknown = unknown,
</span></span><span style="display:flex;"><span>        other = other,
</span></span><span style="display:flex;"><span>        details = r.<span style="color:#00f">value</span>
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="users-online">Users Online</h2>
<p>The last example I want to share is related to Application Insights data.
For instance, we inject a small tracking snippet on our front-end page
and then Application Insights track all the page views and other user
activity.</p>
<p>We use the amount of users currently online as another metric for the
monitoring solution. The Application Insights API is currently in
preview, but at least it is nicely described at
<a href="https://dev.applicationinsights.io/">dev.applicationinsights.io</a>. Be sure
to check out <a href="https://dev.applicationinsights.io/apiexplorer/metrics">API Explorer</a> too.</p>
<p>The following sample function returns the amount of users online:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">class</span> <span style="color:#2b91af">UsersCount</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> <span style="color:#2b91af">long</span> unique { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">class</span> <span style="color:#2b91af">Value</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    [JsonProperty(&#34;users/count&#34;)]
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> UsersCount UsersCount { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">class</span> <span style="color:#2b91af">Response</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#00f">public</span> Value <span style="color:#00f">value</span> { <span style="color:#00f">get</span>; <span style="color:#00f">set</span>; }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00f">public</span> <span style="color:#00f">static</span> <span style="color:#00f">async</span> Task&lt;HttpResponseMessage&gt; Run(HttpRequestMessage req)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> appID = Environment.GetEnvironmentVariable(<span style="color:#a31515">&#34;ApplicationInsightsID&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> key = Environment.GetEnvironmentVariable(<span style="color:#a31515">&#34;ApplicationInsightsKey&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> client = <span style="color:#00f">new</span> HttpClient();
</span></span><span style="display:flex;"><span>    client.DefaultRequestHeaders.Add(<span style="color:#a31515">&#34;x-api-key&#34;</span>, key);
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> url = <span style="color:#a31515">$&#34;https://api.applicationinsights.io/beta/apps/{appID}/metrics/users/count&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> response = <span style="color:#00f">await</span> client.GetAsync(url);
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> content = <span style="color:#00f">await</span> response.Content.ReadAsStringAsync();
</span></span><span style="display:flex;"><span>    <span style="color:#2b91af">var</span> r = JsonConvert.DeserializeObject&lt;Response&gt;(content);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00f">return</span> req.CreateResponse(HttpStatusCode.OK, <span style="color:#00f">new</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        usersCount = r.<span style="color:#00f">value</span>.UsersCount.unique
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="combine-several-metrics-in-one-sensor">Combine Several Metrics in One Sensor</h2>
<p>Thanks to suggestion from Luciano Lingnau, we have migrated our PRTG
sensors to <code>HTTP Data Advanced</code>. This sensor type allows bundling several
related metrics into one sensor with multiple channels. PRTG is then
able to display all those channels on the single chart.</p>
<p>For instance, we use the following channels for Service Bus related
sensors:</p>
<ul>
<li>Active message count</li>
<li>Age of the oldest message sitting inside the queue</li>
<li>Dead letter message count</li>
<li>Incoming messages per 5 minutes</li>
<li>Outgoing messages per 5 minutes</li>
<li>Scheduled message count</li>
</ul>
<p>For each channel, we define units of measure, warning and error thresholds.</p>
<p><code>HTTP Data Advanced</code> expects a URL which returns JSON of the predefined format.
Here is a sample C# code to create a <code>dynamic</code> object which is then converted
to the proper JSON:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#00f">return</span> <span style="color:#00f">new</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    prtg = <span style="color:#00f">new</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        result = <span style="color:#00f">new</span>[]
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#00f">new</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                channel = <span style="color:#a31515">&#34;ActiveMessageCount&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#00f">value</span> = messageCountDetails.ActiveMessageCount,
</span></span><span style="display:flex;"><span>                unit = <span style="color:#a31515">&#34;Count&#34;</span>,
</span></span><span style="display:flex;"><span>                customunit = (<span style="color:#2b91af">string</span>)<span style="color:#00f">null</span>,
</span></span><span style="display:flex;"><span>                limitmaxwarning = (<span style="color:#2b91af">int?</span>)<span style="color:#00f">null</span>,
</span></span><span style="display:flex;"><span>                limitmode = 0
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#00f">new</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                channel = <span style="color:#a31515">&#34;DeadLetterMessageCount&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#00f">value</span> = messageCountDetails.DeadLetterMessageCount,
</span></span><span style="display:flex;"><span>                unit = <span style="color:#a31515">&#34;Count&#34;</span>,
</span></span><span style="display:flex;"><span>                customunit = (<span style="color:#2b91af">string</span>)<span style="color:#00f">null</span>,
</span></span><span style="display:flex;"><span>                limitmaxwarning = (<span style="color:#2b91af">int?</span>)0,
</span></span><span style="display:flex;"><span>                limitmode = 1
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#00f">new</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                channel = <span style="color:#a31515">&#34;OutgoingMessageCount&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#00f">value</span> = outgoing,
</span></span><span style="display:flex;"><span>                unit = <span style="color:#a31515">&#34;custom&#34;</span>,
</span></span><span style="display:flex;"><span>                customunit = <span style="color:#a31515">&#34;#/5min&#34;</span>,
</span></span><span style="display:flex;"><span>                limitmaxwarning = (<span style="color:#2b91af">int?</span>)<span style="color:#00f">null</span>,
</span></span><span style="display:flex;"><span>                limitmode = 0
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#00f">new</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                channel = <span style="color:#a31515">&#34;IncommingMessageCount&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#00f">value</span> = incoming,
</span></span><span style="display:flex;"><span>                unit = <span style="color:#a31515">&#34;custom&#34;</span>,
</span></span><span style="display:flex;"><span>                customunit = <span style="color:#a31515">&#34;#/5min&#34;</span>,
</span></span><span style="display:flex;"><span>                limitmaxwarning = (<span style="color:#2b91af">int?</span>)<span style="color:#00f">null</span>,
</span></span><span style="display:flex;"><span>                limitmode = 0
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#00f">new</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                channel = <span style="color:#a31515">&#34;ScheduledMessageCount&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#00f">value</span> = messageCountDetails.ScheduledMessageCount,
</span></span><span style="display:flex;"><span>                unit = <span style="color:#a31515">&#34;Count&#34;</span>,
</span></span><span style="display:flex;"><span>                customunit = (<span style="color:#2b91af">string</span>)<span style="color:#00f">null</span>,
</span></span><span style="display:flex;"><span>                limitmaxwarning = (<span style="color:#2b91af">int?</span>)<span style="color:#00f">null</span>,
</span></span><span style="display:flex;"><span>                limitmode = 0
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            <span style="color:#00f">new</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                channel = <span style="color:#a31515">&#34;Age&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#00f">value</span> = age,
</span></span><span style="display:flex;"><span>                unit = <span style="color:#a31515">&#34;TimeSeconds&#34;</span>,
</span></span><span style="display:flex;"><span>                customunit = (<span style="color:#2b91af">string</span>)<span style="color:#00f">null</span>,
</span></span><span style="display:flex;"><span>                limitmaxwarning = (<span style="color:#2b91af">int?</span>)<span style="color:#00f">null</span>,
</span></span><span style="display:flex;"><span>                limitmode = 0
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>It seems that monitoring metrics retrieval is an ideal scenario to start
using Azure Functions. The Functions are very easy to create and modify,
they abstract away the details of hosting Web API endpoints, and at the same
time give you the full power of C# (or F#) and Azure.</p>
<p>And because we only call those functions about 1 time per minute,
they are free to run!</p>

                </div>

                
                <div class="after-post-tags">
                    <ul class="tags">
                        
                        <li>
                            
                            
                            <a href="/tags/azure">Azure</a>
                            
                        </li>
                        
                        <li>
                            
                            
                            <a href="/tags/azure-functions">Azure Functions</a>
                            
                        </li>
                        
                        <li>
                            
                            
                            <a href="/tags/metrics">Metrics</a>
                            
                        </li>
                        
                        <li>
                            
                            
                            <a href="/tags/monitoring">Monitoring</a>
                            
                        </li>
                        
                        <li>
                            
                            
                            <a href="/tags/prtg">PRTG</a>
                            
                        </li>
                        
                    </ul>
                </div>
                

                <hr/>

            </div>
            
        </div>
    </div>
    
    <div class="container">
    <div id="sharepane" class="row justify-content-center">
        <div class="col-md-2">

        </div>
        <div class="contact-intro col-md-2 text-center">
            <img class="profile-small d-inline-block mx-auto rounded-circle mb-3" height="100px"
                src="/images/author.jpg" alt="">
        </div>
        <div class="col-md-8">
            <section class="article-open_author">
                <div class="article-open_author_bio">
                    <h5 itemprop="author" itemscope="" itemtype="http://schema.org/Person">Author: Mikhail Shilkov</h5>
                    <p>
                        <div>Cloud and AI developer and researcher.</div><div>Principal engineer at Pulumi.</div>
                    </p>
                </div>
            </section>
            <a href="https://x.com/MikhailShilkov?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @MikhailShilkov</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
        </div>
    </div>
</div>
<div class="container">
    <div id="comments" class="row justify-content-center mb-5">
        <div class="col-md-8">
            
            <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mikhailio" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            
        </div>
    </div>
</div>
</div>

        </div>
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                &copy; Copyright Mikhail Shilkov - All rights reserved
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                
            </div>
        </div>
    </div>
</footer>











<script src="/js/bundle.min.js"></script>
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-NL7F82LX48"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-NL7F82LX48');
        }
      </script>
    </body>
</html>
